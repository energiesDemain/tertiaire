---
output:
  pdf_document: 
    fig_caption: yes
    keep_tex: yes
  word_document:
    fig_height: 6
    fig_width: 8
---

```{r, echo=F, message=F, warning=F, cache=F, results=F}
require(knitr)
require(data.table)
require(ggplot2)
require(Hmisc)
require(reshape2)
require(plyr)
require(ggthemes)
require(texreg)
if (Sys.getenv("JAVA_HOME")!="")
  Sys.setenv(JAVA_HOME="")
options(java.parameters = "-Xmx8192m")
require(XLConnect)
require(RColorBrewer)
# set pander table-layout options
library(pander)
panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)

colorpalette = "Spectral"
fillpalette = "Spectral"

#colorpalette = "Set2"
#fillpalette = "Set2"
```


```{r, echo=F, message=F, warning=F, cache=T, results=F, comment = F, include = F, cache.rebuild = F}

##### prix des energies ####
prix_energie = fread("../AME_AMS_dataDGEC/parametrage modele/Prix_scenario_AME_BV_01_2017.csv", dec = ",")

prix_energie = melt(prix_energie,id.vars = "annee")

prix_energie[variable == "prix_elec", energie := "Electricité"]
prix_energie[variable == "prix_gaz", energie := "Gaz"]
prix_energie[variable == "prix_fioul", energie := "Fioul"]
prix_energie[variable == "prix_urbain", energie := "Urbain"]
prix_energie[variable == "prix_autres", energie := "Autres"]
prix_energie[variable == "CCE", energie := "CCE"]

prix_energie =dcast.data.table(prix_energie, annee~energie)
```

```{r, echo=F, message=FALSE, warning=F, cache=T, results=F, cache.rebuild = F}
source("analyse_param_utilisateurs.R",encoding = "ISO8859-1")

colors_syst= 
  data.table(SYSTEME_CHAUD =factor(unique(COD_SYSTEME_CHAUD$SYSTEME_CHAUD), 
                                   levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  "Autre système centralisé performant",
                                                           "nr","NA"))
                         )

colors_syst = colors_syst[order(SYSTEME_CHAUD)]
colors_syst[,color := c("dodgerblue1","dodgerblue4", "blue1","blue4","springgreen1","springgreen4",
                "yellow1","yellow4","gold1","gold4","chocolate1","chocolate4","coral1","coral3",
                "salmon1","salmon4","red1","red4","gray86","gray86")]

```

```{r, echo=F, message=FALSE, warning=F, cache=T, results=F, cache.rebuild = F,include = F}
#### liste des fichiers à lire

wbfiles =  
"../tertiaire/model/Result_Excel/table_resultat_AME2016Briand.xls"

#wbfiles[2] =
#"../tertiaire_to_export/resultats_AME_run1/2050_allpol_CEE/table_resultat_2050_newcalib_allpol_CEE.xlsx"

#wbfiles[3] =  
#"../tertiaire_to_export/resultats_AME_run2/2050_allpol_CEE_CC/table_resultat_2050_allpol_CEE_CC.xlsx"

#wbfiles[4] =  
#"../tertiaire/model/Result_Excel/parametrage_octobre/table_resultat_2015_allpol_sansCEE.xlsx"

#{wbfiles[5] =  
#"../tertiaire/model/Result_Excel/parametrage_octobre/table_resultat_2013_allpol_sansCEE_calbranche.xlsx"

wbfiles[2] = "../tertiaire/model/Result_csv/2013_allpol_sansCEE_sanscal"
wbfiles[3] = "../tertiaire/model/Result_csv/2013_allpol_sansCEE_calbranche"
wbfiles[4] = "../tertiaire/model/Result_csv/2013_allpol_sansCEE_calbranche_calparcener"
wbfiles[5] = "../tertiaire/model/Result_csv/2013_allpol_sansCEE_calbranche_calparcener_calconso"
wbfiles[6] = "../tertiaire/model/Result_csv/2050_allpol_CEE_CC"



# wbfiles[6] =  
# "../tertiaire/model/Result_Excel/parametrage_octobre/table_resultat_2015_allpol_sansCEE_calbranche_calener.xlsx"

#wbfiles[7] =  
#"../tertiaire/model/Result_Excel/parametrage_octobre/table_resultat_2015_allpol_sansCEE_calparcener_calconsoener.xlsx"

#wbfiles[8] =  
#"../tertiaire/model/Result_Excel/parametrage_octobre/table_resultat_2015_allpol_sansCEE_calparcener_calconsoener2.xlsx"

# wbfiles[7] =  
# "../tertiaire/model/Result_Excel/parametrage_octobre/table_resultat_2030_allpol_sansCEE.xlsx"
# 


#wbfiles[10] =  
#"../tertiaire/model/Result_Excel/parametrage_octobre/table_resultat_2021_allpol_avecCEE_CC.xlsx"



#### noms des scenarios ###
wbname = c("S1 : AME 2016",
 #           "S2 : AME 2017 run1",
 #          "S3 : AME 2017 run2",
           "S4 : AME 2017 run2 sans cal",
           "S5 : AME 2017 run2 cal branche"
           ,"S6 : AME 2017 run2 cal branche + ener"
           ,"S7 : AME 2017 run2 cal conso"
            ,"S8  :AME 2017 run2 all pol avec CEE et CC"
 #         "S8 : AME 2017 run2 all pol avec CEE et CC" 
 #          "S8b : AME 2017 run2 all pol avec CEE et CC"
           #"S9 : AME 2017 run2 all pol CEE"
           
#           ,"S5 : AME 2017 all pol sans CEE bis", "S6 : AME 2017 all pol sans CEE ter"

#           "S2 : décret 60p", "S3 : décret 80p","S4 : décret 80p 400 euros"
#          ,"S4 : AMS2 CCE forte + elast" 
#         ,"S5 : AMS3 CCE tres forte"
)

#### choix du scenario de référence 
scenario_ref = c("S1 : AME 2016")
scenario_ref = c("S7 : AME 2017 run2 cal conso")
scenario_toexport = c("S7 : AME 2017 run2 cal conso")
wbdir_scenario_toexport = c("../R/sorties_AME/")
#wbdir_scenario_besoins = c("../tertiaire_to_export/resultats_AME_run1/2050_allpol_CEE/")


scenarioshortnames = substring(wbname,1,2)
scenarios_taxeelec = ""

##### émissions de référence en MTCO2 
Em_ref_2012_tous_usages = 33.5
Em_ref_2012_chauffage = 23.6

Em_ref_1990_tous_usages = 28.8
Em_ref_1990_chauffage =  Em_ref_2012_chauffage/Em_ref_2012_tous_usages*Em_ref_1990_tous_usages 


#source("read_resultats_xlsx.R")
source("read_resultats_csv.R")
##### Conso de référence en tWh 
Conso_ref_2012_chauffage = Conso[usage=="Chauffage" & annee == "2012" & scenario==scenario_ref, sum(value)/10^9]
Conso_ref_2012_tous_usages = Conso[ annee == "2012" & scenario==scenario_ref, sum(value)/10^9]


```

# PARAMETRAGE PARC

\clearpage
\newpage 

\section{1) Evolution du parc (Surfaces)}

```{r,echo=F, warning=F,include = F}

datatmp = parc_melted[,list(value = sum(Surface)), by=c("scenario","annee", "Type_parc")]
datatmp [,Type_parc  := factor(Type_parc, levels = c("N","E"))]
datatmp = datatmp[, list(cumsurf = cumsum(value),Type_parc), by=c("annee","scenario") ]

``` 

## Ensemble du Parc

```{r Evol_parc , fig.width=25, fig.height=9, echo=F, warning=F,fig.cap='Evolution du parc', dev=c('png', 'pdf')}

ggplot(datatmp) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = cumsurf/10^6, group =Type_parc, fill = Type_parc)) + 
    ylab("Millions de m²") + facet_wrap(~scenario) +
  mytheme_facet_plot + scale_fill_brewer(palette = fillpalette) +  
  scale_x_discrete(breaks = seq(2010,2050,10), labels =
                    seq(2010,2050,10)) 
  
```

```{r,echo=F, warning=F,include = F}

datatmp = parc_melted[,list(value = sum(Surface)), by=c("scenario","annee", "Type_parc","branche")]
datatmp [,Type_parc  := factor(Type_parc, levels = c("N","E"))]
datatmp = datatmp[, list(cumsurf = cumsum(value),surface = value,Type_parc), by=c("annee","scenario","branche") ]
#datatmp [,scenario  := factor(scenario, levels = rev(levels(scenario) ))]
#datatmp [,Type_parc  := factor(Type_parc, levels = c("E","N"))]

parc_par_branche = merge(datatmp, COD_BRANCHE[, list(branche = COD_BRANCHE, BRANCHE)],by="branche")


datatmp = parc_melted[,list(value = sum(Surface)), by=c("scenario","annee", "energieChauffage")]
datatmp = datatmp[, list(cumsurf = cumsum(value),surface = value), by=c("annee","scenario","energieChauffage") ]
#datatmp [,scenario  := factor(scenario, levels = rev(levels(scenario) ))]
#datatmp [,Type_parc  := factor(Type_parc, levels = c("E","N"))]

parc_par_ener = merge(datatmp, COD_ENERGIE[, list(energieChauffage = COD_ENERGIE, ENERGIE)],by="energieChauffage")

``` 

```{r,echo=F, warning=F,include = F}
# tableau evolution parc avant 2010 et après 2010 et total 
anneeDGEC = seq(2010,2050,5)
parc_melted[Type_parc == "E", periodeconsDGEC := "Parc < 2009"]
parc_melted[Type_parc == "N", periodeconsDGEC := "Parc > 2009"]

TabparcDGEC = parc_melted[,list(value = sum(Surface)/10^6), by=c("scenario", "periodeconsDGEC","annee")]

TabparcDGEC = rbind(TabparcDGEC,parc_melted[,list(periodeconsDGEC = "Total" ,value = sum(Surface)/10^6), by=c("scenario","annee")])

parc_toutesannees = TabparcDGEC 

TabparcDGEC = TabparcDGEC[annee %in% anneeDGEC,]
TabparcDGEC = dcast.data.table(TabparcDGEC,scenario+periodeconsDGEC ~annee)
TabparcDGEC[,scenario := substring(scenario, 1,2)]
``` 


```{r, echo=F, warning=F,}
pander(TabparcDGEC  , digits = 2, caption = "Evolution du parc (surfaces en millions de m²)")
```

<!-- ```{r Evol_parc_branche, fig.width=25, fig.height=9, echo=F, warning=F,fig.cap='Evolution du parc par branche', dev=c('png', 'pdf')} -->

<!-- ggplot(parc_par_branche ) +  -->
<!--   geom_ribbon(aes(ymin = 0, annee, ymax = cumsurf/10^6, group =Type_parc, fill = Type_parc)) +  -->
<!--     ylab("Millions de m²") + facet_wrap(~scenario) + -->
<!--   mytheme_facet_plot + scale_fill_brewer(palette = fillpalette) +   -->
<!--    scale_x_discrete(breaks = seq(2010,2050,10), labels = -->
<!--                     seq(2010,2050,10))  + facet_wrap(~ BRANCHE+scenario)  -->

<!-- ``` -->

```{r,echo=F, warning=F,include = F}
#### vérification calage parc avec CEREN
wbCEREN <- loadWorkbook("../AME_AMS_dataDGEC/parametrage modele/Publication_donnees_CEREN_2015.xlsx", create = F)

parc_CEREN =data.table(readWorksheet(wbCEREN, sheet = "Tab_TERTIAIRE",startRow = 3,endRow = 12,header = T))

annee_CEREN = c("2010","2012","2013")
comp_parc_par_branche = dcast.data.table(parc_par_branche[annee %in% annee_CEREN  ],scenario + branche ~ annee, value.var = "surface",fun.aggregate = function(x){sum(x)/10^6})
comp_parc_par_branche = merge(comp_parc_par_branche,COD_BRANCHE[, list(branche = COD_BRANCHE, BRANCHE)],by="branche")

comp_parc_par_branche =melt(comp_parc_par_branche,id.vars = c("branche","scenario","BRANCHE"), variable.name = "an",
                            value.name = "Surf")

setnames(parc_CEREN,c("BRANCHE","1990","2000","2005","2010","2012","2013"))
parc_CEREN[,branche :=c("01","02","03","04","05","06","07","08","Total")]

parc_CEREN[, scenario:= "CEREN"]

parc_CEREN = melt(parc_CEREN, id.vars = c("BRANCHE","branche","scenario"), variable.name = "an", value.name = "Surf")

comp_parc_par_branche = rbind(comp_parc_par_branche,parc_CEREN)

## calage parc CEREN 2010 par branche
calage_parc_2010 = comp_parc_par_branche[an == "2010"]
calage_parc_2010 =dcast.data.table(calage_parc_2010,an+ branche~scenario)

calage_parc_2010[, calage := calage_parc_2010[,3]/calage_parc_2010[,5]]
calage_parc_2010[, calage2 := calage_parc_2010[,3]/calage_parc_2010[,6]]
#calage_parc_2010[, calage3 := calage_parc_2010[,3]/calage_parc_2010[,6]]


#### vérification calage parc avec CEREN par ener

wbCEREN <- loadWorkbook("../AME_AMS_dataDGEC/parametrage modele/Publication_donnees_CEREN_2015.xlsx", create = F)

parc_CEREN_ener =data.table(readWorksheet(wbCEREN, sheet = "Tab_TERTIAIRE",startRow = 16,endRow = 21,header = T))
parc_CEREN_ener=parc_CEREN_ener[,1:7]
setnames(parc_CEREN_ener, c("ENERGIE","1990","2000","2005","2010","2012","2013"))
parc_CEREN_ener[,ENERGIE :=c("Gaz","Fioul","Urbain+Autres","Electricité","Total")]
    

comp_parc_par_ener = dcast.data.table(parc_par_ener[annee %in% annee_CEREN  ],scenario + ENERGIE ~ annee, value.var = "surface",fun.aggregate = function(x){sum(x)/10^6})

comp_parc_par_ener=melt(comp_parc_par_ener,id.vars = c("scenario","ENERGIE"), variable.name = "an",
                            value.name = "Surf")
comp_parc_par_ener= rbind(comp_parc_par_ener,
cbind(comp_parc_par_ener[ENERGIE=="Autres",list(scenario,an)],ENERGIE ="Urbain+Autres" ,Surf=comp_parc_par_ener[ENERGIE=="Autres",Surf] + comp_parc_par_ener[ENERGIE=="Urbain",Surf])
)



parc_CEREN_ener[, scenario:= "CEREN"]

parc_CEREN_ener = melt(parc_CEREN_ener, id.vars = c("ENERGIE","scenario"), variable.name = "an", value.name = "Surf")

comp_parc_par_ener = rbind(comp_parc_par_ener,parc_CEREN_ener)
comp_parc_par_ener[,ENERGIE :=factor(ENERGIE,levels = c("Electricité","Gaz","Fioul","Urbain","Autres","Urbain+Autres","Total"))]
    
## calage parc CEREN 2010 par ener
calage_parc_ener_2010 = comp_parc_par_ener[ an == "2010"]
calage_parc_ener_2010  =dcast.data.table(calage_parc_ener_2010 ,an+ ENERGIE~scenario)

calage_parc_ener_2010 [, calage :=calage_parc_ener_2010 [,3]/calage_parc_ener_2010 [,6]]

calage_parc_ener_2010 [, calage2 :=calage_parc_ener_2010 [,3]/calage_parc_ener_2010 [,7]]
#calage_parc_ener_2010 [, calage3 :=calage_parc_ener_2010 [,3]/calage_parc_ener_2010 [,8]]

calage_parc_ener_2013 = comp_parc_par_ener[ an == "2013"]
calage_parc_ener_2013  =dcast.data.table(calage_parc_ener_2013 ,an+ ENERGIE~scenario)

calage_parc_ener_2013 [, calage :=calage_parc_ener_2013 [,3]/calage_parc_ener_2013 [,6]]
calage_parc_ener_2013 [, calage2 :=calage_parc_ener_2013 [,3]/calage_parc_ener_2013 [,7]]
#calage_parc_ener_2013 [, calage3 :=calage_parc_ener_2013 [,3]/calage_parc_ener_2013 [,8]]


```


```{r comp_parc_CEREN, fig.width=20, fig.height=12, echo=F, warning=F,fig.cap='Comparaison avec le parc CEREN par branche', dev=c('png', 'pdf')}

ggplot(comp_parc_par_branche[an %in% annee_CEREN & BRANCHE != "Total général"]) + 
           geom_bar(aes(scenario,Surf, fill = branche, color =  branche), stat="identity") + 
           facet_wrap(~an, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ggtitle("Comparaison du parc du modèle avec le CEREN") + ylab("Mm²")+
  mytheme_facet_plot

```

```{r comp_parc_CEREN_ener, fig.width=20, fig.height=12, echo=F, warning=F,fig.cap='Comparaison avec le parc CEREN par énergie de chauffage', dev=c('png', 'pdf')}

ggplot(comp_parc_par_ener [an %in% annee_CEREN & ENERGIE != "Autres" & ENERGIE != "Urbain" & ENERGIE != "Total"]) + 
           geom_bar(aes(scenario,Surf, fill = ENERGIE, color =  ENERGIE), stat="identity") + 
           facet_wrap(~an, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ggtitle("Comparaison du parc du modèle avec le CEREN") + ylab("Mm²")+
  mytheme_facet_plot

```

\pagebreak
\newpage 
\clearpage
\pagebreak

\section{2) Evolution des consommmations}

## Ensemble du parc

```{r,echo=F, warning=F,include = F}
##### tableau des consos DGEC

Conso_nationale_usage = dcast.data.table(Conso, scenario + annee ~usage,fun.aggregate = function(x){sum(x)/10^9}, value.var = "value")

Conso_nationale_usage = melt(Conso_nationale_usage, id.vars = c("scenario","annee"), variable.name = "usage", value.name = "conso_tWhEF")


conso_parusage = dcast.data.table(Conso_nationale_usage[annee %in% c("2010","2013","2015","2020","2025","2030","2035","2050"),],
                                  scenario + annee ~ usage)

conso_parusage = conso_parusage[,list(Chauffage,
                                      AU_ther = sum(ECS,Cuisson,Autre),
                                      Elec_spe = sum(Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire),
                                      Clim = Climatisation,
 Total_RT=sum(Chauffage,Climatisation,ECS,Auxiliaires,Ventilation,Eclairage),                                      Total=sum(Chauffage,Climatisation,ECS,Cuisson,Autre,Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire) ), by=c("scenario","annee")]

conso_parusage = melt(conso_parusage,id.vars = c("scenario","annee"),variable.name ="usage" )

conso_parusage[, conso_mtep := value/11630*10^3]
conso_parusage[, conso := value]


conso_parusage_tWh = dcast.data.table(conso_parusage, scenario + usage ~ annee, value.var = "value")
conso_parusage_tWh = conso_parusage_tWh[order(usage),]
conso_parusage_tWh[, scenario := substring(scenario,1,2)]


conso_parusage_mtep = dcast.data.table(conso_parusage, scenario + usage ~ annee, value.var = "conso_mtep")
conso_parusage_mtep  = conso_parusage_mtep[order(usage),]
conso_parusage_mtep[, scenario := substring(scenario,1,2)]
annee_ref = "2010"

evolconso = conso_parusage_tWh 

evolconso = evolconso[,list(scenario, usage,
                Evol_2015 = paste0(round((get("2015")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2020 = paste0(round((get("2020")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2020 = paste0(round((get("2025")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2030 = paste0(round((get("2030")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2035 = paste0(round((get("2035")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2050 = paste0(round((get("2050")/get(annee_ref)-1)*100, digits=1), " %"))]

evolconso[, scenario := substring(scenario,1,2)]

setnames(evolconso, c("scenario", "usage",paste(annee_ref,c(15,20,25,30,35,50), sep="-")))
#♦Consotab = merge(conso_parusage_mtep,evolconso,by=c("scenario","usage"))
###
##### Différence de conso totales par usage par rapport à un scénario de ref

comp_conso_ref = dcast.data.table(Conso_nationale_usage[annee %in% c(2010:2020,
                                                                     "2025","2030","2035","2040","2045","2050"),],
                                  scenario + annee ~ usage)

comp_conso_ref=comp_conso_ref[,list(Chauffage,
                                      AU_ther = sum(ECS,Cuisson,Autre),
                                      Elec_spe = sum(Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire),
                                      Clim = Climatisation,
 Total_RT=sum(Chauffage,Climatisation,ECS,Auxiliaires,Ventilation,Eclairage),                                      Total=sum(Chauffage,Climatisation,ECS,Cuisson,Autre,Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire) ), by=c("scenario","annee")]

comp_conso_ref = melt(comp_conso_ref,id.vars = c("scenario","annee"),variable.name ="usage" )

comp_conso_ref[, conso_mtep := value/11630*10^3]
comp_conso_ref[, conso := value]


conso_parusage_ref = comp_conso_ref[scenario ==scenario_ref] 
comp_conso_ref = comp_conso_ref[scenario !=scenario_ref]
comp_conso_ref = merge(comp_conso_ref,conso_parusage_ref[,list(conso_ref = conso,conso_mtep_ref=conso_mtep,annee,usage )], by=c("annee","usage"))
comp_conso_ref[, diffconso := (conso-conso_ref)]

tab_diffconso_2010_2020 = comp_conso_ref[annee%in% 2014:2020]
tab_diffconso_2010_2020 = dcast.data.table(tab_diffconso_2010_2020,usage+scenario~annee, value.var = "diffconso")

tab_diffconso_2010_2020 
``` 


```{r, echo=F, warning=F,}
pander(conso_parusage_tWh[order(usage)], digits = 2, caption = "Bilan des consommations en tWh EF")
```

\pagebreak

```{r, echo=F, warning=F,}
pander(evolconso[order(usage)], digits = 2, caption = "Evolution des consommations")
```


```{r,  echo=F, warning=F,include = F}
##### consommations nationales par énergie et type de parc 
Conso_nationale_energie_type = dcast.data.table(Conso, scenario + annee + Type_parc ~nom_energie,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")
Conso_nationale_energie_type = melt(Conso_nationale_energie_type, id.vars = c("scenario","annee", "Type_parc"), variable.name = "energie", value.name = "conso_tWhEF")

Conso_nationale_energie = Conso_nationale_energie_type[,list(conso_tWhEF = sum(conso_tWhEF)),  by=c("scenario","annee", "energie")]
Conso_nationale_energie[, scenario_short := substring(scenario,1,2)]
Conso_nationale_energie[, energie :=factor(energie, levels = c("Electricité","Gaz","Fioul", "Urbain","Autres"))]


conso_parenergie_tWh = dcast.data.table(Conso_nationale_energie[annee %in% c("2010","2013","2015","2020","2025","2030","2035","2040","2045","2050")], scenario + energie ~ annee, value.var = "conso_tWhEF")

conso_parenergie_tWh = conso_parenergie_tWh[order(energie),]

conso_parenergie_mtep = dcast.data.table(Conso_nationale_energie[annee %in% c("2010","2013","2015","2020","2025","2030","2035","2040","2045","2050")], scenario + energie ~ annee, value.var = "conso_tWhEF", fun.aggregate = function(x){sum(x)/11630*10^3})

conso_parenergie_mtep = conso_parenergie_mtep[order(energie),]

##### consommations nationales usage et type de parc 

Conso_nationale_usage_type = dcast.data.table(Conso, scenario + annee + Type_parc ~usage,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")

Conso_nationale_usage_type = melt(Conso_nationale_usage_type , id.vars = c("scenario","annee", "Type_parc"), variable.name = "usage", value.name = "conso_tWhEF")

Conso_nationale_usage_type  = Conso_nationale_usage_type [,list(conso_tWhEF = sum(conso_tWhEF)),  
                                                          by=c("scenario","annee", "Type_parc", "usage")]

Conso_nationale_usage_type_all = Conso_nationale_usage_type
Conso_nationale_usage_type = dcast.data.table(Conso_nationale_usage_type[annee %in% c("2010","2015","2020","2025","2030","2035","2040","2045","2050"),],
                                  scenario +Type_parc +  annee ~ usage)

Conso_nationale_usage_type = Conso_nationale_usage_type[,list(Chauffage,
                                      AU_usages_ther = sum(ECS,Cuisson,Autre),
                                      Elec_spe = sum(Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire),
                                      Climatisation,
 Total_RT=sum(Chauffage,Climatisation,ECS,Auxiliaires,Ventilation,Eclairage),                                      Total=sum(Chauffage,Climatisation,ECS,Cuisson,Autre,Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire) ), by=c("scenario","Type_parc","annee")]

Conso_nationale_usage_type = melt(Conso_nationale_usage_type,id.vars = c("scenario","Type_parc","annee"),variable.name ="usage" )

Conso_nationale_usage_type  =dcast(Conso_nationale_usage_type,scenario +Type_parc +usage  ~ annee  )

annee_ref = "2010"

evolconso_usage_type = data.table(Conso_nationale_usage_type)
evolconso_usage_type = evolconso_usage_type[,list(scenario, usage,Type_parc,
                Evol_2020 = paste0(round((get("2020")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2030 = paste0(round((get("2030")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2040 = paste0(round((get("2040")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2050 = paste0(round((get("2050")/get(annee_ref)-1)*100, digits=1), " %"))]


setnames(evolconso_usage_type, c("scenario", "usage","Type_parc",paste(annee_ref,c(20,30,40,50), sep="-")))

### Evol consou totale parc neuf et ancien

surface_parc = parc_melted[,list(Surface = sum(Surface)),by=c("scenario","annee","Type_parc")]

evolconsou_usage_type = data.table(Conso_nationale_usage_type)
evolconsou_usage_type  = melt(evolconsou_usage_type ,id.vars = c("scenario","Type_parc","usage"),variable.name ="annee" )

evolconsou_usage_type = merge(evolconsou_usage_type, surface_parc,by=c("scenario","annee","Type_parc"),all.x=T)

evolconsou_usage_type[, Conso_u :=value*10^9/Surface]
evolconsou_usage_type = dcast.data.table(evolconsou_usage_type, scenario + usage + Type_parc ~ annee,value.var = "Conso_u")

evolconsou_usage_type = evolconsou_usage_type[,list(scenario, usage,Type_parc,
                                                    Evol_2010 = round((get("2010")/get(annee_ref)), digits=1),
                Evol_2020 = round((get("2020")/get(annee_ref)), digits=2),
                Evol_2030 = round((get("2030")/get(annee_ref)), digits=2),
                Evol_2040 = round((get("2040")/get(annee_ref)), digits=2),
                Evol_2050 = round((get("2050")/get(annee_ref)), digits=2))]

setnames(evolconsou_usage_type, c("scenario", "usage","Type_parc","2010","2020","2030","2040","2050"))

##### consommations nationales par énergie, usage et type de parc 
Conso_nationale_energie_type_usage = dcast.data.table(Conso, scenario + annee + Type_parc + usage ~nom_energie,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")

Conso_nationale_energie_type_usage = melt(Conso_nationale_energie_type_usage, id.vars = c("scenario","annee", "Type_parc", "usage"), variable.name = "energie", value.name = "conso_tWhEF")

Conso_nationale_energie_usage = Conso_nationale_energie_type_usage[,list(conso_tWhEF = sum(conso_tWhEF)),  by=c("scenario","annee", "energie","usage")]
Conso_nationale_energie_usage[, scenario_short := substring(scenario,1,2)]
Conso_nationale_energie_usage[, energie :=factor(energie, levels = c("Electricité","Gaz","Fioul", "Urbain","Autres"))]


##### consommations nationales par branche MEDPRO, énergie et usage

Conso_nationale_energie_branche = dcast.data.table(Conso, scenario + annee +branche+ nom_branche +Branche_MEDPRO+  usage  ~nom_energie,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")

Conso_nationale_energie_branche = melt(Conso_nationale_energie_branche, id.vars = c("scenario","annee","branche","nom_branche","Branche_MEDPRO","usage"), variable.name = "energie", value.name = "conso_tWhEF")

Conso_nationale_energie_branche[, energie :=factor(energie, levels = c("Electricité","Gaz","Fioul", "Urbain","Autres"))]

##### consommations nationales par branche, période de construction et type de parc 
Conso_nationale_energie_branche_type = dcast.data.table(Conso, scenario + annee + Type_parc +branche+ nom_branche + periodeSimple+ usage  ~nom_energie,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")
Conso_nationale_energie_branche_type = melt(Conso_nationale_energie_branche_type, id.vars = c("scenario","annee","branche","nom_branche","periodeSimple", "Type_parc","usage"), variable.name = "energie", value.name = "conso_tWhEF")

Conso_nationale_energie_branche_type[, scenario_short := substring(scenario,1,2)]
Conso_nationale_energie_branche_type[, energie :=factor(energie, levels = c("Electricité","Gaz","Fioul", "Urbain","Autres"))]


#### vérification calage conso avec CEREN
wbCEREN <- loadWorkbook("../AME_AMS_dataDGEC/parametrage modele/Publication_donnees_CEREN_2015.xlsx", create = F)

consotot_CEREN =data.table(readWorksheet(wbCEREN, sheet = "Tab_TERTIAIRE",startRow = 51,endRow = 56,header = T))
consotot_CEREN = consotot_CEREN[,1:7]
comp_consoCEREN = Conso_nationale_energie[annee%in%annee_CEREN]
comp_consoCEREN[, scenario_short := NULL]
setnames(consotot_CEREN, c("energie","1990","2000","2005","2010","2012","2013"))

comp_consoCEREN = rbind(comp_consoCEREN,
cbind(comp_consoCEREN[energie=="Autres",list(scenario,annee)],energie ="Urbain+Autres" ,conso_tWhEF=comp_consoCEREN[energie=="Autres",conso_tWhEF] + comp_consoCEREN[energie=="Urbain",conso_tWhEF])
)

consotot_CEREN[,energie :=c("Gaz","Fioul", "Urbain+Autres","Electricité", "Total")]

consotot_CEREN = melt(consotot_CEREN,id.vars = "energie",variable.name = "annee",value.name = "conso_tWhEF")
consotot_CEREN[,scenario :="CEREN"]
comp_consoCEREN =rbind(comp_consoCEREN ,consotot_CEREN[energie!="Total" & annee %in% annee_CEREN])

comp_consoCEREN[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité","Urbain", "Autres", "Urbain+Autres"))]

## calage conso CEREN 2010 par ener
calage_conso_ener_2010 = comp_consoCEREN[ annee == "2010"]
calage_conso_ener_2013 = comp_consoCEREN[ annee == "2013"]
calage_conso_ener_2010 =dcast.data.table(calage_conso_ener_2010 ,annee+ energie~scenario)
calage_conso_ener_2013 =dcast.data.table(calage_conso_ener_2013 ,annee+ energie~scenario)


calage_conso_ener_2010[, calage :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,5]]
calage_conso_ener_2010[, calage2 :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,6]]
 calage_conso_ener_2010[, calage3 :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,7]]
# calage_conso_ener_2010[, calage4 :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,10]]
# calage_conso_ener_2010[, calage5 :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,11]]

calage_conso_ener_2013[, calage :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,5]]
calage_conso_ener_2013[, calage2 :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,6]]
 calage_conso_ener_2013[, calage3 :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,7]]
# calage_conso_ener_2013[, calage4 :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,10]]
# calage_conso_ener_2013[, calage5 :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,11]]

calage_conso_ener_2010
calage_conso_ener_2013

sum(calage_conso_ener_2010[c(1:3,6),3])
#sum(calage_conso_ener_2010[c(1:3,6),12])
sum(calage_conso_ener_2013[c(1:3,6),3])
#sum(calage_conso_ener_2013[c(1:3,6),12])


### verif conso chauffage
consochauff_CEREN =data.table(readWorksheet(wbCEREN, sheet = "Tab_TERTIAIRE",startRow = 60,endRow = 65,header = T))
consochauff_CEREN = consochauff_CEREN[,1:7]
comp_consoChauffCEREN = Conso_nationale_energie_usage[annee%in%annee_CEREN & usage == "Chauffage"]
comp_consoChauffCEREN[, scenario_short := NULL]
comp_consoChauffCEREN[, usage := NULL]
comp_consoChauffCEREN = rbind(comp_consoChauffCEREN,
cbind(comp_consoChauffCEREN[energie=="Autres",list(scenario,annee)],energie ="Urbain+Autres" ,conso_tWhEF=comp_consoChauffCEREN[energie=="Autres",conso_tWhEF] + comp_consoChauffCEREN[energie=="Urbain",conso_tWhEF])
)



setnames(consochauff_CEREN, c("energie","1990","2000","2005","2010","2012","2013"))

consochauff_CEREN[,energie :=c("Gaz","Fioul", "Urbain+Autres","Electricité", "Total")]
consochauff_CEREN[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité","Urbain", "Autres", "Urbain+Autres"))]

consochauff_CEREN = melt(consochauff_CEREN,id.vars = "energie",variable.name = "annee",value.name = "conso_tWhEF")
consochauff_CEREN[,scenario :="CEREN"]

comp_consoChauffCEREN  =rbind(comp_consoChauffCEREN ,consochauff_CEREN[energie!="Total" & annee %in% annee_CEREN])

comp_consoChauffCEREN [,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité","Urbain", "Autres", "Urbain+Autres"))]

## calage conso chauff  CEREN 2010 par ener
calage_consoChauff_ener_2010 = comp_consoChauffCEREN[ annee == "2010"]
calage_consoChauff_ener_2013 = comp_consoChauffCEREN[ annee == "2013"]
calage_consoChauff_ener_2010 =dcast.data.table(calage_consoChauff_ener_2010 ,annee+ energie~scenario)
calage_consoChauff_ener_2013 =dcast.data.table(calage_consoChauff_ener_2013 ,annee+ energie~scenario)

calage_consoChauff_ener_2010[, calage :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,5]]
calage_consoChauff_ener_2010[, calage2 :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,6]]
 calage_consoChauff_ener_2010[, calage3 :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,7]]
# calage_consoChauff_ener_2010[, calage4 :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,10]]
# calage_consoChauff_ener_2010[, calage5 :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,11]]



calage_consoChauff_ener_2013[, calage :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,5]]
calage_consoChauff_ener_2013[, calage2 :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,6]]
 calage_consoChauff_ener_2013[, calage3 :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,7]]
# calage_consoChauff_ener_2013[, calage4 :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,10]]
# calage_consoChauff_ener_2013[, calage5 :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,11]]

calage_consoChauff_ener_2010

calage_consoChauff_ener_2013

sum(calage_consoChauff_ener_2010[c(1:3,6),3])
#sum(calage_consoChauff_ener_2010[c(1:3,6),12])
sum(calage_consoChauff_ener_2013[c(1:3,6),3])
#sum(calage_consoChauff_ener_2013[c(1:3,6),12])

### verif conso unitaire chauffage
calage_consoChauff_ener_2010
calage_parc_ener_2010

calage_consouChauff_2010 = merge(melt(calage_consoChauff_ener_2010, id.vars = c("annee","energie"), 
     variable.name = "scenario",value.name = "ConsoTwhEF"), 
     melt(calage_parc_ener_2010, id.vars = c("an","ENERGIE"), 
     variable.name = "scenario",value.name = "SurfaceMm2"),  
     by.x = c("annee","energie", "scenario"), by.y = c("an","ENERGIE", "scenario"))
    
calage_consouChauff_2010[, ConsoU := ConsoTwhEF*10^3/SurfaceMm2]

calage_consouChauff_2010 = data.table(dcast(calage_consouChauff_2010, annee + energie ~ scenario, value.var = "ConsoU" ))

calage_consouChauff_2010
calage_consouChauff_2010[, calage :=calage_consouChauff_2010[,3]/calage_consouChauff_2010[,5]]
calage_consouChauff_2010[, calage2 :=calage_consouChauff_2010[,3]/calage_consouChauff_2010[,6]]
# calage_consouChauff_2010[, calage3 :=calage_consouChauff_2010[,3]/calage_consouChauff_2010[,9]]
# calage_consouChauff_2010[, calage4 :=calage_consouChauff_2010[,3]/calage_consouChauff_2010[,10]]

calage_consouChauff_2013 = merge(melt(calage_consoChauff_ener_2013, id.vars = c("annee","energie"), 
     variable.name = "scenario",value.name = "ConsoTwhEF"), 
     melt(calage_parc_ener_2013, id.vars = c("an","ENERGIE"), 
     variable.name = "scenario",value.name = "SurfaceMm2"),  
     by.x = c("annee","energie", "scenario"), by.y = c("an","ENERGIE", "scenario"))
    
calage_consouChauff_2013[, ConsoU := ConsoTwhEF*10^3/SurfaceMm2]

calage_consouChauff_2013 = data.table(dcast(calage_consouChauff_2013, annee + energie ~ scenario, value.var = "ConsoU" ))

calage_consouChauff_2013 
calage_consouChauff_2013[, calage :=calage_consouChauff_2013[,3]/calage_consouChauff_2013[,5]]
calage_consouChauff_2013[, calage2 :=calage_consouChauff_2013[,3]/calage_consouChauff_2013[,6]]
# calage_consouChauff_2013[, calage3 :=calage_consouChauff_2013[,3]/calage_consouChauff_2013[,9]]
# calage_consouChauff_2013[, calage4 :=calage_consouChauff_2013[,3]/calage_consouChauff_2013[,10]]

consou_ener = merge(Conso_nationale_energie_branche_type[usage == "Chauffage",sum(conso_tWhEF), by=c("energie","annee","Type_parc")], 
      merge(parc_melted, COD_ENERGIE, by.x = c("energieChauffage"), by.y=c("COD_ENERGIE"))[,sum(Surface), by=c("ENERGIE","annee","Type_parc")]
      ,
      by.x=c("energie","annee","Type_parc"), by.y=c("ENERGIE","annee","Type_parc"))
consou_ener[,Consou :=  V1.x*10^9/ V1.y]
tmp = dcast(consou_ener,Type_parc + energie ~ annee,value.var = "Consou")
tmp[,9]/tmp[,4]

### verif conso autres usages 
calage_consoAutres_ener_2010 = cbind(calage_conso_ener_2010[,1:2],calage_conso_ener_2010[,c("CEREN",wbname),with=F] - calage_consoChauff_ener_2010[,c("CEREN",wbname), with=F])
calage_consoAutres_ener_2013 = cbind(calage_conso_ener_2013[,1:2],calage_conso_ener_2013[,c("CEREN",wbname),with=F] - calage_consoChauff_ener_2013[,c("CEREN",wbname), with=F])


calage_consoAutres_ener_2010[, calage :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,5]]
calage_consoAutres_ener_2010[, calage2 :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,6]]
calage_consoAutres_ener_2010[, calage3 :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,7]]
# calage_consoAutres_ener_2010[, calage4 :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,10]]
# calage_consoAutres_ener_2010[, calage5 :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,11]]


consochauff_CEREN[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité","Urbain", "Autres", "Urbain+Autres"))]
Conso_nationale_energie[annee %in% c("2010","2013","2015","2020","2030")]
```


```{r comp_conso_CEREN, fig.width=20, fig.height=12, echo=F, warning=F,fig.cap='Comparaison avec les consommations totales du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN[energie != "Autres" & energie != "Urbain"] ) + 
           geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) +
  
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWhEF")+
  mytheme_facet_plot

```

```{r comp_consochauff_CEREN, fig.width=20, fig.height=12, echo=F, warning=F,fig.cap='Comparaison avec les consommations de chauffage du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoChauffCEREN[energie != "Autres" & energie != "Urbain"]) + 
           geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWhEF")+
  mytheme_facet_plot

```

\clearpage
\newpage 

\section{Parts de marchés des systèmes et des énergies de chauffage}


### PM des énergies dans le neuf

```{r,echo=F, warning=F,include = F}
### PM des énergies dans le neuf


PM_energie_neuf = PM[Type_parc ==  "N", list(Surf_neuf_n = sum(surface)),by=c("scenario", "Type_parc","energieChauffage","periodeSimple","annee")] 

PM_energie_neuf[, annee_n1 := as.factor(as.numeric(as.character(annee)) -1)]

PM_energie_neuf = merge(PM_energie_neuf,
                        PM_energie_neuf[,list(scenario,Type_parc,annee,energieChauffage,periodeSimple,Surf_neuf_n1 = Surf_neuf_n )], 
                        by.x=c("scenario", "Type_parc","energieChauffage","periodeSimple","annee_n1"), 
                        by.y=c("scenario", "Type_parc","energieChauffage","periodeSimple","annee"))


PM_energie_neuf[,surf_cons_n := Surf_neuf_n - Surf_neuf_n1]
PM_energie_neuf[, PM_ener_neuf := surf_cons_n/sum(surf_cons_n),by=c("scenario", "Type_parc","periodeSimple","annee")]

PM_energie_neuf = PM_energie_neuf[(annee %in% 2010:2015 & periodeSimple=="04")|(annee %in% 2016:2020 & periodeSimple=="05")|
                                    (annee %in% 2021:2030 & periodeSimple=="06")|(annee %in% 2031:2040 & periodeSimple=="07")|(annee %in% 2041:2050 & periodeSimple=="08")] 
PM_energie_neuf[,sum(PM_ener_neuf), by="annee"]

PM_energie_neuf = merge(PM_energie_neuf,COD_ENERGIE[, list(energieChauffage =  COD_ENERGIE, Energie = ENERGIE)], by="energieChauffage")

dcast(PM_energie_neuf, scenario+Energie~ annee, value.var ="PM_ener_neuf")
### PM dans le parc construit après 2010
PM_energie_neuf_DGEC =parc_melted[Type_parc ==  "N", list(Surf_neuf_n = sum(Surface)),by=c("scenario", "Type_parc","energieChauffage","annee")] 
PM_energie_neuf_DGEC[, PM_ener_neuf := Surf_neuf_n/sum(Surf_neuf_n ),by=c("scenario", "Type_parc","annee")]
PM_energie_neuf_DGEC = merge(PM_energie_neuf_DGEC,COD_ENERGIE[, list(energieChauffage =  COD_ENERGIE, Energie = ENERGIE)], by="energieChauffage")


## PM systeme neuf 


PM_syst_neuf = PM[Type_parc ==  "N", list(Surf_neuf_n = sum(surface)),by=c("scenario", "Type_parc","systeme_chauff","periodeSimple","annee")] 

PM_syst_neuf [, annee_n1 := as.factor(as.numeric(as.character(annee)) -1)]

PM_syst_neuf = merge(PM_syst_neuf ,
                        PM_syst_neuf [,list(scenario,Type_parc,annee,systeme_chauff,periodeSimple,Surf_neuf_n1 = Surf_neuf_n )], 
                        by.x=c("scenario", "Type_parc","systeme_chauff","periodeSimple","annee_n1"), 
                        by.y=c("scenario", "Type_parc","systeme_chauff","periodeSimple","annee"))


PM_syst_neuf[,surf_cons_n := Surf_neuf_n - Surf_neuf_n1]
PM_syst_neuf[, PM_syst_neuf := surf_cons_n/sum(surf_cons_n),by=c("scenario", "Type_parc","periodeSimple","annee")]

PM_syst_neuf = PM_syst_neuf[(annee %in% 2010:2015 & periodeSimple=="04")|(annee %in% 2016:2020 & periodeSimple=="05")|
                                    (annee %in% 2021:2030 & periodeSimple=="06")|(annee %in% 2031:2040 & periodeSimple=="07")|(annee %in% 2041:2050 & periodeSimple=="08")] 
PM_syst_neuf[,sum(PM_syst_neuf), by="annee"]

PM_syst_neuf = merge(PM_syst_neuf,COD_SYSTEME_CHAUD[, list(systeme_chauff =  COD_SYSTEME_CHAUD, SYSTEME_CHAUD= SYSTEME_CHAUD)], by="systeme_chauff")

PM_syst_neuf[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  
                                                           "Autre système centralisé performant",
                                                           "nr"))]
unique(PM_syst_neuf$SYSTEME_CHAUD)

PM_syst_neuf= merge(PM_syst_neuf,colors_syst, by="SYSTEME_CHAUD")



```


```{r Evol_PM_energie_neuf, fig.width=25, fig.height=9, echo=F, warning=F,fig.cap='Part des surfaces neuves construites par énergie (input DGEC)', dev=c('png', 'pdf')}

ggplot(PM_energie_neuf) +
           geom_bar(aes(annee,PM_ener_neuf , fill = Energie, color = Energie), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot  +
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) 
```

```{r Evol_PM_syst_neuf, fig.width=25, fig.height=13, echo=F, warning=F,fig.cap='Part des surfaces neuves construites par système', dev=c('png', 'pdf')}

ggplot(PM_syst_neuf) +
           geom_bar(aes(annee,PM_syst_neuf , fill = SYSTEME_CHAUD, color = SYSTEME_CHAUD), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot  +
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5))  +
     theme(legend.position = "top") +
  scale_fill_manual(values=unique(PM_syst_neuf$color),
                    guide = guide_legend(nrow = 4)) 
```

\clearpage
\pagebreak

## Changements de système dans l'existant

```{r,echo=F, warning=F,include = F}


PM_syst_br = COUTS[!is.na(COD_SYSTEME_CHAUD), list(surface = sum(surface)), by=c("scenario","annee","SYSTEME_CHAUD","COD_SYSTEME_CHAUD", "branche")]
PM_syst_br [,PM_syst := surface/sum(surface) , by=c("scenario","annee", "branche")]
PM_syst_br = merge(PM_syst_br ,COD_BRANCHE[,list(branche=COD_BRANCHE,BRANCHE)],by="branche")

PM_syst_Etat = COUTS[!is.na(COD_SYSTEME_CHAUD) & occupant=="03", list(surface = sum(surface)), by=c("scenario","annee","SYSTEME_CHAUD","COD_SYSTEME_CHAUD")]
COUTS[COD_SYSTEME_CHAUD %in% c("05","06","09","10","11","25","26","29","30","31") & annee == "2010", sum(surface)]

COUTS[COD_SYSTEME_CHAUD %in% c("05"), typeRenovationSysteme]

PM_syst = COUTS[!is.na(COD_SYSTEME_CHAUD), list(surface = sum(surface)), by=c("scenario","annee","SYSTEME_CHAUD","COD_SYSTEME_CHAUD")]


PM_syst[,PM_syst := surface/sum(surface) , by=c("scenario","annee")]
PM_syst[, sum(surface),by="annee"]
PM_syst[COD_SYSTEME_CHAUD == "24"]

PM_syst[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  
                                                           "Autre système centralisé performant",
                                                           "nr"))]
unique(PM_syst$SYSTEME_CHAUD)

PM_syst= merge(PM_syst,colors_syst, by="SYSTEME_CHAUD")




PM_syst_br[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  
                                                           "Autre système centralisé performant",
                                                           "nr"))]
unique(PM_syst_br$SYSTEME_CHAUD)

PM_syst_br= merge(PM_syst_br,colors_syst, by="SYSTEME_CHAUD")

PM_syst_Etat [,PM_syst := surface/sum(surface) , by=c("scenario","annee")]
PM_syst_Etat [, sum(surface),by="annee"]
PM_syst_Etat [COD_SYSTEME_CHAUD == "24"]

PM_syst_Etat[PM_syst <0]


levels(PM_syst$SYSTEME_CHAUD)


```

```{r Evol_PM_syst, fig.width=25, fig.height=13, echo=F, warning=F,fig.cap='Part des changements de système existant par système installé', dev=c('png', 'pdf')}

ggplot(PM_syst) +
           geom_bar(aes(annee,PM_syst , fill = SYSTEME_CHAUD), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot+ theme(legend.position = "top")+
  
  scale_fill_manual(values=unique(PM_syst$color),
                    guide = guide_legend(nrow = 4)) 



```

```{r Evol_PM_syst_ref, fig.width=25, fig.height=13, echo=F, warning=F,fig.cap='Part des changements de système existant par système installé', dev=c('png', 'pdf')}

ggplot(PM_syst[scenario == scenario_ref]) +
           geom_bar(aes(annee,PM_syst , fill = SYSTEME_CHAUD), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot+ theme(legend.position = "top")+
  
  scale_fill_manual(values=unique(PM_syst[scenario == scenario_ref]$color),
                    guide = guide_legend(nrow = 4)) 

```


```{r,echo=F, warning=F,include = F}
### PM des systèmes dans sur l'ensemble du parc
PM_syst_exi = etiquette[, list(Surf_exi_n = sum(surface)),by=c("scenario","annee","systeme_chauff")] 
PM_syst_exi2 = PM[, list(Surf_exi_n = sum(surface)),by=c("scenario","annee","systeme_chauff")] 

PM_syst_exi[,PM_syst_exi := Surf_exi_n /sum(Surf_exi_n ),by=c("scenario","annee")]
PM_syst_exi2[,PM_syst_exi := Surf_exi_n /sum(Surf_exi_n ),by=c("scenario","annee")]

PM_syst_exi[,sum(PM_syst_exi), by=c("scenario","annee")]
PM_syst_exi2[,sum(PM_syst_exi), by=c("scenario","annee")]

PM_syst_exi = merge(PM_syst_exi,COD_SYSTEME_CHAUD[, list(systeme_chauff =  COD_SYSTEME_CHAUD, SYSTEME_CHAUD)], by="systeme_chauff")
PM_syst_exi2 = merge(PM_syst_exi2,COD_SYSTEME_CHAUD[, list(systeme_chauff =  COD_SYSTEME_CHAUD, SYSTEME_CHAUD)], by="systeme_chauff")

PM_syst_exi = rbind(PM_syst_exi,PM_syst_exi2 )
PM_syst_exi[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  
                                                           "Autre système centralisé performant",
                                                           "nr"))]


PM_syst_exi = dcast.data.table(PM_syst_exi[annee %in% seq(2010,2050,5)],scenario +SYSTEME_CHAUD~annee,value.var ="PM_syst_exi")

PM_syst_exi = merge(PM_syst_exi,colors_syst, by="SYSTEME_CHAUD")



```

\clearpage
\pagebreak

## PM des systèmes dans le stock


```{r Evol_PM_syst_all, fig.width=25, fig.height=13, echo=F, warning=F,fig.cap='Part des systèmes sur l\'ensemble du parc', dev=c('png', 'pdf')}

ggplot(melt(PM_syst_exi,id.vars = c("scenario","SYSTEME_CHAUD","color"),variable.name = "annee",value.name = "PM_syst")) +
           geom_bar(aes(annee,PM_syst , fill = SYSTEME_CHAUD, color = SYSTEME_CHAUD), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot + theme(legend.position = "top")+
  
  scale_fill_manual(values=unique(PM_syst_exi$color),
                    guide = guide_legend(nrow = 4)) 

```



<!-- ```{r write-excel_medpro_conso, echo=F, message=FALSE, warning=F, cache=T, results=F, cache.rebuild =F,include = F} -->

<!-- Conso_nationale_energie_usage_branche = dcast.data.table(Conso, scenario + annee+ branche+usage ~nom_energie,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value") -->

<!-- Conso_nationale_energie_usage_branche = melt(Conso_nationale_energie_usage_branche , id.vars = c("scenario","annee", "branche", "usage"), variable.name = "energie", value.name = "conso_tWhEF") -->

<!-- Conso_nationale_energie_usage_branche = merge(Conso_nationale_energie_usage_branche, COD_BRANCHE[, list(branche = COD_BRANCHE, BRANCHE)], by="branche") -->

<!-- annee_selected = c("2009","2015","2020","2025","2030","2050") -->
<!-- scenario_select = scenario_toexport -->


<!-- Conso_nationale_energie -->

<!-- tab_energie_MEDPRO = -->
<!--   dcast(Conso_nationale_energie[annee %in% annee_selected & scenario == scenario_select], scenario + energie ~ annee, value.var = "conso_tWhEF") -->

<!-- tab_energie_usage_MEDPRO = -->
<!--   dcast(Conso_nationale_energie_usage[annee %in% annee_selected & scenario == scenario_select], scenario + usage + energie ~ annee, value.var = "conso_tWhEF") -->


<!-- tab_energie_usage_branche_MEDPRO = -->
<!--     dcast(Conso_nationale_energie_usage_branche[annee %in% annee_selected & scenario == scenario_select], scenario + BRANCHE + usage + energie ~ annee, value.var = "conso_tWhEF") -->


<!-- Conso_nationale_energie_usage_branche[,BRANCHE_MEDPRO := NULL] -->

<!-- Conso_nationale_energie_usage_branche[BRANCHE == "Bureaux Administration",BRANCHE_MEDPRO := "Bureaux"] -->
<!-- Conso_nationale_energie_usage_branche[BRANCHE == "Commerce",BRANCHE_MEDPRO := "Commerces"] -->
<!-- Conso_nationale_energie_usage_branche[BRANCHE == "Santé Action Sociale",BRANCHE_MEDPRO := "Santé"] -->
<!-- Conso_nationale_energie_usage_branche[is.na(BRANCHE_MEDPRO),BRANCHE_MEDPRO := "Autres"] -->
<!-- Conso_nationale_energie_usage_branche[,BRANCHE_MEDPRO := factor(BRANCHE_MEDPRO,levels = c("Bureaux","Commerces","Santé","Autres"))] -->

<!-- Conso_nationale_energie_usage_branche[,usage_MEDPRO := NULL] -->
<!-- Conso_nationale_energie_usage_branche[usage == "Chauffage",usage_MEDPRO := "Chauffage"] -->
<!-- Conso_nationale_energie_usage_branche[usage %in% c("ECS","Cuisson","Autre"),usage_MEDPRO := "Autres usages thermiques"] -->
<!-- Conso_nationale_energie_usage_branche[usage %in% c("Auxiliaires","Ventilation","Process","Bureautique","Eclairage","Froid_alimentaire"),usage_MEDPRO := "Elec spécifique"] -->
<!-- Conso_nationale_energie_usage_branche[usage %in% c("Climatisation"),usage_MEDPRO := "Climatisation"] -->
<!-- Conso_nationale_energie_usage_branche[,usage_MEDPRO := factor(usage_MEDPRO,levels = c("Chauffage", "Autres usages thermiques","Elec spécifique","Climatisation"))] -->

<!-- summary(Conso_nationale_energie_usage_branche) -->

<!-- tab_energie_usage_branche_MEDPRO2 = -->
<!--     dcast.data.table(Conso_nationale_energie_usage_branche[annee %in% "2015" & scenario == scenario_select], scenario + BRANCHE_MEDPRO + usage_MEDPRO  ~ annee + energie , value.var = "conso_tWhEF", fun.aggregate = sum) -->

<!-- tab_energie_usage_branche_MEDPRO2 = tab_energie_usage_branche_MEDPRO2[order(BRANCHE_MEDPRO)] -->

<!-- tab_energie_usage_branche_MEDPRO3 = -->
<!--     dcast.data.table(Conso_nationale_energie_usage_branche[annee %in% "2013" & scenario == scenario_select], scenario + BRANCHE_MEDPRO + usage_MEDPRO  ~ annee + energie , value.var = "conso_tWhEF", fun.aggregate = sum) -->

<!-- tab_energie_usage_branche_MEDPRO3 = tab_energie_usage_branche_MEDPRO3[order(BRANCHE_MEDPRO)] -->


<!-- wb <- loadWorkbook(paste0(wbdir_scenario_toexport,"Conso_tert_branche_energie_usage.xlsx"), create = F) -->

<!-- writeWorksheet(wb,tab_energie_MEDPRO, sheet = "Conso_energie", startRow =1) -->
<!-- writeWorksheet(wb,tab_energie_usage_MEDPRO, sheet = "Conso_energie_usage", startRow =1) -->
<!-- writeWorksheet(wb,tab_energie_usage_branche_MEDPRO, sheet = "Conso_branche_energie_usage", startRow =1) -->
<!-- writeWorksheet(wb,tab_energie_usage_branche_MEDPRO2, sheet = "Conso_branche_energie_usage", startRow =450) -->
<!-- writeWorksheet(wb,tab_energie_usage_branche_MEDPRO3, sheet = "Conso_branche_energie_usage", startRow =470) -->

<!-- saveWorkbook(wb) -->
<!-- ```  -->