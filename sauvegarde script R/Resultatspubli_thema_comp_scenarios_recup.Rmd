---
header-includes: #allows you to add in your own Latex packages
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
output:
  pdf_document: 
    fig_caption: yes
    keep_tex: yes
  word_document:
    fig_height: 6
    fig_width: 8
editor_options: 
  chunk_output_type: console
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```

```{r, echo=F, message=F, warning=F, cache=F, results=F}
require(knitr)
require(data.table)
require(ggplot2)
require(Hmisc)
require(reshape2)
require(plyr)
#require(ggthemes)
require(texreg)
if (Sys.getenv("JAVA_HOME")!="")
  Sys.setenv(JAVA_HOME="")
options(java.parameters = "-Xmx8192m")
require(XLConnect)
require(RColorBrewer)
# set pander table-layout options
library(pander)
panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)

colorpalette = "Spectral"
fillpalette = "Spectral"

#colorpalette = "Set2"
#fillpalette = "Set2"
```


```{r, echo=F, message=F, warning=F, cache=T, results=F, comment = F, include = F, cache.rebuild = F}

##### prix des energies ####
prix_energie = fread("../AME_AMS_dataDGEC/parametrage modele/Prix_scenario_AME_BV_01_2017.csv", dec = ",")

prix_energie = melt(prix_energie,id.vars = "annee")

prix_energie[variable == "prix_elec", energie := "Electricité"]
prix_energie[variable == "prix_gaz", energie := "Gaz"]
prix_energie[variable == "prix_fioul", energie := "Fioul"]
prix_energie[variable == "prix_urbain", energie := "Urbain"]
prix_energie[variable == "prix_autres", energie := "Autres"]
prix_energie[variable == "CCE", energie := "CCE"]

prix_energie =dcast.data.table(prix_energie, annee~energie)
```

```{r, echo=F, message=FALSE, warning=F, cache=T, results=F, cache.rebuild = F}
source("analyse_param_utilisateurs.R",encoding = "ISO8859-1")

colors_syst= 
  data.table(SYSTEME_CHAUD =factor(unique(COD_SYSTEME_CHAUD$SYSTEME_CHAUD), 
                                   levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  "Autre système centralisé performant",
                                                           "nr","NA"))
                         )

colors_syst = colors_syst[order(SYSTEME_CHAUD)]
colors_syst[,color := c("dodgerblue1","dodgerblue4", "blue1","blue4","springgreen1","springgreen4",
                "yellow1","yellow4","gold1","gold4","chocolate1","chocolate4","coral1","coral3",
                "salmon1","salmon4","red1","red4","gray86","gray86")]


color_energie = data.table(ENERGIE = factor(c("Gaz", "Fioul","Electricité","Urbain","Autres"), levels = c("Gaz", "Fioul","Electricité","Urbain","Autres")), 
                           color = c("dodgerblue1","forestgreen","gold1", "orange1","red1"))

```

```{r, echo=F, message=FALSE, warning=F, cache=T, results=F, cache.rebuild = T,include = F}

#### liste des fichiers à lire
   
wbfiles  = "../tertiaire/model/Result_csv/publi_thema/prix_constant_nopol_verif"
wbfiles[2]  = "../tertiaire/model/Result_csv/publi_thema/prix_AME_noTC_verif"
wbfiles[3]  = "../tertiaire/model/Result_csv/publi_thema/2050_AME_final_verif"
wbfiles[4]  = "../tertiaire/model/Result_csv/publi_thema/2050_AMS_final"

####### noms des scenarios ########

wbname = c( paste0("S",1:length(wbfiles)))
  
wbname = c("S0 Nopol","S1 Prix","S2 AME","S3 AMS",  paste0("S",4:(length(wbfiles))))

### choix du scenario de référence 

scenario_ref =c("S0 Nopol")
scenario_toexport = c("S3 AMS")
scenario_sansCEE = c( "S0 Nopol")
scenario_comp_AMS = c("S0 Nopol","S1 Prix","S2 AME","S3 AMS")

wbdir_scenario_toexport = c("../publication_thema/run_AMS/")
write_excel =T

scenarioshortnames = substring(wbname,1,2)
scenarioshortnames = c("S0 Nopol","S1 Prix","S2 AME","S3 AMS", paste0("S",4:(length(wbfiles))))
scenarioshortnames = wbname


scenariolabels = c("S0 Nopol" = "S0", "S1 Prix" = "Prix", 
                   "S2 AME"= "AME","S3 AMS"="AMS")

scenarios_taxeelec = ""

##### émissions de référence en MTCO2 
Em_ref_2012_tous_usages = 33.5
Em_ref_2012_chauffage = 23.6

Em_ref_1990_tous_usages = 28.8
Em_ref_1990_chauffage =  Em_ref_2012_chauffage/Em_ref_2012_tous_usages*Em_ref_1990_tous_usages 


##### lecture des resultats

source("read_resultats_csv.R", encoding= "UTF-8")

##### Conso de référence en tWh 
Conso_ref_2012_chauffage = Conso[usage=="Chauffage" & annee == "2012" & scenario==scenario_ref, sum(value)/10^9]
Conso_ref_2012_tous_usages = Conso[ annee == "2012" & scenario==scenario_ref, sum(value)/10^9]

annee_ref_MEDPRO = "2015"
annee_MEDPRO = c("2015","2020","2025","2030","2050")

Conso[annee == "2030"& usage=="Chauffage",sum(value), by=c("nom_energie", "scenario") ]
Conso[annee == "2050"& usage=="Chauffage",sum(value), by=c("nom_energie", "scenario") ]
Conso[annee == "2030",sum(value), by=c("nom_energie", "scenario") ]
```


# FICHE RESULTATS AMS run 2


Scénarios comparés :

* S1 AME run 2

* s2 AMS run 1 

* s3 AMS run 2

## 1) Evolution du parc (Surfaces)

```{r,echo=F, warning=F,include = F}

datatmp = parc_melted[,list(value = sum(Surface)), by=c("scenario","annee", "Type_parc")]
datatmp [,Type_parc  := factor(Type_parc, levels = c("N","E"))]
datatmp = datatmp[, list(cumsurf = cumsum(value),Type_parc), by=c("annee","scenario") ]

``` 

### Ensemble du Parc

```{r Evol_parc , fig.width=25, fig.height=9, echo=F, warning=F,fig.cap='Evolution du parc', dev=c('png', 'pdf')}

ggplot(datatmp) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = cumsurf/10^6, group = Type_parc, fill = Type_parc)) + 
    ylab("Millions de m²") + facet_wrap(~scenario)  + xlab("")+
  mytheme_facet_plot +
  scale_x_discrete(breaks = seq(2010,2050,10), labels =
                    seq(2010,2050,10)) +
  scale_fill_manual("",values = c("N"="darkorange", "E"="deepskyblue2"), breaks = c("N","E"), 
                    labels = c("Parc neuf (>2009)","Parc existant (<2009)"))
```

```{r,echo=F, warning=F,include = F}

datatmp = parc_melted[,list(value = sum(Surface)), by=c("scenario","annee", "Type_parc","branche")]
datatmp [,Type_parc  := factor(Type_parc, levels = c("N","E"))]
datatmp = datatmp[, list(cumsurf = cumsum(value),surface = value,Type_parc), by=c("annee","scenario","branche") ]
#datatmp [,scenario  := factor(scenario, levels = rev(levels(scenario) ))]
#datatmp [,Type_parc  := factor(Type_parc, levels = c("E","N"))]

parc_par_branche = merge(datatmp, COD_BRANCHE[, list(branche = COD_BRANCHE, BRANCHE)],by="branche")


datatmp = parc_melted[,list(value = sum(Surface)), by=c("scenario","annee", "energieChauffage")]
datatmp = datatmp[, list(cumsurf = cumsum(value),surface = value), by=c("annee","scenario","energieChauffage") ]
#datatmp [,scenario  := factor(scenario, levels = rev(levels(scenario) ))]
#datatmp [,Type_parc  := factor(Type_parc, levels = c("E","N"))]

parc_par_ener = merge(datatmp, COD_ENERGIE[, list(energieChauffage = COD_ENERGIE, ENERGIE)],by="energieChauffage")

``` 
```{r,echo=F, warning=F,include = F}
# tableau evolution parc avant 2010 et après 2010 et total 
anneeDGEC = seq(2010,2050,5)
parc_melted[Type_parc == "E", periodeconsDGEC := "Parc < 2009"]
parc_melted[Type_parc == "N", periodeconsDGEC := "Parc > 2009"]

TabparcDGEC = parc_melted[,list(value = sum(Surface)/10^6), by=c("scenario", "periodeconsDGEC","annee")]

TabparcDGEC = rbind(TabparcDGEC,parc_melted[,list(periodeconsDGEC = "Total" ,value = sum(Surface)/10^6), by=c("scenario","annee")])

parc_toutesannees = TabparcDGEC 

TabparcDGEC = TabparcDGEC[annee %in% anneeDGEC,]
TabparcDGEC = dcast.data.table(TabparcDGEC,scenario+periodeconsDGEC ~annee)
#TabparcDGEC[,scenario := scenario]
``` 


```{r, echo=F, warning=F,}
pander(TabparcDGEC  , digits = 2, caption = "Evolution du parc (surfaces en millions de m²)")
```

<!-- \pagebreak  -->

### Parc par branche

```{r Evol_parc_branche, fig.width=25, fig.height=24, echo=F, warning=F,fig.cap='Evolution du parc par branche', dev=c('png', 'pdf')}

ggplot(parc_par_branche ) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = cumsurf/10^6, group =Type_parc, fill = Type_parc)) + 
    ylab("Millions de m²") +
  mytheme_facet_plot + scale_fill_brewer(palette = fillpalette) +  
   scale_x_discrete(breaks = seq(2010,2050,10), labels =
                    seq(2010,2050,10))  + facet_wrap(~ BRANCHE+scenario, nrow = 8) 
  
```


### Parc par période de construction 

```{r,echo=F, warning=F,include = F}

parc_periode = parc_melted[,list(Surface = sum(Surface)), by=c("scenario","annee", "periodeSimple")]
parc_periode = merge(parc_periode , COD_PERIODE_SIMPLE[, list( periodeSimple = COD_PERIODE_SIMPLE, PERIODE_SIMPLE)], 
                     by = "periodeSimple")

parc_periode[, PERIODE2 :=PERIODE_SIMPLE]

parc_periode[annee == "2010" & PERIODE_SIMPLE == "2009-2015", PERIODE2 := "1999-2009"]

parc_periode[PERIODE_SIMPLE == "1999-2008", PERIODE2 := "1999-2009"]

parc_periode = parc_periode[,list(Surface = sum(Surface)), by=c("scenario","annee", "PERIODE2")]

parc_periode[, part := round(100*Surface/sum(Surface),0), by=c("scenario","annee")]


parc_periode_branche = parc_melted[,list(Surface = sum(Surface)), by=c("scenario","annee","branche", "periodeSimple")]
parc_periode_branche  = merge(parc_periode_branche  , COD_PERIODE_SIMPLE[, list( periodeSimple = COD_PERIODE_SIMPLE, PERIODE_SIMPLE)], 
                     by = "periodeSimple")
parc_periode_branche = merge(parc_periode_branche , COD_BRANCHE[, list( branche = COD_BRANCHE, BRANCHE)], 
                     by = "branche")

parc_periode_branche[, PERIODE2 :=PERIODE_SIMPLE]

parc_periode_branche[annee == "2010" & PERIODE_SIMPLE == "2009-2015", PERIODE2 := "1999-2009"]

parc_periode_branche[PERIODE_SIMPLE == "1999-2008", PERIODE2 := "1999-2009"]

parc_periode_branche = parc_periode_branche[,list(Surface = sum(Surface)), by=c("scenario","annee", "PERIODE2","BRANCHE")]

parc_periode_branche[, part := round(100*Surface/sum(Surface),0), by=c("scenario","annee", "BRANCHE")]
parc_periode_branche[, part_plot := 100*Surface/sum(Surface), by=c("scenario","annee", "BRANCHE")]
parc_periode_branche[, ]

```

```{r parc_periode_2010_ref, fig.width=10, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec le parc CEREN par branche', dev=c('png', 'pdf'),  fig.show='hold'}

ggplot(parc_periode[scenario %in% c(scenario_ref) & annee == "2010" & part >0], 
       aes(scenario,Surface/10^6, fill = PERIODE2)) + scale_x_discrete(label = scenariolabels)+
           geom_bar(stat="identity") +  
#           facet_wrap(~an, nrow = 1) + 
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ylab("Millions de m²")+ xlab("")+ scale_y_continuous(breaks = seq(0,1000,200), limits = c(0,1000))+
  mytheme_facet_plot + scale_fill_brewer("", palette = "Set2") 


#ggsave("../publication_thema/figures/ParcPeriode2010.pdf",width = 14, height=12)



ggplot(parc_periode_branche[scenario %in% c(scenario_ref) & annee == "2010" & part >0], 
       aes(scenario,part_plot, fill = factor(PERIODE2, levels= c("1999-2009","1981-1998","Av 1980")))) + scale_x_discrete(label ="")+
           geom_bar(stat="identity") +   
  facet_grid(~BRANCHE,label = labeller(BRANCHE = label_wrap_gen(10))) + 
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ylab("Part de la branche")+ xlab("")+ scale_y_continuous(breaks = seq(0,100,10), limits = c(0,100))+
  mytheme_facet_plot + scale_fill_brewer("", palette = "Set2") 


#ggsave("../publication_thema/figures/ParcPeriodeBranche2010.pdf",width = 18, height=12)



```

### Parc par énergie de chauffage

```{r,echo=F, warning=F,include = F}

parc_energie = parc_melted[,list(Surface = sum(Surface)), by=c("scenario","annee", "energieChauffage")]
parc_energie = merge(parc_energie , COD_ENERGIE[, list( energieChauffage = COD_ENERGIE, ENERGIE)], 
                     by = "energieChauffage")

parc_energie[, part := round(100*Surface/sum(Surface),0), by=c("scenario","annee")]
parc_energie[,ENERGIE := factor(ENERGIE, levels = color_energie$ENERGIE)]

parc_energie_branche = parc_melted[,list(Surface = sum(Surface)), by=c("scenario","annee","branche", "energieChauffage")]
parc_energie_branche  = merge(parc_energie_branche  ,COD_ENERGIE[, list( energieChauffage = COD_ENERGIE, ENERGIE)], 
                     by = "energieChauffage")

parc_energie_branche = merge(parc_energie_branche , COD_BRANCHE[, list( branche = COD_BRANCHE, BRANCHE)], 
                     by = "branche")


parc_energie_branche[, part := round(100*Surface/sum(Surface),0), by=c("scenario","annee", "BRANCHE")]
parc_energie_branche[, part_plot := 100*Surface/sum(Surface), by=c("scenario","annee", "BRANCHE")]
parc_energie_branche[,ENERGIE := factor(ENERGIE, levels = color_energie$ENERGIE)]
color_energie
```

```{r parc_energie_2010_ref, fig.width=10, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec le parc CEREN par branche', dev=c('png', 'pdf'),  fig.show='hold'}

ggplot(parc_energie[scenario %in% c(scenario_ref) & annee == "2010" & part >0], 
       aes(scenario,Surface/10^6, fill = ENERGIE)) + scale_x_discrete(label = scenariolabels)+
           geom_bar(stat="identity") +  
#           facet_wrap(~an, nrow = 1) + 
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ylab("Millions de m²")+ xlab("")+ scale_y_continuous(breaks = seq(0,1000,200), limits = c(0,1000))+
  mytheme_facet_plot + scale_fill_manual("",values=color_energie$color) 
 

#ggsave("../publication_thema/figures/ParcEnergie2010.pdf",width = 14, height=12)


ggplot(parc_energie_branche[scenario %in% c(scenario_ref) & annee == "2010" & part >0], 
       aes(scenario,part_plot, fill = ENERGIE)) + scale_x_discrete(label ="")+
           geom_bar(stat="identity") +   
  facet_grid(~BRANCHE,label = labeller(BRANCHE = label_wrap_gen(10))) + 
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ylab("Part de la branche")+ xlab("")+ scale_y_continuous(breaks = seq(0,100,10), limits = c(0,101))+
  mytheme_facet_plot + scale_fill_manual("",values=color_energie$color) 


#ggsave("../publication_thema/figures/ParcEnergieBranche2010.pdf",width = 18, height=12)

```
\pagebreak

### Comparaison avec le parc du CEREN

```{r,echo=F, warning=F,include = F}
#### vérification calage parc avec CEREN
wbCEREN <- loadWorkbook("../AME_AMS_dataDGEC/parametrage modele/Publication_donnees_CEREN_2015.xlsx", create = F)

parc_CEREN =data.table(readWorksheet(wbCEREN, sheet = "Tab_TERTIAIRE",startRow = 3,endRow = 12,header = T))

annee_CEREN = c("2010","2012","2013")
comp_parc_par_branche = dcast.data.table(parc_par_branche[annee %in% annee_CEREN  ],scenario + branche ~ annee, value.var = "surface",fun.aggregate = function(x){sum(x)/10^6})
comp_parc_par_branche = merge(comp_parc_par_branche,COD_BRANCHE[, list(branche = COD_BRANCHE, BRANCHE)],by="branche")

comp_parc_par_branche =melt(comp_parc_par_branche,id.vars = c("branche","scenario","BRANCHE"), variable.name = "an",
                            value.name = "Surf")

setnames(parc_CEREN,c("BRANCHE","1990","2000","2005","2010","2012","2013"))
parc_CEREN[,branche :=c("01","02","03","04","05","06","07","08","Total")]

parc_CEREN[, scenario:= "CEREN"]

parc_CEREN = melt(parc_CEREN, id.vars = c("BRANCHE","branche","scenario"), variable.name = "an", value.name = "Surf")

comp_parc_par_branche = rbind(comp_parc_par_branche,parc_CEREN)

# ## calage parc CEREN 2010 par branche
# calage_parc_2010 = comp_parc_par_branche[an == "2010"]
# calage_parc_2010 =dcast.data.table(calage_parc_2010,an+ branche~scenario)
# 
# calage_parc_2010[, calage := calage_parc_2010[,3]/calage_parc_2010[,5]]
# calage_parc_2010[, calage2 := calage_parc_2010[,3]/calage_parc_2010[,6]]
# #calage_parc_2010[, calage3 := calage_parc_2010[,3]/calage_parc_2010[,6]]


#### vérification calage parc avec CEREN par ener

wbCEREN <- loadWorkbook("../AME_AMS_dataDGEC/parametrage modele/Publication_donnees_CEREN_2015.xlsx", create = F)

parc_CEREN_ener =data.table(readWorksheet(wbCEREN, sheet = "Tab_TERTIAIRE",startRow = 16,endRow = 21,header = T))
parc_CEREN_ener=parc_CEREN_ener[,1:7]
setnames(parc_CEREN_ener, c("ENERGIE","1990","2000","2005","2010","2012","2013"))
parc_CEREN_ener[,ENERGIE :=c("Gaz","Fioul","Urbain+Autres","Electricité","Total")]
    

comp_parc_par_ener = dcast.data.table(parc_par_ener[annee %in% annee_CEREN  ],scenario + ENERGIE ~ annee, value.var = "surface",fun.aggregate = function(x){sum(x)/10^6})

comp_parc_par_ener=melt(comp_parc_par_ener,id.vars = c("scenario","ENERGIE"), variable.name = "an",
                            value.name = "Surf")
comp_parc_par_ener= rbind(comp_parc_par_ener,
cbind(comp_parc_par_ener[ENERGIE=="Autres",list(scenario,an)],ENERGIE ="Urbain+Autres" ,Surf=comp_parc_par_ener[ENERGIE=="Autres",Surf] + comp_parc_par_ener[ENERGIE=="Urbain",Surf])
)



parc_CEREN_ener[, scenario:= "CEREN"]

parc_CEREN_ener = melt(parc_CEREN_ener, id.vars = c("ENERGIE","scenario"), variable.name = "an", value.name = "Surf")

comp_parc_par_ener = rbind(comp_parc_par_ener,parc_CEREN_ener)
comp_parc_par_ener[,ENERGIE :=factor(ENERGIE,levels = c("Electricité","Gaz","Fioul","Urbain","Autres","Urbain+Autres","Total"))]
#     
# ## calage parc CEREN 2010 par ener
# calage_parc_ener_2010 = comp_parc_par_ener[ an == "2010"]
# calage_parc_ener_2010  =dcast.data.table(calage_parc_ener_2010 ,an+ ENERGIE~scenario)
# 
# calage_parc_ener_2010 [, calage :=calage_parc_ener_2010 [,3]/calage_parc_ener_2010 [,6]]
# 
# calage_parc_ener_2010 [, calage2 :=calage_parc_ener_2010 [,3]/calage_parc_ener_2010 [,7]]
# #calage_parc_ener_2010 [, calage3 :=calage_parc_ener_2010 [,3]/calage_parc_ener_2010 [,8]]
# 
# calage_parc_ener_2013 = comp_parc_par_ener[ an == "2013"]
# calage_parc_ener_2013  =dcast.data.table(calage_parc_ener_2013 ,an+ ENERGIE~scenario)
# 
# calage_parc_ener_2013 [, calage :=calage_parc_ener_2013 [,3]/calage_parc_ener_2013 [,6]]
# calage_parc_ener_2013 [, calage2 :=calage_parc_ener_2013 [,3]/calage_parc_ener_2013 [,7]]
# #calage_parc_ener_2013 [, calage3 :=calage_parc_ener_2013 [,3]/calage_parc_ener_2013 [,8]]

comp_parc_par_branche = merge(comp_parc_par_branche, COD_BRANCHE[,list(branche = COD_BRANCHE, branchenom =  BRANCHE )], by="branche")
```


```{r comp_parc_CEREN, fig.width=10, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec le parc CEREN par branche', dev=c('png', 'pdf'),  fig.show='hold'}

ggplot(comp_parc_par_branche[an %in% annee_CEREN & BRANCHE != "Total général"]) + 
           geom_bar(aes(scenario,Surf, fill = branchenom), stat="identity") + 
           facet_wrap(~an, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ylab("Mm²")+ xlab("")+
  mytheme_facet_plot + scale_fill_discrete("") 

```



```{r,echo=F, warning=F,include = F}
comp_parc_par_branche[, part := round(Surf/sum(Surf)*100,0), by=c("scenario","an")]
comp_parc_par_branche <- comp_parc_par_branche[order(BRANCHE),]
comp_parc_par_branche[, Surf_cum := cumsum(Surf), by=c("scenario","an")]



comp_parc_par_ener2 <- comp_parc_par_ener[!(ENERGIE %in% c("Urbain","Autres","Total"))]
comp_parc_par_ener2[,ENERGIE :=factor(ENERGIE,levels = c("Gaz","Fioul","Electricité","Urbain+Autres"))]
comp_parc_par_ener2[, part := round(Surf/sum(Surf)*100,0), by=c("scenario","an")]

comp_parc_par_ener2 <- comp_parc_par_ener2[order(ENERGIE),]
comp_parc_par_ener2[, Surf_cum := cumsum(Surf), by=c("scenario","an")]


```


```{r comp_parc_CEREN_2010_ref, fig.width=10, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec le parc CEREN par branche', dev=c('png', 'pdf'),  fig.show='hold'}

ggplot(comp_parc_par_branche[an %in% annee_CEREN & BRANCHE != "Total général" & scenario %in% c("CEREN",scenario_ref) & 
                               an == "2010"], 
       aes(scenario,Surf, fill = branchenom)) + scale_x_discrete(label = scenariolabels)+
           geom_bar(stat="identity") + 
#           facet_wrap(~an, nrow = 1) + 
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ylab("Millions de m²")+ xlab("")+ scale_y_continuous(breaks = seq(0,1000,200), limits = c(0,1000))+
  mytheme_facet_plot + scale_fill_brewer("", palette = "Set2") 


#ggsave("../publication_thema/figures/CompParcCEREN2010.pdf",width = 14, height=12)
```

```{r comp_parc_CEREN_2010, fig.width=10, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec le parc CEREN par branche', dev=c('png', 'pdf'),  fig.show='hold'}

ggplot(comp_parc_par_branche[an %in% annee_CEREN & BRANCHE != "Total général"  & 
                               an == "2010"], 
       aes(scenario,Surf, fill = branchenom)) + scale_x_discrete(label = scenariolabels)+
           geom_bar(stat="identity") + 
#           facet_wrap(~an, nrow = 1) + 
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold") +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ylab("Millions de m²")+ xlab("")+ scale_y_continuous(breaks = seq(0,1000,200), limits = c(0,1000))+
  mytheme_facet_plot + scale_fill_brewer("", palette = "Set2") 

```

```{r comp_parc_CEREN_ener, fig.width=10, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec le parc CEREN par énergie de chauffage', dev=c('png', 'pdf')}

ggplot(comp_parc_par_ener [an %in% annee_CEREN & ENERGIE != "Autres" & ENERGIE != "Urbain" & ENERGIE != "Total"]) + 
           geom_bar(aes(scenario,Surf, fill = ENERGIE), stat="identity") + 
           facet_wrap(~an, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ylab("Mm²")+xlab("")+
  mytheme_facet_plot + scale_fill_discrete("") 

```

```{r comp_parc_CEREN_ener_2010, fig.width=10, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec le parc CEREN par énergie de chauffage', dev=c('png', 'pdf')}

ggplot(comp_parc_par_ener2[an %in% annee_CEREN  & 
                               an == "2010"], 
       aes(scenario,Surf, fill = ENERGIE)) + scale_x_discrete(label = scenariolabels)+
           geom_bar(stat="identity") + 
#           facet_wrap(~an, nrow = 1) + 
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45), title  = element_text(size = 20)) + 
  ylab("Millions de m²")+ xlab("")+ scale_y_continuous(breaks = seq(0,1000,200), limits = c(0,1000))+
  mytheme_facet_plot + scale_fill_manual("",values=color_energie$color[1:4]) 

#ggsave("../publication_thema/figures/CompParcEnergieCEREN2010.pdf",width = 14, height=12)

```

\pagebreak

### Construction neuve

```{r,echo=F, warning=F,include = F}
### % d'évolution et construction neuve par branche et période 

Construction_periode = parc_melted[Type_parc ==  "N" & annee == max(as.character(annee)),list(value = sum(Surface)), by=c("scenario", "Type_parc","branche","periodeSimple")]
Construction_periode = merge(Construction_periode, COD_PERIODE_SIMPLE[,list( periodeSimple = COD_PERIODE_SIMPLE,PERIODE_SIMPLE)], by="periodeSimple")

Construction_periode = merge(Construction_periode,COD_BRANCHE[, list(branche = COD_BRANCHE, BRANCHE)],by="branche")

construction_tot=Construction_periode[, list(BRANCHE = "Total",
                                             value = sum(value)),by=c("scenario","Type_parc","PERIODE_SIMPLE")]

Construction_periode = dcast.data.table(Construction_periode, scenario + Type_parc + BRANCHE~PERIODE_SIMPLE, 
                             fun.aggregate = function(x){sum(x, na.rm = T)/10^6})
construction_tot= dcast.data.table(construction_tot, scenario + Type_parc + BRANCHE~PERIODE_SIMPLE,
                        fun.aggregate = function(x){sum(x, na.rm = T)/10^6})

Construction_periode = rbind(Construction_periode, construction_tot)


surface_n = parc_melted[,list(value = sum(Surface)), 
                        by=c("scenario","annee","branche")]
surface_n[,annee_n_plus1 := as.character(as.numeric(as.character(annee)) + 1)]
surface_n = merge(surface_n,
                  surface_n[annee %in% c(2010:2050), list(scenario,annee,branche,surf_n_plus1 =value)],
                  by.x = c("scenario","branche","annee_n_plus1"),
                  by.y = c("scenario","branche","annee"))
surface_n[,Evol_surf := surf_n_plus1/value]
surface_n[,neuf_surf := surf_n_plus1-value]

surface_n = merge(surface_n,COD_BRANCHE[, list(branche = COD_BRANCHE, BRANCHE)],by="branche")
#surface_n = dcast(surface_n, scenario+ BRANCHE~annee,value.var = "Evol_surf")
surface_n[annee == "2009"]

#### construction neuve par occupant 


surface_n_occ = parc_melted[,list(value = sum(Surface)), 
                        by=c("scenario","annee","branche","occupation")]
surface_n_occ[,annee_n_plus1 := as.character(as.numeric(as.character(annee)) + 1)]
surface_n_occ = merge(surface_n_occ,
                  surface_n_occ [annee %in% c(2010:2050), list(scenario,annee,branche,occupation,surf_n_plus1 =value)],
                  by.x = c("scenario","branche","annee_n_plus1","occupation"),
                  by.y = c("scenario","branche","annee","occupation"))
surface_n_occ[,Evol_surf := surf_n_plus1/value]
surface_n_occ[,neuf_surf := surf_n_plus1-value]

surface_n_occ = merge(surface_n_occ,COD_BRANCHE[, list(branche = COD_BRANCHE, BRANCHE)],by="branche")


surface_n_occ = surface_n_occ[, list(surf_neuf = sum(neuf_surf), surf_parc = sum( value)), by=c("scenario","annee","occupation")]
surface_n_occ[, PM_neuf_occ := surf_neuf/sum(surf_neuf),by=c("scenario","annee")]
surface_n_occ[, PM_tot_occ := surf_parc/sum(surf_parc),by=c("scenario","annee")]

PM_neuf_occ = dcast.data.table(surface_n_occ,scenario+occupation~annee,value.var = "PM_neuf_occ")
PM_tot_occ = dcast.data.table(surface_n_occ,scenario+occupation~annee,value.var = "PM_tot_occ")
```



```{r, echo=F, warning=F,}
pander(construction_tot, digits = 2, caption = "Construction neuve par période en Mm² (pour DGEC)")
```


```{r Evol_parc_partannuelle, fig.width=25, fig.height=9, echo=F, warning=F,fig.cap='Evolution du parc (en % du parc de l\'année n-1) par branche', dev=c('png', 'pdf')}

ggplot(surface_n) + 
  geom_line(aes(annee,(Evol_surf-1)*100, group = BRANCHE, color = BRANCHE), size = 2) + 
    ylab("% parc année n-1") + facet_wrap(~scenario) +
  mytheme_facet_plot + scale_fill_brewer(palette = fillpalette) +  
   scale_x_discrete(breaks = seq(2010,2050,10), labels =
                    seq(2010,2050,10))
  
```

\clearpage
\newpage 


## 2) Evolution des consommmations

### Ensemble du parc

```{r,echo=F, warning=F,include = F}
##### tableau des consos DGEC

Conso_nationale_usage = dcast.data.table(Conso, scenario + annee ~usage,fun.aggregate = function(x){sum(x)/10^9}, value.var = "value")

Conso_nationale_usage = melt(Conso_nationale_usage, id.vars = c("scenario","annee"), variable.name = "usage", value.name = "conso_tWhEF")


conso_parusage = dcast.data.table(Conso_nationale_usage[annee %in% c("2010","2013","2015","2020","2025","2030","2035","2050"),],
                                  scenario + annee ~ usage)

conso_parusage = conso_parusage[,list(Chauffage,
                                      AU_ther = sum(ECS,Cuisson,Autre),
                                      Elec_spe = sum(Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire),
                                      Clim = Climatisation,
 Total_RT=sum(Chauffage,Climatisation,ECS,Auxiliaires,Ventilation,Eclairage),                                      Total=sum(Chauffage,Climatisation,ECS,Cuisson,Autre,Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire) ), by=c("scenario","annee")]

conso_parusage = melt(conso_parusage,id.vars = c("scenario","annee"),variable.name ="usage" )

conso_parusage[, conso_mtep := value/11630*10^3]
conso_parusage[, conso := value]


conso_parusage_tWh = dcast.data.table(conso_parusage, scenario + usage ~ annee, value.var = "value")
conso_parusage_tWh = conso_parusage_tWh[order(usage),]
#conso_parusage_tWh[, scenario := substring(scenario,1,2)]


conso_parusage_mtep = dcast.data.table(conso_parusage, scenario + usage ~ annee, value.var = "conso_mtep")
conso_parusage_mtep  = conso_parusage_mtep[order(usage),]
#conso_parusage_mtep[, scenario := substring(scenario,1,2)]
annee_ref = "2010"

evolconso = conso_parusage_tWh 

evolconso = evolconso[,list(scenario, usage,
                Evol_2015 = paste0(round((get("2015")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2020 = paste0(round((get("2020")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2020 = paste0(round((get("2025")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2030 = paste0(round((get("2030")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2035 = paste0(round((get("2035")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2050 = paste0(round((get("2050")/get(annee_ref)-1)*100, digits=1), " %"))]

annee_ref2 = "2015"
evolconso2 = conso_parusage_tWh 

evolconso2 = evolconso2[,list(scenario, usage,
                Evol_2015 = paste0(round((get("2015")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2020 = paste0(round((get("2020")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2020 = paste0(round((get("2025")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2030 = paste0(round((get("2030")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2035 = paste0(round((get("2035")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2050 = paste0(round((get("2050")/get(annee_ref2)-1)*100, digits=1), " %"))]

#evolconso[, scenario := substring(scenario,1,2)]

setnames(evolconso, c("scenario", "usage",paste(annee_ref,c(15,20,25,30,35,50), sep="-")))
#♦Consotab = merge(conso_parusage_mtep,evolconso,by=c("scenario","usage"))
###
conso_parusage_ini = dcast.data.table(Conso_nationale_usage[annee %in% c("2010","2013","2015","2016","2017","2018","2019","2020","2025","2030","2035","2050"),],
                                  scenario + annee ~ usage)


conso_parusage_ini = conso_parusage_ini[,list(Chauffage,
                                      AU_ther = sum(ECS,Cuisson,Autre),
                                      Elec_spe = sum(Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire),
                                      Clim = Climatisation,
 Total_RT=sum(Chauffage,Climatisation,ECS,Auxiliaires,Ventilation,Eclairage),                                      Total=sum(Chauffage,Climatisation,ECS,Cuisson,Autre,Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire) ), by=c("scenario","annee")]

conso_parusage_ini = melt(conso_parusage_ini,id.vars = c("scenario","annee"),variable.name ="usage" )

conso_parusage_ini[, conso_mtep := value/11630*10^3]
conso_parusage_ini[, conso := value]


conso_parusage_ini_tWh = dcast.data.table(conso_parusage_ini, scenario + usage ~ annee, value.var = "value")
conso_parusage_ini_tWh = conso_parusage_ini_tWh[order(usage),]
#conso_parusage_ini_tWh[, scenario := substring(scenario,1,2)]


##### Différence de conso totales par usage par rapport à un scénario de ref

comp_conso_ref = dcast.data.table(Conso_nationale_usage[annee %in% c(2010:2021,
                                                                     "2025","2030","2035","2040","2045","2050"),],
                                  scenario + annee ~ usage)

comp_conso_ref=comp_conso_ref[,list(Chauffage,
                                      AU_ther = sum(ECS,Cuisson,Autre),
                                      Elec_spe = sum(Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire),
                                      Clim = Climatisation,
 Total_RT=sum(Chauffage,Climatisation,ECS,Auxiliaires,Ventilation,Eclairage),                                      Total=sum(Chauffage,Climatisation,ECS,Cuisson,Autre,Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire) ), by=c("scenario","annee")]

comp_conso_ref = melt(comp_conso_ref,id.vars = c("scenario","annee"),variable.name ="usage" )

comp_conso_ref[, conso_mtep := value/11630*10^3]
comp_conso_ref[, conso := value]

conso_parusage_refsansCEE = comp_conso_ref[scenario ==scenario_sansCEE] 
comp_conso_refsansCEE = comp_conso_ref[scenario !=scenario_sansCEE]
comp_conso_refsansCEE= merge(comp_conso_refsansCEE,conso_parusage_refsansCEE[,list(conso_ref = conso,conso_mtep_ref=conso_mtep,annee,usage )], by=c("annee","usage"))
comp_conso_refsansCEE[, diffconso := (conso-conso_ref)]

conso_parusage_ref = comp_conso_ref[scenario ==scenario_ref] 
comp_conso_ref = comp_conso_ref[scenario !=scenario_ref]
comp_conso_ref = merge(comp_conso_ref,conso_parusage_ref[,list(conso_ref = conso,conso_mtep_ref=conso_mtep,annee,usage )], by=c("annee","usage"))
comp_conso_ref[, diffconso := (conso-conso_ref)]



tab_diffconso_2010_2020 = comp_conso_refsansCEE[annee%in% 2014:2021]
#tab_diffconso_2010_2020 = dcast.data.table(tab_diffconso_2010_2020,usage+scenario~annee, value.var = "diffconso")
 
tab_diffconso_2010_2020 

##### Evolution des consos CEE
# Evol_consoChauff_CEE = Conso_nationale_usage[substring(scenario,1,2) %in% c("S2","S3") & usage %in% c("Chauffage"),sum(conso_tWhEF),by=c("annee","scenario", "usage") ]
# Evol_consotot_CEE = Conso_nationale_usage[substring(scenario,1,2) %in% c("S2","S3") ,sum(conso_tWhEF),by=c("annee","scenario", "usage") ]

``` 


```{r, echo=F, warning=F}
pander(conso_parusage_tWh[order(usage)], digits = 2, caption = "Bilan des consommations en tWh EF")
```

```{r Evol_Conso_tot, fig.width=25, fig.height=9, echo=F, warning=F,fig.cap='Evolution des consommations totales', dev=c('png', 'pdf')}
### consommations totales, comparaison entre scénarios 

ggplot(Conso_nationale_usage[,list(conso_tWhEF = sum(conso_tWhEF)),by=c("scenario","annee")]) + geom_line(aes(annee, conso_tWhEF, group=scenario,color= scenario), size = 3) + 
     mytheme_facet_plot  + ylab("Consommmation totale en Twh") + 
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5))  + 
  scale_y_continuous(limits = c(0,250),breaks = seq(0,250,50))


```

```{r Evol_Conso_chauffage, fig.width=25, fig.height=9, echo=F, warning=F,fig.cap='Evolution des consommations de chauffage', dev=c('png', 'pdf')}


ggplot(Conso_nationale_usage[usage=="Chauffage",list(conso_tWhEF = sum(conso_tWhEF)),by=c("scenario","annee")]) + geom_line(aes(annee, conso_tWhEF, group=scenario,color= scenario), size = 3) + 
     mytheme_facet_plot  + ylab("Consommmation totale en Twh") + 
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5))  + 
  scale_y_continuous(limits = c(0,125),breaks = seq(0,125,25))


```
\pagebreak 

```{r, echo=F, warning=F}
pander(evolconso[order(usage)], digits = 2, caption = "Evolution des consommations")
```

\pagebreak

### Consommations par usage et énergie

```{r,  echo=F, warning=F,include = F}
##### consommations nationales par énergie et type de parc 
Conso_nationale_energie_type = dcast.data.table(Conso, scenario + annee + Type_parc ~nom_energie,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")
Conso_nationale_energie_type = melt(Conso_nationale_energie_type, id.vars = c("scenario","annee", "Type_parc"), variable.name = "energie", value.name = "conso_tWhEF")

Conso_nationale_energie = Conso_nationale_energie_type[,list(conso_tWhEF = sum(conso_tWhEF)),  by=c("scenario","annee", "energie")]
Conso_nationale_energie[, scenario_short := scenario]
Conso_nationale_energie[, energie :=factor(energie, levels = c("Electricité","Gaz","Fioul", "Urbain","Autres"))]


conso_parenergie_tWh = dcast.data.table(Conso_nationale_energie[annee %in% c("2010","2013","2015","2020","2025","2030","2035","2040","2045","2050")], scenario + energie ~ annee, value.var = "conso_tWhEF")

conso_parenergie_tWh = conso_parenergie_tWh[order(energie),]

conso_parenergie_mtep = dcast.data.table(Conso_nationale_energie[annee %in% c("2010","2013","2015","2020","2025","2030","2035","2040","2045","2050")], scenario + energie ~ annee, value.var = "conso_tWhEF", fun.aggregate = function(x){sum(x)/11630*10^3})

conso_parenergie_mtep = conso_parenergie_mtep[order(energie),]

##### consommations nationales usage et type de parc 

Conso_nationale_usage_type = dcast.data.table(Conso, scenario + annee + Type_parc ~usage,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")

Conso_nationale_usage_type = melt(Conso_nationale_usage_type , id.vars = c("scenario","annee", "Type_parc"), variable.name = "usage", value.name = "conso_tWhEF")

Conso_nationale_usage_type  = Conso_nationale_usage_type [,list(conso_tWhEF = sum(conso_tWhEF)),  
                                                          by=c("scenario","annee", "Type_parc", "usage")]

Conso_nationale_usage_type_all = Conso_nationale_usage_type
Conso_nationale_usage_type = dcast.data.table(Conso_nationale_usage_type[annee %in% c("2010","2015","2020","2025","2030","2035","2040","2045","2050"),],
                                  scenario +Type_parc +  annee ~ usage)

Conso_nationale_usage_type = Conso_nationale_usage_type[,list(Chauffage,
                                      AU_usages_ther = sum(ECS,Cuisson,Autre),
                                      Elec_spe = sum(Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire),
                                      Climatisation,
 Total_RT=sum(Chauffage,Climatisation,ECS,Auxiliaires,Ventilation,Eclairage),                                      Total=sum(Chauffage,Climatisation,ECS,Cuisson,Autre,Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire) ), by=c("scenario","Type_parc","annee")]

Conso_nationale_usage_type = melt(Conso_nationale_usage_type,id.vars = c("scenario","Type_parc","annee"),variable.name ="usage" )

Conso_nationale_usage_type  =dcast(Conso_nationale_usage_type,scenario +Type_parc +usage  ~ annee  )

annee_ref = "2010"

evolconso_usage_type = data.table(Conso_nationale_usage_type)
evolconso_usage_type = evolconso_usage_type[,list(scenario, usage,Type_parc,
                Evol_2020 = paste0(round((get("2020")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2030 = paste0(round((get("2030")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2040 = paste0(round((get("2040")/get(annee_ref)-1)*100, digits=1), " %"),
                Evol_2050 = paste0(round((get("2050")/get(annee_ref)-1)*100, digits=1), " %"))]


setnames(evolconso_usage_type, c("scenario", "usage","Type_parc",paste(annee_ref,c(20,30,40,50), sep="-")))

### Evol consou totale parc neuf et ancien

surface_parc = parc_melted[,list(Surface = sum(Surface)),by=c("scenario","annee","Type_parc")]

evolconsou_usage_type = data.table(Conso_nationale_usage_type)
evolconsou_usage_type  = melt(evolconsou_usage_type ,id.vars = c("scenario","Type_parc","usage"),variable.name ="annee" )

evolconsou_usage_type = merge(evolconsou_usage_type, surface_parc,by=c("scenario","annee","Type_parc"),all.x=T)

evolconsou_usage_type[, Conso_u :=value*10^9/Surface]
evolconsou_usage_type = dcast.data.table(evolconsou_usage_type, scenario + usage + Type_parc ~ annee,value.var = "Conso_u")

evolconsou_usage_type = evolconsou_usage_type[,list(scenario, usage,Type_parc,
                                                    Evol_2010 = round((get("2010")/get(annee_ref)), digits=1),
                Evol_2020 = round((get("2020")/get(annee_ref)), digits=2),
                Evol_2030 = round((get("2030")/get(annee_ref)), digits=2),
                Evol_2040 = round((get("2040")/get(annee_ref)), digits=2),
                Evol_2050 = round((get("2050")/get(annee_ref)), digits=2))]

setnames(evolconsou_usage_type, c("scenario", "usage","Type_parc","2010","2020","2030","2040","2050"))

##### consommations nationales par énergie, usage et type de parc 
Conso_nationale_energie_type_usage = dcast.data.table(Conso, scenario + annee + Type_parc + usage ~nom_energie,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")

Conso_nationale_energie_type_usage = melt(Conso_nationale_energie_type_usage, id.vars = c("scenario","annee", "Type_parc", "usage"), variable.name = "energie", value.name = "conso_tWhEF")

Conso_nationale_energie_usage = Conso_nationale_energie_type_usage[,list(conso_tWhEF = sum(conso_tWhEF)),  by=c("scenario","annee", "energie","usage")]
Conso_nationale_energie_usage[, scenario_short := scenario]
Conso_nationale_energie_usage[, energie :=factor(energie, levels = c("Electricité","Gaz","Fioul", "Urbain","Autres"))]


##### consommations nationales par branche MEDPRO, énergie et usage

Conso_nationale_energie_branche = dcast.data.table(Conso, scenario + annee +branche+ nom_branche +Branche_MEDPRO+  usage  ~nom_energie,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")

Conso_nationale_energie_branche = melt(Conso_nationale_energie_branche, id.vars = c("scenario","annee","branche","nom_branche","Branche_MEDPRO","usage"), variable.name = "energie", value.name = "conso_tWhEF")

Conso_nationale_energie_branche[, energie :=factor(energie, levels = c("Electricité","Gaz","Fioul", "Urbain","Autres"))]

##### consommations nationales par branche, période de construction et type de parc 
Conso_nationale_energie_branche_type = dcast.data.table(Conso, scenario + annee + Type_parc +branche+ nom_branche + periodeSimple+ usage  ~nom_energie,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "value")
Conso_nationale_energie_branche_type = melt(Conso_nationale_energie_branche_type, id.vars = c("scenario","annee","branche","nom_branche","periodeSimple", "Type_parc","usage"), variable.name = "energie", value.name = "conso_tWhEF")

Conso_nationale_energie_branche_type[, scenario_short :=scenario]
Conso_nationale_energie_branche_type[, energie :=factor(energie, levels = c("Electricité","Gaz","Fioul", "Urbain","Autres"))]



```


```{r,  echo=F, warning=F,include = F}
##### Comparaison avec la cible AMS ####


#### par energie
comp_AMS = fread("../AME_AMS_dataDGEC/AMS 2018/cibleAMS.csv", dec = ",")

setnames(comp_AMS,"TWh","usage")
comp_AMS = melt.data.table(comp_AMS, id.vars = "usage", variable.name = "energie")
comp_AMS_energie <- comp_AMS[, list(Conso = sum(value)),by="energie"]
comp_AMS_energie[,scenario := "cible AMS"]

Conso_AME_energie <- Conso_nationale_energie[annee=="2050" & scenario %in% scenario_comp_AMS, list(energie,Conso = conso_tWhEF, scenario),]
comp_AMS_energie[,energie :=as.character(energie)]
Conso_AME_energie[,energie :=as.character(energie)]

comp_AMS_energie = rbind(comp_AMS_energie,Conso_AME_energie)
comp_AMS_energie[, scenario := factor(scenario, levels = c("cible AMS",wbname))]

comp_AMS_usage = comp_AMS[, list(Conso = sum(value)),by="usage"]
comp_AMS_usage[,scenario := "cible AMS"]


Conso_AME_usage = Conso_nationale_usage[annee=="2050" & scenario %in% scenario_comp_AMS, list(usage,Conso = conso_tWhEF, scenario),]
Conso_AME_usage[usage %in% c("Chauffage","ECS","Cuisson") == F, usage:="Autres usages"]
Conso_AME_usage =Conso_AME_usage[ , list(Conso = sum(Conso)),by=c("usage","scenario")]

#### par usage
comp_AMS_usage = rbind(comp_AMS_usage,Conso_AME_usage)
comp_AMS_usage = comp_AMS_usage[order(usage)]
comp_AMS_usage[,Conso_cum := cumsum(Conso), by="scenario"]
comp_AMS_usage[,usage:=factor(usage,levels = c("Autres usages","Cuisson","ECS","Chauffage"))]
comp_AMS_usage = comp_AMS_usage[order(usage)]

comp_AMS_usage[, scenario := factor(scenario, levels = c("cible AMS",wbname))]

#### par energie et usage
comp_AMS_usage_energie = comp_AMS[, list(Conso = sum(value)),by=c("usage","energie")]
comp_AMS_usage_energie[,scenario := "cible AMS"]

Conso_AME_usage_energie = Conso_nationale_energie_usage[annee=="2050" &  scenario %in% scenario_comp_AMS, list(usage, energie,Conso = conso_tWhEF, scenario),]

Conso_AME_usage_energie[usage %in% c("Chauffage","ECS","Cuisson") == F, usage:="Autres usages"]
Conso_AME_usage_energie  =Conso_AME_usage_energie[ , list(Conso = sum(Conso)),by=c("usage","energie","scenario")]
comp_AMS_usage_energie[,energie :=as.character(energie)]
Conso_AME_usage_energie[,energie :=as.character(energie)]
  
comp_AMS_usage_energie  = rbind(comp_AMS_usage_energie ,Conso_AME_usage_energie )
comp_AMS_usage_energie  = comp_AMS_usage_energie [order(usage)]
comp_AMS_usage_energie[,Conso_cum := cumsum(Conso), by=c("scenario","usage")]
comp_AMS_usage_energie[,usage:=factor(usage,levels = c("Autres usages","Cuisson","ECS","Chauffage"))]
comp_AMS_usage_energie = comp_AMS_usage_energie[order(usage)]

comp_AMS_usage_energie[, scenario := factor(scenario, levels = c("cible AMS",wbname))]

if(write_excel==T){
write.table(comp_AMS_usage_energie[scenario==scenario_toexport],file = paste0(wbdir_scenario_toexport,"comp_cibleAMS_usage_energie.csv"),quote = F,sep=";",row.names = F, dec=",")
}

##### Comparaison avec la cible AMS avec chaleur ####

# 
# #### par energie
# comp_AMS2 = fread("../AME_AMS_dataDGEC/AMS 2018/cibleAMSavecchaleur.csv", dec = ",")
# 
# setnames(comp_AMS,"TWh","usage")
# comp_AMS = melt.data.table(comp_AMS, id.vars = "usage", variable.name = "energie")
# comp_AMS_energie <- comp_AMS[, list(Conso = sum(value)),by="energie"]
# comp_AMS_energie[,scenario := "cible AMS"]
# 
# Conso_AME_energie <- Conso_nationale_energie[annee=="2050" & scenario %in% scenario_comp_AMS, list(energie,Conso = conso_tWhEF, scenario),]
# comp_AMS_energie[,energie :=as.character(energie)]
# Conso_AME_energie[,energie :=as.character(energie)]
# 
# comp_AMS_energie = rbind(comp_AMS_energie,Conso_AME_energie)
# 
# 
# comp_AMS_usage = comp_AMS[, list(Conso = sum(value)),by="usage"]
# comp_AMS_usage[,scenario := "cible AMS"]
# 
# 
# Conso_AME_usage = Conso_nationale_usage[annee=="2050" & scenario %in% scenario_comp_AMS, list(usage,Conso = conso_tWhEF, scenario),]
# Conso_AME_usage[usage %in% c("Chauffage","ECS","Cuisson") == F, usage:="Autres usages"]
# Conso_AME_usage =Conso_AME_usage[ , list(Conso = sum(Conso)),by=c("usage","scenario")]
# 
# #### par usage
# comp_AMS_usage = rbind(comp_AMS_usage,Conso_AME_usage)
# comp_AMS_usage = comp_AMS_usage[order(usage)]
# comp_AMS_usage[,Conso_cum := cumsum(Conso), by="scenario"]
# comp_AMS_usage[,usage:=factor(usage,levels = c("Autres usages","Cuisson","ECS","Chauffage"))]
# comp_AMS_usage = comp_AMS_usage[order(usage)]
# 
# #### par energie et usage
# comp_AMS_usage_energie = comp_AMS[, list(Conso = sum(value)),by=c("usage","energie")]
# comp_AMS_usage_energie[,scenario := "cible AMS"]
# 
# Conso_AME_usage_energie = Conso_nationale_energie_usage[annee=="2050" &  scenario %in% scenario_comp_AMS, list(usage, energie,Conso = conso_tWhEF, scenario),]
# 
# Conso_AME_usage_energie[usage %in% c("Chauffage","ECS","Cuisson") == F, usage:="Autres usages"]
# Conso_AME_usage_energie  =Conso_AME_usage_energie[ , list(Conso = sum(Conso)),by=c("usage","energie","scenario")]
# comp_AMS_usage_energie[,energie :=as.character(energie)]
# Conso_AME_usage_energie[,energie :=as.character(energie)]
#   
# comp_AMS_usage_energie  = rbind(comp_AMS_usage_energie ,Conso_AME_usage_energie )
# comp_AMS_usage_energie  = comp_AMS_usage_energie [order(usage)]
# comp_AMS_usage_energie[,Conso_cum := cumsum(Conso), by=c("scenario","usage")]
# comp_AMS_usage[,usage:=factor(usage,levels = c("Autres usages","Cuisson","ECS","Chauffage"))]
# comp_AMS_usage = comp_AMS_usage[order(usage)]
# 
# if(write_excel==T){
# write.table(comp_AMS_usage_energie[scenario==scenario_toexport],file = paste0(wbdir_scenario_toexport,"comp_cibleAMS_usage_energie.csv"),quote = F,sep=";",row.names = F, dec=",")
# }



```



```{r Evol_conso_energie, fig.width=20, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}
###### graph conso par énergie ######

ggplot(Conso_nationale_energie[annee %in% c("2010",annee_MEDPRO)]) + 
           geom_bar(aes(scenario_short,conso_tWhEF, fill = energie, color = energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1), title  = element_text(size = 20)) + 
  ggtitle("Consommations pour tous les usages et l'ensemble du parc par énergie (tWh, énergie finale)") + ylab("tWh")+
  mytheme_facet_plot

```


```{r Evol_conso_usage, fig.width=20, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}
###### graph conso par usage ######

ggplot(Conso_nationale_energie_usage[annee %in% c("2010",annee_MEDPRO)]) + 
           geom_bar(aes(scenario_short,conso_tWhEF, fill = usage, color = usage), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1), title  = element_text(size = 20)) + 
  ggtitle("Consommations pour tous les usages et l'ensemble du parc par usage (tWh, énergie finale)") + ylab("tWh")+
  mytheme_facet_plot + theme(legend.position="top")

```


```{r Evol_conso_chauffage_type, fig.width=20, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}
###### graph conso par chauffage par type de parc ######

ggplot(Conso_nationale_usage_type_all[usage == "Chauffage"]) + 
           geom_line(aes(annee,conso_tWhEF, color =Type_parc,group = Type_parc)) + 
           facet_wrap(~scenario, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1), title  = element_text(size = 20)) + 
    scale_x_discrete(breaks = c("2010","2015","2020","2025","2030","2035","2040","2045","2050"))+
  ggtitle("Consommations de chauffage par type de parc (tWh, énergie finale)") + ylab("tWh")+
  mytheme_facet_plot

```

```{r Evol_conso_energie_usageRT, fig.width=20, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}
###### graph conso par énergie ######

ggplot(Conso_nationale_energie_usage[annee %in% c("2010",annee_MEDPRO) & usage %in% c("Chauffage","ECS","Auxiliaires","Ventilation","Eclairage"), list(conso_tWhEF = sum(conso_tWhEF)), by=c("scenario_short","annee","energie")]) + 
           geom_bar(aes(scenario_short,conso_tWhEF, fill = energie, color = energie), stat="identity") + 
           facet_wrap(~annee , nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1), title  = element_text(size = 20)) + 

  ggtitle("Consommations pour les usages RT et l'ensemble du parc par énergie (tWh, énergie finale)") + ylab("tWh")+
  mytheme_facet_plot

```

```{r,  echo=F, warning=F,include = F}
dcast.data.table(Conso_nationale_energie_branche_type[Type_parc == "E" & usage == "Chauffage"], scenario + nom_branche  ~ annee,fun.aggregate = sum, value.var = "conso_tWhEF")


```

```{r Evol_conso_branche, fig.width=20, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}
###### graph conso par branche pour le chauffage ######

ggplot(Conso_nationale_energie_branche_type[Type_parc == "E" & usage == "Chauffage", list(conso_tWhEF=sum(conso_tWhEF)), by=c("scenario","nom_branche","annee")]) + 
           geom_line(aes(annee,conso_tWhEF, color = scenario, group = scenario)) + facet_wrap(~nom_branche)+
  theme(axis.text.x = element_text(size = 12, hjust = 1), title  = element_text(size = 20)) + 
  ggtitle("Consommations pour le chauffage pour le parc existant par branche)") + ylab("tWh")+
  mytheme_facet_plot

```
\pagebreak


### Comparaison avec le CEREN 2010-2015


```{r,  echo=F, warning=F,include = F}

#### vérification calage conso avec CEREN

ceren_details <- fread("../../Data/CEREN/exportCEREN_Branche_usage_energie_tertiaire.csv",sep=";", header=T, dec=",")


ceren_details_melt <- melt(ceren_details, id.vars = c("BRANCHE","ENERGIE","USAGE"),variable.name = "annee",value.name = "conso_GWhEF")
ceren_details_melt [,scenario:="CEREN"]

annee_CEREN_details <- as.character(unique(ceren_details_melt$annee))

##### comparaison par energie, conso totales

consotot_energie_CEREN =ceren_details_melt[, list(conso_tWhEF = sum(conso_GWhEF)/10^3),by=c("scenario","annee","ENERGIE")]
setnames(consotot_energie_CEREN, "ENERGIE","energie")
consotot_energie_CEREN [,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité",  "Autres comb."))]


comp_consoCEREN_energie = Conso_nationale_energie[annee%in%c(annee_CEREN_details)]
comp_consoCEREN_energie[, scenario_short := NULL]


comp_consoCEREN_energie[,energie2 := energie]
comp_consoCEREN_energie[energie=="Autres" | energie=="Urbain",energie2 := "Autres comb."]

comp_consoCEREN_energie <- comp_consoCEREN_energie[, list(conso_tWhEF = sum(conso_tWhEF )),by=c("scenario","annee", "energie2")]
setnames(comp_consoCEREN_energie, "energie2","energie")
comp_consoCEREN_energie[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité",  "Autres comb."))]

comp_consoCEREN_energie =rbind(comp_consoCEREN_energie  ,consotot_energie_CEREN[annee%in%as.character(2009:2015)])

comp_consoCEREN_energie[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité",  "Autres comb."))]



##### comparaison par energie, et usage

conso_energie_usage_CEREN =ceren_details_melt[, list(conso_tWhEF = sum(conso_GWhEF)/10^3),by=c("scenario","annee","ENERGIE","USAGE")]

setnames(conso_energie_usage_CEREN, "ENERGIE","energie")
setnames(conso_energie_usage_CEREN, "USAGE","usage")

conso_energie_usage_CEREN[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité",  "Autres comb."))]


comp_consoCEREN_energie_usage = Conso_nationale_energie_usage[annee%in%c(annee_CEREN_details)]
comp_consoCEREN_energie_usage [, scenario_short := NULL]


comp_consoCEREN_energie_usage[,energie2 := energie]
comp_consoCEREN_energie_usage[energie=="Autres" | energie=="Urbain",energie2 := "Autres comb."]

comp_consoCEREN_energie_usage[,usage2:=usage]
comp_consoCEREN_energie_usage[usage %in% c("Autre"), usage2 := "Autres usages thermiques"]
comp_consoCEREN_energie_usage[usage %in% c("Bureautique","Eclairage","Froid_alimentaire", "Process"), usage2 := "Electricité spécifique"]
comp_consoCEREN_energie_usage[usage %in% c("Ventilation", "Climatisation","Auxiliaires"), usage2 := "Climatisation"]



comp_consoCEREN_energie_usage <- comp_consoCEREN_energie_usage[, list(conso_tWhEF = sum(conso_tWhEF )),by=c("scenario","annee", "energie2", "usage2")]
setnames(comp_consoCEREN_energie_usage, "energie2","energie")
setnames(comp_consoCEREN_energie_usage, "usage2","usage")

comp_consoCEREN_energie_usage[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité",  "Autres comb."))]

comp_consoCEREN_energie_usage =rbind(comp_consoCEREN_energie_usage  ,conso_energie_usage_CEREN[annee%in%as.character(2009:2015)])

comp_consoCEREN_energie[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité",  "Autres comb."))]


conso_energie_usage_CEREN[annee%in%as.character(2009:2015) & usage == "Chauffage", sum(conso_tWhEF), by="annee"]
# ## calage conso CEREN 2010 par ener
# calage_conso_ener_2010 = comp_consoCEREN[ annee == "2010"]
# calage_conso_ener_2013 = comp_consoCEREN[ annee == "2013"]
# calage_conso_ener_2010 =dcast.data.table(calage_conso_ener_2010 ,annee+ energie~scenario)
# calage_conso_ener_2013 =dcast.data.table(calage_conso_ener_2013 ,annee+ energie~scenario)
# 
# 
# calage_conso_ener_2010[, calage :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,5]]
# calage_conso_ener_2010[, calage2 :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,6]]
#  calage_conso_ener_2010[, calage3 :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,7]]
# # calage_conso_ener_2010[, calage4 :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,10]]
# # calage_conso_ener_2010[, calage5 :=calage_conso_ener_2010[,3]/calage_conso_ener_2010[,11]]
# 
# calage_conso_ener_2013[, calage :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,5]]
# calage_conso_ener_2013[, calage2 :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,6]]
#  calage_conso_ener_2013[, calage3 :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,7]]
# # calage_conso_ener_2013[, calage4 :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,10]]
# # calage_conso_ener_2013[, calage5 :=calage_conso_ener_2013[,3]/calage_conso_ener_2013[,11]]
# 
# calage_conso_ener_2010
# calage_conso_ener_2013
# 
# sum(calage_conso_ener_2010[c(1:3,6),3])
# #sum(calage_conso_ener_2010[c(1:3,6),12])
# sum(calage_conso_ener_2013[c(1:3,6),3])
# #sum(calage_conso_ener_2013[c(1:3,6),12])


### verif conso chauffage
consochauff_CEREN =data.table(readWorksheet(wbCEREN, sheet = "Tab_TERTIAIRE",startRow = 60,endRow = 65,header = T))
consochauff_CEREN = consochauff_CEREN[,1:8]
comp_consoChauffCEREN = Conso_nationale_energie_usage[annee%in%c(annee_CEREN,"2015") & usage == "Chauffage"]
comp_consoChauffCEREN[, scenario_short := NULL]
comp_consoChauffCEREN[, usage := NULL]
comp_consoChauffCEREN = rbind(comp_consoChauffCEREN,
cbind(comp_consoChauffCEREN[energie=="Autres",list(scenario,annee)],energie ="Urbain+Autres" ,conso_tWhEF=comp_consoChauffCEREN[energie=="Autres",conso_tWhEF] + comp_consoChauffCEREN[energie=="Urbain",conso_tWhEF])
)



setnames(consochauff_CEREN, c("energie","1990","2000","2005","2010","2012","2013","2015"))

consochauff_CEREN[,energie :=c("Gaz","Fioul", "Urbain+Autres","Electricité", "Total")]
consochauff_CEREN[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité","Urbain", "Autres", "Urbain+Autres"))]

consochauff_CEREN = melt(consochauff_CEREN,id.vars = "energie",variable.name = "annee",value.name = "conso_tWhEF")
consochauff_CEREN[,scenario :="CEREN"]

comp_consoChauffCEREN  =rbind(comp_consoChauffCEREN ,consochauff_CEREN[energie!="Total" & annee %in% c(annee_CEREN,"2015")])

comp_consoChauffCEREN [,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité","Urbain", "Autres", "Urbain+Autres"))]

# ## calage conso chauff  CEREN 2010 par ener
# calage_consoChauff_ener_2010 = comp_consoChauffCEREN[ annee == "2010"]
# calage_consoChauff_ener_2013 = comp_consoChauffCEREN[ annee == "2013"]
# calage_consoChauff_ener_2010 =dcast.data.table(calage_consoChauff_ener_2010 ,annee+ energie~scenario)
# calage_consoChauff_ener_2013 =dcast.data.table(calage_consoChauff_ener_2013 ,annee+ energie~scenario)
# 
# calage_consoChauff_ener_2010[, calage :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,5]]
# calage_consoChauff_ener_2010[, calage2 :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,6]]
#  calage_consoChauff_ener_2010[, calage3 :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,7]]
# # calage_consoChauff_ener_2010[, calage4 :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,10]]
# # calage_consoChauff_ener_2010[, calage5 :=calage_consoChauff_ener_2010[,3]/calage_consoChauff_ener_2010[,11]]
# 
# 
# 
# calage_consoChauff_ener_2013[, calage :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,5]]
# calage_consoChauff_ener_2013[, calage2 :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,6]]
#  calage_consoChauff_ener_2013[, calage3 :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,7]]
# # calage_consoChauff_ener_2013[, calage4 :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,10]]
# # calage_consoChauff_ener_2013[, calage5 :=calage_consoChauff_ener_2013[,3]/calage_consoChauff_ener_2013[,11]]
# 
# calage_consoChauff_ener_2010
# 
# calage_consoChauff_ener_2013

# sum(calage_consoChauff_ener_2010[c(1:3,6),3])
# #sum(calage_consoChauff_ener_2010[c(1:3,6),12])
# sum(calage_consoChauff_ener_2013[c(1:3,6),3])
# #sum(calage_consoChauff_ener_2013[c(1:3,6),12])

### verif conso unitaire chauffage
# calage_consoChauff_ener_2010
# calage_parc_ener_2010

# calage_consouChauff_2010 = merge(melt(calage_consoChauff_ener_2010, id.vars = c("annee","energie"), 
#      variable.name = "scenario",value.name = "ConsoTwhEF"), 
#      melt(calage_parc_ener_2010, id.vars = c("an","ENERGIE"), 
#      variable.name = "scenario",value.name = "SurfaceMm2"),  
#      by.x = c("annee","energie", "scenario"), by.y = c("an","ENERGIE", "scenario"))
#     
# calage_consouChauff_2010[, ConsoU := ConsoTwhEF*10^3/SurfaceMm2]
# 
# calage_consouChauff_2010 = data.table(dcast(calage_consouChauff_2010, annee + energie ~ scenario, value.var = "ConsoU" ))

# calage_consouChauff_2010
# calage_consouChauff_2010[, calage :=calage_consouChauff_2010[,3]/calage_consouChauff_2010[,5]]
# calage_consouChauff_2010[, calage2 :=calage_consouChauff_2010[,3]/calage_consouChauff_2010[,6]]
# # calage_consouChauff_2010[, calage3 :=calage_consouChauff_2010[,3]/calage_consouChauff_2010[,9]]
# # calage_consouChauff_2010[, calage4 :=calage_consouChauff_2010[,3]/calage_consouChauff_2010[,10]]
# 
# calage_consouChauff_2013 = merge(melt(calage_consoChauff_ener_2013, id.vars = c("annee","energie"), 
#      variable.name = "scenario",value.name = "ConsoTwhEF"), 
#      melt(calage_parc_ener_2013, id.vars = c("an","ENERGIE"), 
#      variable.name = "scenario",value.name = "SurfaceMm2"),  
#      by.x = c("annee","energie", "scenario"), by.y = c("an","ENERGIE", "scenario"))
#     
# calage_consouChauff_2013[, ConsoU := ConsoTwhEF*10^3/SurfaceMm2]
# 
# calage_consouChauff_2013 = data.table(dcast(calage_consouChauff_2013, annee + energie ~ scenario, value.var = "ConsoU" ))

# calage_consouChauff_2013
# calage_consouChauff_2013[, calage :=calage_consouChauff_2013[,3]/calage_consouChauff_2013[,5]]
# calage_consouChauff_2013[, calage2 :=calage_consouChauff_2013[,3]/calage_consouChauff_2013[,6]]
# calage_consouChauff_2013[, calage3 :=calage_consouChauff_2013[,3]/calage_consouChauff_2013[,9]]
# calage_consouChauff_2013[, calage4 :=calage_consouChauff_2013[,3]/calage_consouChauff_2013[,10]]

consou_ener = merge(Conso_nationale_energie_branche_type[usage == "Chauffage",sum(conso_tWhEF), by=c("energie","annee","Type_parc")], 
      merge(parc_melted, COD_ENERGIE, by.x = c("energieChauffage"), by.y=c("COD_ENERGIE"))[,sum(Surface), by=c("ENERGIE","annee","Type_parc")]
      ,
      by.x=c("energie","annee","Type_parc"), by.y=c("ENERGIE","annee","Type_parc"))
consou_ener[,Consou :=  V1.x*10^9/ V1.y]
tmp = dcast(consou_ener,Type_parc + energie ~ annee,value.var = "Consou")
tmp[,9]/tmp[,4]

# ### verif conso autres usages 
# calage_consoAutres_ener_2010 = cbind(calage_conso_ener_2010[,1:2],calage_conso_ener_2010[,c("CEREN",wbname),with=F] - calage_consoChauff_ener_2010[,c("CEREN",wbname), with=F])
# calage_consoAutres_ener_2013 = cbind(calage_conso_ener_2013[,1:2],calage_conso_ener_2013[,c("CEREN",wbname),with=F] - calage_consoChauff_ener_2013[,c("CEREN",wbname), with=F])
# 
# 
# calage_consoAutres_ener_2010[, calage :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,5]]
# calage_consoAutres_ener_2010[, calage2 :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,6]]
# calage_consoAutres_ener_2010[, calage3 :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,7]]
# calage_consoAutres_ener_2010[, calage4 :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,10]]
# calage_consoAutres_ener_2010[, calage5 :=calage_consoAutres_ener_2010[,3]/calage_consoAutres_ener_2010[,11]]


consochauff_CEREN[,energie :=factor(energie,levels = c("Gaz","Fioul", "Electricité","Urbain", "Autres", "Urbain+Autres"))]
Conso_nationale_energie[annee %in% c("2010","2013","2015","2020","2030")]

#### conso par branche

consotot_branche_CEREN = ceren_details_melt[, list(conso_tWhEF = sum(conso_GWhEF)/10^3),by=c("scenario","annee","BRANCHE")]
setnames(consotot_branche_CEREN, "BRANCHE","nom_branche")

comp_consoCEREN_branche = Conso_nationale_energie_branche[annee%in%c(annee_CEREN_details), list( conso_tWhEF = sum( conso_tWhEF)), by=c("scenario","annee","nom_branche")]

comp_consoCEREN_branche =rbind(comp_consoCEREN_branche  ,consotot_branche_CEREN[annee%in%as.character(2009:2015)])


##### modif pour les graphes 

comp_consoCEREN_energie[,part :=round(100*conso_tWhEF/sum(conso_tWhEF), 0),by=c("scenario","annee")]
comp_consoCEREN_energie_usage[,part := NULL]
comp_consoCEREN_energie_usage[usage == "Chauffage",part :=  paste0(round(100*conso_tWhEF/sum(conso_tWhEF), 0)," %"),by=c("scenario","annee", "usage")]
comp_consoCEREN_energie_usage[usage != "Chauffage", part := "",by=c("scenario","annee", "usage")]

comp_consoCEREN_energie_usage[, usage := factor(usage, levels = c("Chauffage","ECS","Cuisson","Autres usages thermiques","Climatisation","Electricité spécifique"))]

comp_consoCEREN_branche[,part := round(100*conso_tWhEF/sum(conso_tWhEF), 0),by=c("scenario","annee")]

comp_consoCEREN_usage = comp_consoCEREN_energie_usage[, 
                                     list(conso_tWhEF = sum(conso_tWhEF)), by=c("scenario", "annee","usage")]

comp_consoCEREN_usage[,part := round(100*conso_tWhEF/sum(conso_tWhEF), 0),by=c("scenario","annee")]


```


```{r comp_conso_CEREN, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations totales du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie ) + 
           geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) +
  
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWh")+
  mytheme_facet_plot + xlab("")


```

```{r comp_conso_CEREN_2010, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations totales du CEREN 2010', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie[annee == "2010"],aes(scenario,conso_tWhEF, fill = energie) ) + 
           geom_bar(stat="identity") + 
#           facet_wrap(~annee, nrow = 1) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("TWh")+
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7)+
  mytheme_facet_plot + xlab("") + scale_fill_manual("", values = color_energie$color[1:4]) +
   scale_x_discrete(label = scenariolabels)

#ggsave("../publication_thema/figures/CompConsoTot2010.pdf",width = 10, height=12)

```

```{r comp_conso_CEREN_usage_2010, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations totales du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie_usage[annee == "2010"],aes(scenario,conso_tWhEF, fill = energie) ) + 
           geom_bar(stat="identity") + 
           facet_wrap(~usage, nrow = 1, label = labeller(usage = label_wrap_gen(10))) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("TWh")+
  geom_text(aes(label=part),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7)+
  mytheme_facet_plot + xlab("") + scale_fill_manual("", values = color_energie$color[1:4]) +
   scale_x_discrete(label = scenariolabels) + scale_y_continuous(breaks = seq(0,100,20),limits =c(0,100))

#ggsave("../publication_thema/figures/CompConsousage2010.pdf",width = 14, height=12)

```

```{r comp_consochauff_CEREN, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations de chauffage du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie_usage[usage=="Chauffage"]) + 
           geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWh")+
  mytheme_facet_plot + xlab("")

```



```{r comp_consECS_CEREN, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations d\'ECS du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie_usage[usage=="ECS"]) + 
           geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWh")+
  mytheme_facet_plot + xlab("")

```

```{r comp_consCuisson_CEREN, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations de cuisson du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie_usage[usage=="Cuisson"]) + 
           geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWh")+
  mytheme_facet_plot + xlab("")

```




```{r comp_consclim_CEREN, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations de Climatisation du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie_usage[usage=="Climatisation"]) + 
           geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWh")+
  mytheme_facet_plot + xlab("")

```

```{r comp_consElecspe_CEREN, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations spécifiques du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie_usage[usage=="Electricité spécifique"]) + 
           geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWh")+
  mytheme_facet_plot + xlab("")

```

```{r comp_consAutresth_CEREN, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations des autres usages thermiques du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie_usage[usage=="Autres usages thermiques"]) + 
           geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWh")+
  mytheme_facet_plot + xlab("")

```

```{r comp_consAutres, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations hors chauffage et ECS du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_energie_usage[usage%in%c("Autres usages thermiques","Cuisson","Climatisation", "Electricité spécifique")]) + geom_bar(aes(scenario,conso_tWhEF, fill = energie, color =  energie), stat="identity") + 
           facet_wrap(~annee, nrow = 1) + 
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("tWh")+
  mytheme_facet_plot + xlab("")

```

```{r comp_conso_CEREN_branche_2010, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Comparaison avec les consommations par branche du CEREN', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_branche[annee == "2010"],aes(scenario,conso_tWhEF, fill = nom_branche) ) + 
           geom_bar(stat="identity") + 
#           facet_wrap(~usage, nrow = 1, label = labeller(usage = label_wrap_gen(10))) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("TWh")+
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7)+
  mytheme_facet_plot + xlab("") + scale_fill_brewer("", palette = "Set2")  +
   scale_x_discrete(label = scenariolabels) + scale_y_continuous(breaks = seq(0,250,50),limits =c(0,250))

#ggsave("../publication_thema/figures/CompConsobranche2010.pdf",width = 14, height=12)

```

```{r conso_branche_2010, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Consommations par branche 2010', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_branche[annee == "2010" & scenario == scenario_ref],aes(scenario,conso_tWhEF, fill = nom_branche) ) + 
           geom_bar(stat="identity") + 
#           facet_wrap(~usage, nrow = 1, label = labeller(usage = label_wrap_gen(10))) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("TWh")+
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7)+
  mytheme_facet_plot + xlab("") + scale_fill_brewer("", palette = "Set2")  +
   scale_x_discrete(label = scenariolabels) + scale_y_continuous(breaks = seq(0,250,50),limits =c(0,250))

#ggsave("../publication_thema/figures/Consobranche2010.pdf",width =7 , height=12)

```

```{r conso_usage_2010, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Consommations par usage 2010', dev=c('png', 'pdf')}

ggplot(comp_consoCEREN_usage[annee == "2010" & scenario == scenario_ref,],
       aes(scenario,conso_tWhEF, fill = usage))+ 
           geom_bar(stat="identity") + 
#           facet_wrap(~usage, nrow = 1, label = labeller(usage = label_wrap_gen(10))) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("TWh")+
  geom_text(aes(label=paste0(part, " %")),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7)+
  mytheme_facet_plot + xlab("") + scale_fill_brewer("", palette = "Set2")  +
   scale_x_discrete(label = scenariolabels) + scale_y_continuous(breaks = seq(0,250,50),limits =c(0,250))

#ggsave("../publication_thema/figures/ConsoUsage2010.pdf",width = 7, height=12)

```

\clearpage
\pagebreak
\pagebreak

### Comparaison avec la cible AMS
```{r comp_cible_AMS_energie, fig.width=10, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}


ggplot(comp_AMS_energie) + 
           geom_bar(aes(scenario,Conso, fill = energie, color = energie), stat="identity")  + 
  theme(axis.text.x = element_text(size = 12, hjust = 1), title  = element_text(size = 20)) + 
  ggtitle("") + ylab("TWh")+
  mytheme_facet_plot

```

```{r comp_cible_AMS_usage, fig.width=10, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}


ggplot(comp_AMS_usage) + 
           geom_bar(aes(scenario,Conso, fill = usage, color = usage), stat="identity")  + 
  theme(axis.text.x = element_text(size = 12, hjust = 1), title  = element_text(size = 20)) + 
  ggtitle("") + ylab("TWh")+ geom_text(aes(scenario,Conso_cum,label=round(Conso, digits= 1)), vjust = +1.5, color = "white")+
  mytheme_facet_plot


ggplot(comp_AMS_usage[scenario != "cible AMS"]) + 
           geom_bar(aes(scenario,Conso, fill = usage, color = usage), stat="identity")  + 
  theme(axis.text.x = element_text(size = 20, hjust = 1), title  = element_text(size = 20)) + 
  ggtitle("") + ylab("TWh")+ geom_text(aes(scenario,Conso_cum,label=round(Conso, digits= 0)), size = 8,
                                       vjust = +1.5, color = "white")+
  mytheme_facet_plot


ggsave("../publication_thema/présentation/Conso_2050.png",width = 14, height=12)

```



```{r comp_cible_AMS_energie_chauffage, fig.width=10, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}


ggplot(comp_AMS_usage_energie) + 
           geom_bar(aes(scenario,Conso, fill = energie, color = energie), stat="identity")  + 
  theme(axis.text.x = element_text(size = 12, hjust = 1), title  = element_text(size = 20)) + 
  facet_wrap(~usage) +
  ggtitle("") + ylab("TWh")+
  mytheme_facet_plot

```

\clearpage
\pagebreak

## 3) Parts de marchés des systèmes et des énergies de chauffage (Surfaces)


### PM des énergies dans le neuf

```{r,echo=F, warning=F,include = F}
### PM des énergies dans le neuf


PM_energie_neuf = PM[Type_parc ==  "N", list(Surf_neuf_n = sum(surface)),by=c("scenario", "Type_parc","energieChauffage","periodeSimple","annee")] 

PM_energie_neuf[, annee_n1 := as.factor(as.numeric(as.character(annee)) -1)]

PM_energie_neuf = merge(PM_energie_neuf,
                        PM_energie_neuf[,list(scenario,Type_parc,annee,energieChauffage,periodeSimple,Surf_neuf_n1 = Surf_neuf_n )], 
                        by.x=c("scenario", "Type_parc","energieChauffage","periodeSimple","annee_n1"), 
                        by.y=c("scenario", "Type_parc","energieChauffage","periodeSimple","annee"),all.x=T)

PM_energie_neuf[(annee %in% 2010& periodeSimple=="04")|(annee %in% 2016 & periodeSimple=="05")|(annee %in% 2021 & periodeSimple=="06")|(annee %in% 2031 & periodeSimple=="07")|(annee %in% 2041 & periodeSimple=="08"), Surf_neuf_n1:=0] 



PM_energie_neuf[,surf_cons_n := Surf_neuf_n - Surf_neuf_n1]
PM_energie_neuf[, PM_ener_neuf := surf_cons_n/sum(surf_cons_n),by=c("scenario", "Type_parc","periodeSimple","annee")]

PM_energie_neuf = PM_energie_neuf[(annee %in% 2010:2015 & periodeSimple=="04")|(annee %in% 2016:2020 & periodeSimple=="05")|
                                    (annee %in% 2021:2030 & periodeSimple=="06")|(annee %in% 2031:2040 & periodeSimple=="07")|(annee %in% 2041:2050 & periodeSimple=="08")] 
PM_energie_neuf[,sum(PM_ener_neuf), by="annee"]

PM_energie_neuf = merge(PM_energie_neuf,COD_ENERGIE[, list(energieChauffage =  COD_ENERGIE, Energie = ENERGIE)], by="energieChauffage")


### PM energie anciennes sorties

PM_energie_neuf2 = parc_melted[Type_parc ==  "N" & (scenario %in% unique(PM_energie_neuf$scenario) == F), list(Surf_neuf_n = sum(Surface)),by=c("scenario", "Type_parc","energieChauffage","periodeSimple","annee")] 

PM_energie_neuf2[, annee_n1 := as.factor(as.numeric(as.character(annee)) -1)]

PM_energie_neuf2= merge(PM_energie_neuf2,
                       PM_energie_neuf2[,list(scenario,Type_parc,annee,energieChauffage,periodeSimple,Surf_neuf_n1 = Surf_neuf_n )], 
                        by.x=c("scenario", "Type_parc","energieChauffage","periodeSimple","annee_n1"), 
                        by.y=c("scenario", "Type_parc","energieChauffage","periodeSimple","annee"),all.x=T)

PM_energie_neuf2[(annee %in% 2010& periodeSimple=="04")|(annee %in% 2016 & periodeSimple=="05")|(annee %in% 2021 & periodeSimple=="06")|(annee %in% 2031 & periodeSimple=="07")|(annee %in% 2041 & periodeSimple=="08"), Surf_neuf_n1:=0] 



PM_energie_neuf2[,surf_cons_n := Surf_neuf_n - Surf_neuf_n1]
PM_energie_neuf2[, PM_ener_neuf := surf_cons_n/sum(surf_cons_n),by=c("scenario", "Type_parc","periodeSimple","annee")]

PM_energie_neuf2 = PM_energie_neuf2[(annee %in% 2010:2015 & periodeSimple=="04")|(annee %in% 2016:2020 & periodeSimple=="05")|
                                    (annee %in% 2021:2030 & periodeSimple=="06")|(annee %in% 2031:2040 & periodeSimple=="07")|(annee %in% 2041:2050 & periodeSimple=="08")] 
PM_energie_neuf2[,sum(PM_ener_neuf), by="annee"]

PM_energie_neuf2 = merge(PM_energie_neuf2,COD_ENERGIE[, list(energieChauffage =  COD_ENERGIE, Energie = ENERGIE)], by="energieChauffage")

PM_energie_neuf2[,annee :=as.character(annee)]

PM_energie_neuf = rbind(PM_energie_neuf,PM_energie_neuf2)

### PM dans le parc construit après 2010
PM_energie_neuf_DGEC =parc_melted[Type_parc ==  "N", list(Surf_neuf_n = sum(Surface)),by=c("scenario", "Type_parc","energieChauffage","annee")] 
PM_energie_neuf_DGEC[, PM_ener_neuf := Surf_neuf_n/sum(Surf_neuf_n ),by=c("scenario", "Type_parc","annee")]
PM_energie_neuf_DGEC = merge(PM_energie_neuf_DGEC,COD_ENERGIE[, list(energieChauffage =  COD_ENERGIE, Energie = ENERGIE)], by="energieChauffage")

## PM systeme neuf 

PM_syst_neuf = PM[Type_parc ==  "N", list(Surf_neuf_n = sum(surface)),by=c("scenario", "Type_parc","systeme_chauff","periodeSimple","annee")] 


PM_syst_neuf

PM_syst_neuf [, annee_n1 := as.factor(as.numeric(as.character(annee)) -1)]
PM_syst_neuf [, periodeSimple_n1 := periodeSimple]
# PM_syst_neuf [annee %in% c("2016","2021","2031","2041"), periodeSimple_n1 := paste0("0",as.numeric(substring(periodeSimple,2,2)) -1)]

PM_syst_neuf = merge(PM_syst_neuf ,
                        PM_syst_neuf [,list(scenario,Type_parc,annee,systeme_chauff,periodeSimple,
                                            Surf_neuf_n1 = Surf_neuf_n )], 
                        by.x=c("scenario", "Type_parc","systeme_chauff","periodeSimple","annee_n1"), 
                        by.y=c("scenario", "Type_parc","systeme_chauff","periodeSimple","annee"),all.x=T)

PM_syst_neuf[(annee %in% 2010& periodeSimple=="04")|(annee %in% 2016 & periodeSimple=="05")|(annee %in% 2021 & periodeSimple=="06")|(annee %in% 2031 & periodeSimple=="07")|(annee %in% 2041 & periodeSimple=="08"), Surf_neuf_n1:=0] 



PM_syst_neuf[,surf_cons_n := Surf_neuf_n - Surf_neuf_n1]

PM_syst_neuf[, PM_syst_neuf := surf_cons_n/sum(surf_cons_n, na.rm=T),by=c("scenario", "Type_parc","periodeSimple","annee")]

PM_syst_neuf[, PM_syst_neuf := surf_cons_n/sum(surf_cons_n, na.rm=T),by=c("scenario", "Type_parc","periodeSimple","annee")]


PM_syst_neuf = PM_syst_neuf[(annee %in% 2010:2015 & periodeSimple=="04")|(annee %in% 2016:2020 & periodeSimple=="05")|(annee %in% 2021:2030 & periodeSimple=="06")|(annee %in% 2031:2040 & periodeSimple=="07")|(annee%in% 2041:2050 & periodeSimple=="08")] 
PM_syst_neuf[,sum(PM_syst_neuf), by="annee"]

PM_syst_neuf[annee == "2016"]
PM_syst_neuf[annee == "2015"]

PM_syst_neuf = merge(PM_syst_neuf,COD_SYSTEME_CHAUD[, list(systeme_chauff =  COD_SYSTEME_CHAUD, SYSTEME_CHAUD= SYSTEME_CHAUD)], by="systeme_chauff")

PM_syst_neuf[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  
                                                           "Autre système centralisé performant",
                                                           "nr"))]
unique(PM_syst_neuf$SYSTEME_CHAUD)

PM_syst_neuf= merge(PM_syst_neuf,colors_syst, by="SYSTEME_CHAUD")


```


```{r Evol_PM_energie_neuf, fig.width=25, fig.height=9, echo=F, warning=F,fig.cap='Part des surfaces neuves construites par énergie (input DGEC)', dev=c('png', 'pdf')}

ggplot(PM_energie_neuf) +
           geom_bar(aes(annee,PM_ener_neuf , fill = Energie, color = Energie), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot  +
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) + ylab("Part") + xlab("")
```

```{r Evol_PM_syst_neuf, fig.width=25, fig.height=13, echo=F, warning=F,fig.cap='Part des surfaces neuves construites par système', dev=c('png', 'pdf')}

ggplot(PM_syst_neuf) +
           geom_bar(aes(annee,PM_syst_neuf , fill = SYSTEME_CHAUD), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot  +
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5))  +
     theme(legend.position = "top") +
  scale_fill_manual("",values=unique(PM_syst_neuf$color),
                    guide = guide_legend(nrow = 4)) + ylab("Part")+ xlab("")
```

\newpage

### Changements de système dans l'existant

```{r,echo=F, warning=F,include = F}


PM_syst_br = COUTS[!is.na(COD_SYSTEME_CHAUD), list(surface = sum(surface)), by=c("scenario","annee","SYSTEME_CHAUD","COD_SYSTEME_CHAUD", "branche")]
PM_syst_br [,PM_syst := surface/sum(surface) , by=c("scenario","annee", "branche")]
PM_syst_br = merge(PM_syst_br ,COD_BRANCHE[,list(branche=COD_BRANCHE,BRANCHE)],by="branche")

PM_syst_Etat = COUTS[!is.na(COD_SYSTEME_CHAUD) & occupant=="03", list(surface = sum(surface)), by=c("scenario","annee","SYSTEME_CHAUD","COD_SYSTEME_CHAUD")]
COUTS[COD_SYSTEME_CHAUD %in% c("05","06","09","10","11","25","26","29","30","31") & annee == "2010", sum(surface)]

COUTS[COD_SYSTEME_CHAUD %in% c("05"), typeRenovationSysteme]

PM_syst = COUTS[!is.na(COD_SYSTEME_CHAUD), list(surface = sum(surface)), by=c("scenario","annee","SYSTEME_CHAUD","COD_SYSTEME_CHAUD")]


PM_syst[,PM_syst := surface/sum(surface) , by=c("scenario","annee")]
PM_syst[, sum(surface),by="annee"]
PM_syst[COD_SYSTEME_CHAUD == "24"]

PM_syst[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  
                                                           "Autre système centralisé performant",
                                                           "nr"))]
unique(PM_syst$SYSTEME_CHAUD)

PM_syst= merge(PM_syst,colors_syst, by="SYSTEME_CHAUD")




PM_syst_br[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  
                                                           "Autre système centralisé performant",
                                                           "nr"))]
unique(PM_syst_br$SYSTEME_CHAUD)

PM_syst_br= merge(PM_syst_br,colors_syst, by="SYSTEME_CHAUD")

PM_syst_Etat [,PM_syst := surface/sum(surface) , by=c("scenario","annee")]
PM_syst_Etat [, sum(surface),by="annee"]
PM_syst_Etat [COD_SYSTEME_CHAUD == "24"]

PM_syst_Etat[PM_syst <0]


levels(PM_syst$SYSTEME_CHAUD)


```

```{r Evol_PM_syst, fig.width=25, fig.height=13, echo=F, warning=F,fig.cap='Part des changements de système existant par système installé', dev=c('png', 'pdf')}

ggplot(PM_syst) +
           geom_bar(aes(annee,PM_syst , fill = SYSTEME_CHAUD), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot+ theme(legend.position = "top")+
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5))  +
  scale_fill_manual(values=unique(PM_syst$color),
                    guide = guide_legend(nrow = 4)) 



```

```{r Evol_PM_syst_ref, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Part des changements de système existant par système installé', dev=c('png', 'pdf')}

ggplot(PM_syst[scenario == scenario_toexport]) +
           geom_bar(aes(annee,PM_syst , fill = SYSTEME_CHAUD), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot+ theme(legend.position = "top")+
  
  scale_fill_manual(values=unique(PM_syst[scenario == scenario_ref]$color),
                    guide = guide_legend(nrow = 4)) 

```


```{r,echo=F, warning=F,include = F}
### PM des systèmes dans sur l'ensemble du parc

PM_syst_exi = etiquette[, list(Surf_exi_n = sum(surface)),by=c("scenario","annee","systeme_chauff")] 
PM_syst_exi2 = PM[, list(Surf_exi_n = sum(surface)),by=c("scenario","annee","systeme_chauff")] 

PM_syst_exi[,PM_syst_exi := Surf_exi_n /sum(Surf_exi_n ),by=c("scenario","annee")]
PM_syst_exi2[,PM_syst_exi := Surf_exi_n /sum(Surf_exi_n ),by=c("scenario","annee")]

PM_syst_exi[,sum(PM_syst_exi), by=c("scenario","annee")]
PM_syst_exi2[,sum(PM_syst_exi), by=c("scenario","annee")]

PM_syst_exi = merge(PM_syst_exi,COD_SYSTEME_CHAUD[, list(systeme_chauff =  COD_SYSTEME_CHAUD, SYSTEME_CHAUD)], by="systeme_chauff")
PM_syst_exi2 = merge(PM_syst_exi2,COD_SYSTEME_CHAUD[, list(systeme_chauff =  COD_SYSTEME_CHAUD, SYSTEME_CHAUD)], by="systeme_chauff")

PM_syst_exi = rbind(PM_syst_exi,PM_syst_exi2 )
PM_syst_exi[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                            "DRV", "DRV performant",
                                                           "Autre système centralisé",  
                                                           "Autre système centralisé performant",
                                                           "nr"))]


PM_syst_exi = dcast.data.table(PM_syst_exi[annee %in% seq(2010,2050,5)],scenario +SYSTEME_CHAUD~annee,value.var ="PM_syst_exi")

PM_syst_exi = merge(PM_syst_exi,colors_syst, by="SYSTEME_CHAUD")


PM_syst_exi = PM_syst_exi[!is.na(scenario)]

#### raccordement de l'urbain #######

surface_urbain = PM[systeme_chauff %in%  c("01","02") & energieChauffage=="06", list(surface =sum(surface)), by=c("scenario","annee")]
# library(tidyverse)
# surface_urbain <- group_by(surface_urbain, scenario) %>% mutate(surface_lag = lag(surface))

surface_urbain[,surface_lag := shift(surface, 1,0,"lag"), by="scenario"]

surface_urbain[,raccordement := surface-surface_lag, by="scenario"]

write.table(surface_urbain,paste0(wbdir_scenario_toexport,"surface_urbain.csv"),quote=T,row.names = F, sep = ";",dec=".")


```

<!-- ```{r, echo=F, warning=F} -->
<!-- pander(PM_syst_exi, digits = 2, caption = "Part des surfaces chauffées de l'ensemble du parc  par système (input DGEC)") -->
<!-- ``` -->
\clearpage
\newpage



### PM dans le stock


```{r,echo=F, warning=F,include = F}

### PM des énergies dans l'existant
PM_energie_exi = parc_melted[Type_parc ==  "E", list(Surf_exi_n = sum(Surface)),by=c("scenario", "Type_parc","energieChauffage","annee")] 
PM_energie_exi[, PM_ener_exi := Surf_exi_n /sum(Surf_exi_n ),by=c("scenario", "Type_parc","annee")]

PM_energie_exi[,sum(PM_ener_exi), by="annee"]

PM_energie_exi[PM_ener_exi<0]

PM_energie_exi = merge(PM_energie_exi,COD_ENERGIE[, list(energieChauffage =  COD_ENERGIE, Energie = ENERGIE)], by="energieChauffage")
PM_energie_exi = dcast.data.table(PM_energie_exi[annee %in% seq(2010,2050,5)],scenario + Energie~annee,value.var ="PM_ener_exi")

PM_syst_2010 = melt(PM_syst_exi,id.vars = c("scenario","SYSTEME_CHAUD","color"),variable.name = "annee",value.name = "PM_syst")[scenario==scenario_ref & annee == 2010 &!is.na(PM_syst)]
PM_syst_2010[PM_syst >0.03, Part_graph := paste0(round(100*PM_syst,0)," %")]
PM_syst_2010[PM_syst<=0.03, Part_graph := ""]
PM_syst_2010[order(SYSTEME_CHAUD)]
```


```{r Evol_PM_syst_all_2010, fig.width=20, fig.height=9, echo=F, warning=F,fig.cap='Part des systèmes sur l\'ensemble du parc en 2010', dev=c('png', 'pdf')}

ggplot(PM_syst_2010, aes(scenario,PM_syst, fill = SYSTEME_CHAUD)) +
           geom_bar( stat="identity") +
           ### facet_wrap(~scenario, nrow = 1) + 
              geom_text(aes(label = Part_graph),
                        position = position_stack(vjust = 0.5, reverse =F), colour = "white", fontface = "bold", size = 7)+
            xlab("")+ylab("Part dans le parc total")+
           mytheme_facet_plot +
  scale_fill_manual("Système de chauffage",values=unique(PM_syst_2010$color),
                    guide = guide_legend(ncol=2))  

#ggsave("../publication_thema/figures/PMsyst2010.pdf",width =12 , height=12)
            
            
```



```{r Evol_PM_syst_all, fig.width=25, fig.height=13, echo=F, warning=F,fig.cap='Part des systèmes sur l\'ensemble du parc', dev=c('png', 'pdf')}

ggplot(melt(PM_syst_exi,id.vars = c("scenario","SYSTEME_CHAUD","color"),variable.name = "annee",value.name = "PM_syst")) +
           geom_bar(aes(annee,PM_syst , fill = SYSTEME_CHAUD, color = SYSTEME_CHAUD), stat="identity") +
           facet_wrap(~scenario, nrow = 1) + xlab("")+ylab("Part dans le parc total")+
           mytheme_facet_plot + theme(legend.position = "top")+
  
  scale_fill_manual(values=unique(PM_syst_exi$color),
                    guide = guide_legend(nrow = 4)) 

```


\clearpage
\newpage 

\clearpage
\pagebreak

## 4) Evolution des parts de marché des énergies dans les besoins et les consommations

```{r,  echo=F, warning=F,include = F}
##### besoins totaux par branche MEDPRO, énergie et usage

Besoin_national_energie_branche = 
  dcast.data.table(Besoin_branche_usage_energie,
                   scenario + annee +Branche_MEDPRO + usage  ~ ENERGIE,
                   fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "BESOIN_TOT")


 dcast.data.table(Besoin_branche_usage_energie,
                   scenario  +Branche_MEDPRO ~  annee,
                   fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "BESOIN_TOT")


#### table des PM par énergie pour MEDPRO

tab_PM_energie_branche = dcast.data.table(
  Besoin_branche_usage_energie[annee %in% annee_MEDPRO ,],
  scenario +Branche_MEDPRO+ ENERGIE + annee ~ Usage_MEDPRO2, fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "BESOIN_TOT")


tab_PM_energie_branche = 
  tab_PM_energie_branche[,
                         list(ENERGIE, 
                              PM_Chauffage = Chauffage/sum(Chauffage),
                              PM_Usages_thermiques =(get("Autres usages thermiques") + get("Chauffage"))/sum(get("Autres usages thermiques") + get("Chauffage")),
                              
                              PM_Elec_spe_hors_clim =get("Electricité spécifique")/sum(get("Electricité spécifique")),
                              PM_ECS_Cuisson_Autres =get("Autres usages thermiques")/
                                sum(get("Autres usages thermiques")),                                 PM_Total=(get("Autres usages thermiques") + get("Chauffage") + get("Electricité spécifique") + get("Climatisation"))/sum(get("Autres usages thermiques") + get("Chauffage") + get("Electricité spécifique") + get("Climatisation"))), by=c("scenario","Branche_MEDPRO","annee")]

tab_PM_energie_branche = melt(tab_PM_energie_branche,
                              id.vars = c("scenario","Branche_MEDPRO","annee","ENERGIE"),variable.name ="PM_usage" )

tab_PM_energie_branche =dcast.data.table(tab_PM_energie_branche,scenario  +PM_usage +Branche_MEDPRO+ENERGIE ~ annee  )

tab_PM_energie_branche[PM_usage == "PM_Usages_thermiques"][order(ENERGIE)]

##### besoin nationales par branche MEDPRO et usage 

Besoin_national_branche_usage = dcast.data.table(Besoin_branche_usage_energie, scenario + annee  + Branche_MEDPRO ~ Usage_MEDPRO2,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "BESOIN_TOT") 

Besoin_national_branche_usage  = melt(Besoin_national_branche_usage , id.vars = c("scenario","annee","Branche_MEDPRO"), variable.name = "usage", value.name = "BESOIN_TOT")


surface_branche = parc_melted[,list(Surface = sum(Surface)), by=c("scenario","annee","Branche_MEDPRO")]
surface_branche[, annee:=as.factor(annee)]

Besoin_national_branche_usage = merge(
Besoin_national_branche_usage, surface_branche, by=c("scenario","annee","Branche_MEDPRO"))

Besoin_national_branche_usage[, BESOIN_U := BESOIN_TOT*10^9/Surface]

evolbesoinu_branche_usage = data.table(Besoin_national_branche_usage)

evolbesoinu_branche_usage = dcast.data.table(evolbesoinu_branche_usage, scenario + usage + Branche_MEDPRO ~ annee,value.var = "BESOIN_U")

evolbesoinu_branche_usage  = evolbesoinu_branche_usage[,list(scenario, usage,Branche_MEDPRO,
                                                    Evol_2010 = round((get("2015")/get(annee_ref_MEDPRO)), digits=1),
                Evol_2020 = round((get("2020")/get(annee_ref_MEDPRO)), digits=2),
                Evol_2030 = round((get("2025")/get(annee_ref_MEDPRO)), digits=2),
                Evol_2040 = round((get("2030")/get(annee_ref_MEDPRO)), digits=2),
                Evol_2050 = round((get("2050")/get(annee_ref_MEDPRO)), digits=2))]

setnames(evolbesoinu_branche_usage, c("scenario", "usage","Branche","2015","2020","2025","2030","2050"))

evolbesoin_branche_usage = data.table(Besoin_national_branche_usage)

evolbesoin_branche_usage = dcast.data.table(evolbesoin_branche_usage, scenario + usage + Branche_MEDPRO ~ annee,value.var = "BESOIN_TOT")

evolbesoin_branche_usage  = evolbesoin_branche_usage [,list(scenario, usage,Branche_MEDPRO,
                                                    Evol_2010 = round((get("2015")/get(annee_ref_MEDPRO)), digits=1),
                Evol_2020 = round((get("2020")/get(annee_ref_MEDPRO)), digits=2),
                Evol_2030 = round((get("2025")/get(annee_ref_MEDPRO)), digits=2),
                Evol_2040 = round((get("2030")/get(annee_ref_MEDPRO)), digits=2),
                Evol_2050 = round((get("2050")/get(annee_ref_MEDPRO)), digits=2))]

setnames(evolbesoin_branche_usage, c("scenario", "usage","Branche","2010","2020","2030","2040","2050"))


### Evol besoinu  parc neuf et ancien

surface_parc_MEDPRO = parc_melted[,list(Surface = sum(Surface)),by=c("scenario","annee","Type_parc_MEDPRO")]

evolbesoinu_usage_type = dcast.data.table(Besoin_branche_usage_energie_periode, scenario + Usage_MEDPRO2 + Type_parc_MEDPRO ~ annee, function(x){sum(x, na.rm = T)/10^9}, value.var = "BESOIN_TOT")
                               
evolbesoinu_usage_type = melt(evolbesoinu_usage_type ,id.vars = c("scenario","Type_parc_MEDPRO","Usage_MEDPRO2"),variable.name ="annee" )

evolbesoinu_usage_type= merge(evolbesoinu_usage_type, surface_parc_MEDPRO,by=c("scenario","annee","Type_parc_MEDPRO"),all.x=T)

evolbesoinu_usage_type[, BESOIN_U :=value*10^9/Surface]
evolbesoinu_usage_type = dcast.data.table(evolbesoinu_usage_type, scenario + Usage_MEDPRO2 + Type_parc_MEDPRO ~ annee,value.var = "BESOIN_U")
evolbesoinu_usage_type[Type_parc_MEDPRO=="N", "2015"] <- evolbesoinu_usage_type[Type_parc_MEDPRO=="N", get("2016")]

evolbesoinu_usage_type = 
  evolbesoinu_usage_type[,list(scenario, Usage_MEDPRO2,Type_parc_MEDPRO,
                               
                               Evol_2015 = round((get("2015")/get(annee_ref_MEDPRO)), digits=1),
                               Evol_2020 = round((get("2020")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2030 = round((get("2025")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2040 = round((get("2030")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2050 = round((get("2050")/get(annee_ref_MEDPRO)), digits=2))]

setnames(evolbesoinu_usage_type, c("scenario", "usage","Type_parc",annee_MEDPRO))


#### besoins d'électricité hors usages thermiques et clim
conso_elec_DGEC = Conso_nationale_energie_type_usage[usage %in% c("Auxiliaires","Ventilation","Process","Bureautique","Eclairage","Froid_alimentaire"), 
                                   list(conso_tWhEF = sum(conso_tWhEF),conso_tWhEP = sum(conso_tWhEF)),by=c("scenario","annee")] 
conso_elec_DGEC =dcast.data.table(conso_elec_DGEC ,scenario~annee,value.var = "conso_tWhEF")


#### besoins d'électricité pour la climatisation par branche 

besoin_elec_clim_medpro =Besoin_national_branche_usage[usage =="Climatisation" ,
                                                      list( BESOIN_TOT = sum( BESOIN_TOT),
                                                           BESOIN_U = sum(BESOIN_U*Surface)/sum(Surface),
                                                           Surface = sum(Surface))
                                                           ,by=c("scenario","annee","Branche_MEDPRO")]
  
besoin_elec_clim_medpro   = dcast.data.table(besoin_elec_clim_medpro,scenario+Branche_MEDPRO~annee,value.var = "BESOIN_TOT")

##### Evolution des besoins unitaires de clim sur l'ensemble du parc


evolbesoin_clim_medpro = Besoin_national_branche_usage[usage =="Climatisation",
                                                      list(BESOIN_TOT = sum( BESOIN_TOT),
                                                           BESOIN_U = sum(BESOIN_U*Surface)/sum(Surface),
                                                           BESOIN_U2 = sum(BESOIN_TOT)*10^9/sum(Surface),
                                                           Surface = sum(Surface))
                                                           ,by=c("scenario","annee")] 

evolbesoin_clim_medpro   = dcast.data.table(evolbesoin_clim_medpro ,scenario~annee,value.var = "BESOIN_U")

evolbesoin_clim_medpro = evolbesoin_clim_medpro[,list(scenario,"2015"=1,
                "2020" = round((get("2020")/get(annee_ref_MEDPRO)), digits=2),
                "2025" = round((get("2025")/get(annee_ref)), digits=2),
                "2030" = round((get("2030")/get(annee_ref)), digits=2),
                "2050" = round((get("2050")/get(annee_ref)), digits=2))]


```

```{r,  echo=F, warning=F,include = F}
##### besoins totaux par branche MEDPRO, énergie et usage

Besoin_national_branche_usage2 = dcast.data.table(Besoin_branche_usage_energie, scenario + annee  + COD_BRANCHE ~ usage,fun.aggregate = function(x){sum(x, na.rm = T)/10^9}, value.var = "BESOIN_TOT") 

Besoin_national_branche_usage2  = melt(Besoin_national_branche_usage2 , id.vars = c("scenario","annee","COD_BRANCHE"), variable.name = "usage", value.name = "BESOIN_TOT")


surface_branche = parc_melted[,list(Surface = sum(Surface), COD_BRANCHE = branche) , 
                   by=c("scenario","annee","branche")]

Besoin_national_branche_usage2 = merge(
Besoin_national_branche_usage2, surface_branche, by=c("scenario","annee","COD_BRANCHE"))

Besoin_national_branche_usage2[, BESOIN_U := BESOIN_TOT*10^9/Surface]

evolbesoinu_branche_usage2 = data.table(Besoin_national_branche_usage2)

evolbesoinu_branche_usage2 = dcast.data.table(evolbesoinu_branche_usage2, 
                                              scenario + usage + COD_BRANCHE ~ annee,value.var ="BESOIN_U")

evolbesoinu_branche_usage2 = merge(evolbesoinu_branche_usage2,COD_BRANCHE, by="COD_BRANCHE")

evolbesoinu_branche_usage3  = evolbesoinu_branche_usage2[,list(scenario, BRANCHE,usage,
                                                    Evol_2010 = round((get("2015")/get(annee_ref_MEDPRO)), digits=1),
                Evol_2020 = round((get("2020")/get(annee_ref_MEDPRO)), digits=2),
                Evol_2030 = round((get("2025")/get(annee_ref_MEDPRO)), digits=2),
                Evol_2040 = round((get("2030")/get(annee_ref_MEDPRO)), digits=2),
                Evol_2050 = round((get("2050")/get(annee_ref_MEDPRO)), digits=2))]



setnames(evolbesoinu_branche_usage3, c("scenario", "usage","Branche","2015","2020","2025","2030","2050"))

evolbesoinu_branche_usage2 = evolbesoinu_branche_usage2[,c("scenario", "BRANCHE", "usage", annee_MEDPRO), with=F]

write.table(
evolbesoinu_branche_usage2[scenario == scenario_toexport], 
paste(wbdir_scenario_toexport,"evolbesoinu_branche_usage2.csv"), sep=";",dec=".",quote = T,row.names = F)

### Evol besoinu  parc neuf et ancien, desagregations

surface_parc2 = parc_melted[,list(Surface = sum(Surface)),
                           by=c("scenario","annee","Type_parc_MEDPRO")]

evolbesoinu_usage_type2 = dcast.data.table(Besoin_branche_usage_energie_periode, scenario + usage + Type_parc_MEDPRO ~ annee, function(x){sum(x, na.rm = T)/10^9}, value.var = "BESOIN_TOT")
                               
evolbesoinu_usage_type2= melt(evolbesoinu_usage_type2 ,id.vars = c("scenario","Type_parc_MEDPRO","usage"),variable.name ="annee" )

evolbesoinu_usage_type2= merge(evolbesoinu_usage_type2, surface_parc2,by=c("scenario","annee","Type_parc_MEDPRO"),all.x=T)

evolbesoinu_usage_type2[, BESOIN_U :=value*10^9/Surface]
evolbesoinu_usage_type2 = dcast.data.table(evolbesoinu_usage_type2, scenario + usage + Type_parc_MEDPRO ~ annee,value.var = "BESOIN_U")
evolbesoinu_usage_type2[Type_parc_MEDPRO=="N", "2015"] <- evolbesoinu_usage_type2[Type_parc_MEDPRO=="N", get("2016")]


evolbesoinu_usage_type2 = 
  evolbesoinu_usage_type2[,list(scenario,usage,Type_parc_MEDPRO,
                               
                               Evol_2015 = round((get("2015")/get(annee_ref_MEDPRO)), digits=1),
                               Evol_2020 = round((get("2020")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2030 = round((get("2025")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2040 = round((get("2030")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2050 = round((get("2050")/get(annee_ref_MEDPRO)), digits=2))]

setnames(evolbesoinu_usage_type2, c("scenario", "usage","Type_parc",annee_MEDPRO))

# ##### test adaptation CC
# Evol_besoin_CC = Besoin_branche_usage_energie_periode[substring(scenario,1,2) %in% c("S3","S5") & Usage_MEDPRO2 %in% c("Chauffage","Climatisation"),sum(BESOIN_TOT),by=c("annee","scenario", "Usage_MEDPRO2", "Type_parc_MEDPRO") ]
# diff_besoin_CC = dcast.data.table(Evol_besoin_CC,  Usage_MEDPRO2 + annee ~ scenario, fun.aggregate = sum)
# 
# diff_besoin_CC [,diff_besoin := diff_besoin_CC[,3]/diff_besoin_CC[,4]]
# 
# evolbesoinu_usage_typeCC 

surface_parc3 = parc_melted[,list(Surface = sum(Surface)),
                           by=c("scenario","annee")]

evolbesoinu_usage = dcast.data.table(Besoin_branche_usage_energie_periode, scenario + usage ~ annee, function(x){sum(x, na.rm = T)/10^9}, value.var = "BESOIN_TOT")
                               
evolbesoinu_usage= melt(evolbesoinu_usage ,id.vars = c("scenario","usage"),variable.name ="annee" )

evolbesoinu_usage= merge(evolbesoinu_usage, surface_parc3,by=c("scenario","annee"),all.x=T)

evolbesoinu_usage[, BESOIN_U :=value*10^9/Surface]
evolbesoinu_usage = dcast.data.table(evolbesoinu_usage, scenario + usage ~ annee,value.var = "BESOIN_U")



evolbesoinu_usage_perc = 
  evolbesoinu_usage[,list(scenario,usage,
                               
                               Evol_2015 = round((get("2015")/get(annee_ref_MEDPRO)), digits=1),
                               Evol_2020 = round((get("2020")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2030 = round((get("2025")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2040 = round((get("2030")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2050 = round((get("2050")/get(annee_ref_MEDPRO)), digits=2))]

setnames(evolbesoinu_usage_perc, c("scenario", "usage",annee_MEDPRO))

```

### Mix ensemble du parc (pour DGEC)

```{r,  echo=F, warning=F,include = F}
#### calcul PM des énergies par usage sur l'ensemble du parc 
tab_PM_energie = dcast.data.table(Conso_nationale_energie_branche[annee %in% c("2010","2015","2020","2025","2030","2035","2040","2045","2050"),],scenario + energie + annee ~ usage, fun.aggregate = sum)



tab_PM_energie = tab_PM_energie[,list(Chauffage,
                                      Usages_thermiques = sum(Chauffage,ECS,Cuisson,Autre),
                                      Elec_spe_hors_clim = sum(Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire),
                                      Climatisation,
                                      ECS_Cuisson_Autres = sum(ECS,Cuisson,Autre), 
 Total_RT=sum(Chauffage,Climatisation,ECS,Auxiliaires,Ventilation,Eclairage),                                      Total=sum(Chauffage,Climatisation,ECS,Cuisson,Autre,Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire) ), by=c("scenario","energie","annee")]

tab_PM_energie = tab_PM_energie[,
                                                list(energie, 
                                                     PM_Chauffage = Chauffage/sum(Chauffage),
                                                     PM_Usages_thermiques =Usages_thermiques/sum(Usages_thermiques),
                                                     PM_Elec_spe_hors_clim =Elec_spe_hors_clim/sum(Elec_spe_hors_clim),
                                                     PM_ECS_Cuisson_Autres =ECS_Cuisson_Autres/sum(ECS_Cuisson_Autres),                                 PM_Total=Total/sum(Total)), by=c("scenario","annee")]

tab_PM_energie = melt(tab_PM_energie,id.vars = c("scenario","annee","energie"),variable.name ="PM_usage" )

tab_PM_energie =dcast.data.table(tab_PM_energie,scenario  +PM_usage +energie ~ annee  )

tab_PM_energie_graph = tab_PM_energie
tab_PM_energie_graph[,energie := factor(as.character(energie))]

```

<!-- ```{r, echo=F, warning=F} -->
<!-- pander(tab_PM_energie[PM_usage == "PM_Usages_thermiques", -->
<!--                                c("scenario","energie","2010","2015","2020","2025","2030","2035","2040","2045","2050"), with=F],  -->
<!--        digits = 2, caption = "Part de marché des énergies dans les consommations des usages thermiques") -->
<!-- ``` -->

```{r Evol_PM_ener_thermiques, fig.width=25, fig.height=13, echo=F, warning=F,fig.cap='Part de marché des énergies dans les consommations des usages thermiques (ensemble du parc)', dev=c('png', 'pdf')}

ggplot(melt(tab_PM_energie_graph[PM_usage == "PM_Usages_thermiques"],id.vars = c("scenario","energie","PM_usage"),variable.name = "annee",value.name = "PM_ener")) +
           geom_bar(aes(annee,PM_ener , fill = energie, color =  energie), stat="identity") +
           facet_wrap(~scenario, nrow = 1) + xlab("") + ylab("Part dans les consommations")+
           mytheme_facet_plot
```




### Mix Parc neuf / existant (pour DGEC)
```{r,  echo=F, warning=F,include = F}
#### calcul PM des énergies par usage du parc neuf et ancien 
tab_PM_energie_type = dcast.data.table(Conso_nationale_energie_type_usage[annee %in% c("2010","2015","2020","2025","2030","2035","2040","2045","2050"),],scenario + energie + annee + Type_parc ~ usage, fun.aggregate = sum, value.var = "conso_tWhEF")


tab_PM_energie_type= tab_PM_energie_type[,list(Chauffage,
                                      Usages_thermiques = sum(Chauffage,ECS,Cuisson,Autre),
                                      Elec_spe_hors_clim = sum(Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire),
                                      Climatisation,
                                      ECS_Cuisson_Autres = sum(ECS,Cuisson,Autre), 
 Total_RT=sum(Chauffage,Climatisation,ECS,Auxiliaires,Ventilation,Eclairage),                                      Total=sum(Chauffage,Climatisation,ECS,Cuisson,Autre,Auxiliaires,Ventilation,Process,Bureautique,Eclairage,Froid_alimentaire) ), by=c("scenario","energie","annee","Type_parc")]

tab_PM_energie_type = tab_PM_energie_type[,
                                                list(energie, 
                                                     PM_Chauffage = Chauffage/sum(Chauffage),
                                                     PM_Usages_thermiques =Usages_thermiques/sum(Usages_thermiques),
                                                     PM_Elec_spe_hors_clim =Elec_spe_hors_clim/sum(Elec_spe_hors_clim),
                                                     PM_ECS_Cuisson_Autres =ECS_Cuisson_Autres/sum(ECS_Cuisson_Autres),                                 PM_Total=Total/sum(Total)), by=c("scenario","annee","Type_parc")]

tab_PM_energie_type = melt(tab_PM_energie_type,id.vars = c("scenario","annee","energie","Type_parc"),variable.name ="PM_usage" )

tab_PM_energie_type =dcast.data.table(tab_PM_energie_type,scenario  +PM_usage +Type_parc +energie  ~ annee  )

tab_PM_energie_type[PM_usage == "PM_Usages_thermiques"][order(energie)]

```


```{r Evol_PM_ener_cahuffage_neuf, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Parts de marché des énergies dans les consommations de chauffage du parc neuf (pour DGEC)', dev=c('png', 'pdf')}

ggplot(melt(tab_PM_energie_type[PM_usage == "PM_Chauffage" & Type_parc == "N"][order(energie)],id.vars = c("scenario","energie","PM_usage","Type_parc"),variable.name = "annee",value.name = "PM_ener")) +
           geom_bar(aes(annee,PM_ener , fill = energie), stat="identity") +
           facet_wrap(~scenario, nrow = 1) + xlab("") + ylab("Part dans les consommations")+
           mytheme_facet_plot+ scale_fill_discrete("")
```

```{r Evol_PM_ener_cahuffage_exi, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Parts de marché des énergies dans les consommations de chauffage du parc existant (pour DGEC)', dev=c('png', 'pdf')}

ggplot(melt(tab_PM_energie_type[PM_usage == "PM_Chauffage" & Type_parc == "E"],id.vars = c("scenario","energie","PM_usage","Type_parc"),variable.name = "annee",value.name = "PM_ener")) +
           geom_bar(aes(annee,PM_ener , fill = energie), stat="identity") +
           facet_wrap(~scenario, nrow = 1) + xlab("") + ylab("Part dans les consommations")+
           mytheme_facet_plot+ scale_fill_discrete("")
```


\clearpage
\pagebreak

### Part des surfaces climatisées

```{r,  echo=F, warning=F,include = F}

#### calcul Part du parc climatisé par branche
unique(etiquette$systeme_froid)

etiquette[systeme_froid == "01", Isclim := "Climatisé"]
etiquette[systeme_froid == "02", Isclim := "non climatisé"]

PM_clim_branche = etiquette[, list(Surface = sum(surface)),by=c("scenario","annee","Branche_MEDPRO","Isclim")]

PM_clim_branche = PM_clim_branche[, list(Surface = sum(Surface),Isclim, PM_clim = Surface/sum(Surface)),by=c("scenario","annee","Branche_MEDPRO")]

PM_clim_branche = dcast.data.table(PM_clim_branche, scenario + Isclim +Branche_MEDPRO ~ annee, value.var = "PM_clim")

PM_clim_type_branche = etiquette[, list(Surface = sum(surface)),by=c("scenario","annee","Type_parc","Branche_MEDPRO","Isclim")]

PM_clim_type_branche = PM_clim_type_branche [, list(Surface = sum(Surface),Isclim, PM_clim = Surface/sum(Surface)),by=c("scenario","annee","Branche_MEDPRO","Type_parc")]

PM_clim_type_branche  = dcast.data.table(PM_clim_type_branche  , scenario + Isclim +Type_parc+Branche_MEDPRO ~ annee, value.var = "PM_clim")

SURFACE_CLIM[COD_SYSTEME_FROID == "01", Isclim := "Climatisé"]
SURFACE_CLIM[COD_SYSTEME_FROID  == "02", Isclim := "non climatisé"]

PM_clim_branche = SURFACE_CLIM[, list(Surface = sum(SURFACES_TOT)),by=c("scenario","annee","Branche_MEDPRO","Isclim")]

PM_clim_branche = PM_clim_branche[, list(Surface = sum(Surface),Isclim, PM_clim = Surface/sum(Surface)),by=c("scenario","annee","Branche_MEDPRO")]

PM_clim_branche = dcast.data.table(PM_clim_branche, scenario + Isclim +Branche_MEDPRO ~ annee, value.var = "PM_clim")

PM_clim_type_branche = SURFACE_CLIM[, list(Surface = sum(SURFACES_TOT)),by=c("scenario","annee","Type_parc","Branche_MEDPRO","Isclim")]

PM_clim_type_branche = PM_clim_type_branche [, list(Surface = sum(Surface),Isclim, PM_clim = Surface/sum(Surface)),by=c("scenario","annee","Branche_MEDPRO","Type_parc")]
PM_clim_type_branche  = dcast.data.table(PM_clim_type_branche  , scenario + Isclim +Type_parc+Branche_MEDPRO ~ annee, value.var = "PM_clim")

```

```{r, echo=F, warning=F,}
pander(PM_clim_branche[Isclim ==  "Climatisé" ,
                               colnames(PM_clim_branche)[colnames(PM_clim_branche) %in% c("scenario","Branche_MEDPRO",annee_MEDPRO)], with=F], 
       digits = 2, caption = "Part des surfaces climatisées par branche (input MEDPRO)")
```

```{r, echo=F, warning=F,}
pander(PM_clim_type_branche[Isclim ==  "Climatisé" & Type_parc =="N" ,
                                colnames(PM_clim_type_branche)[colnames(PM_clim_type_branche) %in% c("scenario","Branche_MEDPRO",annee_MEDPRO)], with=F], 
       digits = 2, caption = "Part des surfaces climatisées par branche pour le parc neuf (input DGEC)")
```

```{r, echo=F, warning=F,}
pander(PM_clim_type_branche[Isclim ==  "Climatisé" & Type_parc =="E" ,
                                colnames(PM_clim_type_branche)[colnames(PM_clim_type_branche) %in% c("scenario","Branche_MEDPRO",annee_MEDPRO)], with=F], 
       digits = 2, caption = "Part des surfaces climatisées par branche pour le parc existant (input DGEC)")

```

<!-- ```{r Evol_CC, fig.width=25, fig.height=9, echo=F, warning=F,fig.cap='Effet du CC sur les besoins', dev=c('png', 'pdf'), fig.show='hold'} -->

<!-- ggplot(Evol_besoin_CC[Usage_MEDPRO2 == "Chauffage"]) + geom_line(aes(annee, V1/10^9, group=scenario,color= scenario), size = 2) +  -->
<!--      mytheme_facet_plot  + ylab("besoin total en chauffage en Twh") +  -->
<!--     scale_x_discrete(breaks = seq(2010,2050,5), labels = -->
<!--                     seq(2010,2050,5))  +  -->
<!--   scale_y_continuous(limits = c(0,100),breaks = seq(0,100,25)) + facet_wrap(~Type_parc_MEDPRO) -->

<!-- ggplot(Evol_besoin_CC[Usage_MEDPRO2 == "Climatisation"]) + geom_line(aes(annee, V1/10^9, group=scenario,color= scenario), size = 2) +  -->
<!--      mytheme_facet_plot  + ylab("besoin total en climatisation en Twh") +  -->
<!--     scale_x_discrete(breaks = seq(2010,2050,5), labels = -->
<!--                     seq(2010,2050,5))  +  -->
<!--   scale_y_continuous(limits = c(0,30),breaks = seq(0,30,5)) + facet_wrap(~Type_parc_MEDPRO) -->


<!-- ``` -->
### PM des systèmes dans les consommations et consommations PAC/Joule


```{r,echo=F, warning=F,include = F}
#### Consommations et besoins par systèmes de chauffage

Conso_chauff_Syst_Energie = BESOINS_RT_SYST[usage == "Chauffage", list(CONSO_TOT=sum(CONSO_TOT), BESOIN_TOT = sum(BESOIN_TOT)), by=c("scenario","annee","COD_SYSTEME_CHAUD","COD_ENERGIE", "SYSTEME_CHAUD","ENERGIE")]


#### Consommations et besoins clim
RDT_clim  <- BESOINS[usage == "Climatisation",list(CONSO_TOT=sum(CONSO_TOT), BESOIN_TOT = sum(BESOIN_TOT)), by=c("scenario","annee","COD_ENERGIE")]

RDT_clim[,RDT := BESOIN_TOT/CONSO_TOT]

RDT_clim[annee == "2009"]
#### Consommations et besoins  clim par branche
RDT_clim_BRANCHE  <- BESOINS[usage == "Climatisation",list(CONSO_TOT=sum(CONSO_TOT), BESOIN_TOT = sum(BESOIN_TOT)), by=c("scenario","annee","COD_BRANCHE","COD_ENERGIE")]

RDT_clim_BRANCHE[,RDT := BESOIN_TOT/CONSO_TOT]
RDT_clim_BRANCHE[annee == "2009"]
#### Consommations et besoins  ECS
RDT_ECS <- BESOINS[usage == "ECS",list(CONSO_TOT=sum(CONSO_TOT), BESOIN_TOT = sum(BESOIN_TOT)), by=c("scenario","annee","COD_ENERGIE","ENERGIE")]

RDT_ECS[,RDT := BESOIN_TOT/CONSO_TOT]
RDT_ECS[ENERGIE == "Electricité"]



#### Consommations et besoins  ECS par branche
RDT_ECS_BRANCHE <- BESOINS[usage == "ECS",list(CONSO_TOT=sum(CONSO_TOT), BESOIN_TOT = sum(BESOIN_TOT)), by=c("scenario","annee","COD_BRANCHE", "COD_ENERGIE","ENERGIE")]

RDT_ECS_BRANCHE[,RDT := BESOIN_TOT/CONSO_TOT]
RDT_ECS_BRANCHE[ENERGIE == "Electricité"]

RDT_ECS_BRANCHE[annee == "2009"]


# #### Consommations unitaires et besoins unitaires Cuisson
# 
# RDT_CUISSON <- BESOINS[usage == "Cuisson",list(CONSO_TOT=sum(CONSO_TOT), BESOIN_TOT = sum(BESOIN_TOT)), by=c("scenario","annee","COD_ENERGIE","ENERGIE", "Type_parc_MEDPRO")]
# 
# 
# RDT_CUISSON[,RDT := BESOIN_TOT/CONSO_TOT]
# RDT_CUISSON[ENERGIE == "Electricité"]
# 
# 
# 
# #### Consommations et besoins élec spé autres
# 
# RDT_elecspe <- BESOINS[usage == "Bureautique",list(CONSO_TOT=sum(CONSO_TOT), BESOIN_TOT = sum(BESOIN_TOT)), by=c("scenario","annee","COD_ENERGIE","ENERGIE")]
# RDT_elecspe[,RDT := BESOIN_TOT/CONSO_TOT]
# RDT_elecspe[ENERGIE == "Electricité"]

```

\pagebreak 


\pagebreak
\newpage 

## 5) Consommations/besoins unitaires et efficacité 

### Parc neuf/ancien

```{r, echo=F, warning=F}
pander(evolbesoinu_usage_type[usage == "Chauffage"], digits = 2, caption = "Evolution des besoins unitaires de chauffage du parc existant et du parc neuf (input MEDPRO)")
```

```{r, echo=F, warning=F}
pander(evolbesoinu_usage_perc[usage == "Chauffage"], digits = 2, caption = "Evolution des besoins unitaires de chauffage du parc total")
```

```{r, echo=F, warning=F}
pander(evolbesoinu_usage[usage == "Chauffage",list(scenario),by=c( "scenario","2015","2020","2025","2030","2035","2050")], digits = 2, caption = "Besoins unitaires de chauffage du parc total")
```


<!-- ```{r Evol_consou_chauff, fig.width=20, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')} -->
<!-- ###### graph conso u du neuf par branche et période de construction par énergie ###### -->

<!-- ggplot(conso_entrants_branche[usage == "Chauffage"]) +  -->
<!--   geom_bar(aes(période,kwhEFm2_moy, fill=BRANCHE), stat="identity",position = "dodge") +  -->
<!--   mytheme_facet_plot + scale_y_continuous(breaks = seq(0,100,10)) + -->
<!--   ylab("KwhEF par m²") + -->
<!--   scale_fill_brewer(palette = fillpalette) +  -->
<!--   ggtitle("Besoins unitaires pour le chauffage par période de construction")  -->

<!-- ``` -->


<!-- ```{r Evol_consou_RT, fig.width=20, fig.height=10, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')} -->
<!-- ###### graph conso u du neuf par branche et période de construction par énergie ###### -->
<!-- ggplot(conso_entrants_branche[usage == "conso_RT"]) +  -->
<!--   geom_bar(aes(période,kwhEFm2_moy, fill=BRANCHE), stat="identity",position = "dodge") +  -->
<!--   mytheme_facet_plot + scale_y_continuous(breaks = seq(0,500,20))+ -->
<!--   ylab("KwhEF par m²") + -->
<!--   scale_fill_brewer(palette = fillpalette) +  -->
<!--   ggtitle("Besoins unitaires pour les usages RT par période de construction")  -->

<!-- ``` -->

\pagebreak

### Besoins unitaires par branche (inputs MEDPRO)

```{r test, echo=F, warning=F,}
pander(evolbesoinu_branche_usage[usage == "Autres usages thermiques" ,
                               c("scenario","Branche",annee_MEDPRO), with=F], 
       digits = 2, caption = "Evolution des besoins unitaires pour l'ensemble du parc pour les autres usages thermiques (input MEDPRO) ")
```

```{r, echo=F, warning=F,}
pander(evolbesoinu_branche_usage[usage == "Electricité spécifique" ,
                               c("scenario","Branche",annee_MEDPRO), with=F], 
       digits = 2, caption = "Evolution des besoins unitaires pour l'ensemble du parc pour les usages spécifiques de l'électricité (hors climatisation) (input MEDPRO)")
```

```{r, echo=F, warning=F,}
pander(evolbesoinu_branche_usage[usage == "Climatisation" ,
                               c("scenario","Branche",annee_MEDPRO), with=F], 
       digits = 2, caption = "Evolution des besoins unitaires pour l'ensemble du parc pour la climatisation")
```


```{r,  echo=F, warning=F,include = F}
###### calcul conso unitaire nationale ensemble des usages
parc_melt = melt(parc,id.vars = c("scenario","branche","occupation","periodeSimple","Type_parc","Type_parc_MEDPRO","energieChauffage"),variable.name = "annee",value.name = "surface")

parc_melt = parc_melt[,list(surface = sum(surface)),  by=c("scenario","annee", "Type_parc")]

Conso_nationale_energie_type[energie == "Electricité", conso_tWhEP := conso_tWhEF*2.58]
Conso_nationale_energie_type[energie != "Electricité", conso_tWhEP := conso_tWhEF]

conso_unitaire  = Conso_nationale_energie_type[,list(conso_tWhEF = sum(conso_tWhEF), 
                                                     conso_tWhEP = sum(conso_tWhEP)), 
                                               by=c("scenario","annee", "Type_parc")]

conso_unitaire = merge(conso_unitaire , parc_melt, by=c("scenario","annee", "Type_parc"))

conso_unitaire[,conso_u := conso_tWhEP*10^9/surface]
conso_unitaire_ensemble = conso_unitaire[,list(conso_u = sum(conso_tWhEP*10^9)/sum(surface)), by=c("scenario","annee")]

# ##### calcul conso unitaire par usage

Conso_nationale_energie_type_usage[energie == "Electricité", conso_tWhEP := conso_tWhEF*2.58]
Conso_nationale_energie_type_usage[energie != "Electricité", conso_tWhEP := conso_tWhEF]

conso_unitaire_usage  = Conso_nationale_energie_type_usage[,list(conso_tWhEF = sum(conso_tWhEF), 
                                                     conso_tWhEP = sum(conso_tWhEP)), 
                                               by=c("scenario","annee", "Type_parc", "usage")]

conso_unitaire_usage = merge(conso_unitaire_usage , parc_melt, by=c("scenario","annee", "Type_parc"))

conso_unitaire_usage[,conso_u := conso_tWhEP*10^9/surface]
conso_unitaire_ensemble_usage_EP = conso_unitaire_usage[,list(conso_u = sum(conso_tWhEP*10^9)/sum(surface)), by=c("scenario","annee", "usage")]
conso_unitaire_ensemble_usage_EF = conso_unitaire_usage[,list(conso_u = sum(conso_tWhEF*10^9)/sum(surface)), by=c("scenario","annee", "usage")]

#### consos 5 usages RT
conso_unitaire_usagesRT = conso_unitaire_usage[usage %in% c("Chauffage","Climatisation","ECS","Auxiliaires","Ventilation","Eclairage") , list(conso_tWhEP = sum(conso_tWhEP),conso_tWhEF = sum(conso_tWhEF)), by=c("scenario","annee", "Type_parc")]
conso_unitaire_usagesRT = merge(conso_unitaire_usagesRT , parc_melt, by=c("scenario","annee", "Type_parc"))

conso_unitaire_usagesRT_EP = conso_unitaire_usagesRT[,list(conso_u = sum(conso_tWhEP*10^9)/sum(surface)), by=c("scenario","annee")]
conso_unitaire_usagesRT_EF  = conso_unitaire_usagesRT[,list(conso_u = sum(conso_tWhEF*10^9)/sum(surface)), by=c("scenario","annee")]

pander(dcast.data.table(conso_unitaire_usagesRT_EP[annee %in% c("2015","2020","2030","2035","2050")], scenario  ~ annee, value.var = "conso_u"), digits = 0)
pander(dcast.data.table(conso_unitaire_usagesRT_EF[annee %in% c("2015","2020","2030","2035","2050")], scenario  ~ annee, value.var = "conso_u"), digits = 0)

#### conso unitaire par branche 
parc_melt = melt(parc,id.vars = c("scenario","branche","occupation","periodeSimple","Type_parc","Type_parc_MEDPRO","energieChauffage"),variable.name = "annee",value.name = "surface")

parc_melt = parc_melt[,list(surface = sum(surface)),  by=c("scenario","annee","branche", "Type_parc")]

Conso_nationale_energie_branche_type[energie == "Electricité", conso_tWhEP := conso_tWhEF*2.58]
Conso_nationale_energie_branche_type[energie != "Electricité", conso_tWhEP := conso_tWhEF]

conso_unitaire_branche_type  = Conso_nationale_energie_branche_type[,list(conso_tWhEF = sum(conso_tWhEF), 
                                                     conso_tWhEP = sum(conso_tWhEP)), 
                                               by=c("scenario","annee","nom_branche","branche","Type_parc","usage")]

conso_unitaire_branche_type = merge(conso_unitaire_branche_type , parc_melt,
                                    by=c("scenario","annee","branche", "Type_parc"),all.x=T)

conso_unitaire_branche_type [,conso_u := conso_tWhEF*10^9/surface]

conso_unitaire_branche_ensemble = 
  conso_unitaire_branche_type[,list(conso_u = sum(conso_u)), by=c("scenario","nom_branche","Type_parc","annee")]

conso_unitaire_branche_RT = 
  conso_unitaire_branche_type[usage %in% c("Chauffage","Climatisation","ECS","Auxiliaires","Ventilation","Eclairage") ,list(conso_u = sum(conso_u)), by=c("scenario","nom_branche","Type_parc","annee")]

```

\pagebreak

### Consommations unitaires et rendements pour le chauffage

```{r, echo=F, warning=F,}
pander(dcast.data.table(conso_unitaire_ensemble_usage_EP[annee %in% c("2009","2010","2015","2020","2030","2035","2050") & usage == "Chauffage"], scenario  ~ annee, value.var = "conso_u"), digits = 0, caption = "Consommations unitaires en kWh par m² d'énergie primaire pour l'ensemble du parc et pour le chauffage uniquement")
```

```{r, echo=F, warning=F,}
pander(dcast.data.table(conso_unitaire_ensemble_usage_EF[annee %in% c("2009","2010","2015","2020","2030","2035","2050") & usage == "Chauffage"], scenario  ~ annee, value.var = "conso_u"), digits = 0, caption = "Consommations unitaires en kWh par m² d'énergie finale pour l'ensemble du parc et pour le chauffage uniquement")
```



```{r,  echo=F, warning=F,include = F}
###### Evolution du rendement moyen chauffage
RDT_MOY <- BESOINS[ ,list(RDT_MOY=sum(BESOIN_TOT)/sum(CONSO_TOT)), by=c("scenario","annee","Type_parc_MEDPRO","usage")]


RDT_MOY2 <- BESOINS[ ,list(RDT_MOY=sum(BESOIN_TOT)/sum(CONSO_TOT)), by=c("scenario","annee","usage")]

Evol_rdt = dcast.data.table(RDT_MOY2[usage == "Chauffage" & annee %in% c("2015","2020","2030","2035","2050")], scenario  ~ annee,value.var = "RDT_MOY")

Evol_rdt_perc= 
  Evol_rdt[,list(scenario,
                               
                               Evol_2015 = round((get("2015")/get(annee_ref_MEDPRO)), digits=1),
                               Evol_2020 = round((get("2020")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2030 = round((get("2030")/get(annee_ref_MEDPRO)), digits=2),
                               Evol_2050 = round((get("2050")/get(annee_ref_MEDPRO)), digits=2))]

setnames(evolbesoinu_usage_perc, c("scenario", "usage",annee_MEDPRO))

```

```{r, echo=F, warning=F}
pander(dcast.data.table(RDT_MOY[usage == "Chauffage" & annee %in% c("2015","2020","2030","2035","2050")], scenario + Type_parc_MEDPRO ~ annee,value.var = "RDT_MOY"), digits = 2, caption = "Evolution du rendement moyen des systèmes de chauffage du parc existant et du parc neuf")
```


### Consommations unitaires pour tous les usages

```{r, echo=F, warning=F,}
pander(dcast.data.table(conso_unitaire_ensemble[annee %in% c("2015","2020","2030","2035","2050")], scenario  ~ annee, value.var = "conso_u"), digits = 0, caption = "Consommations unitaires en kWh par m² d'énergie primaire pour l'ensemble du parc et l'ensemble des usages")
```


```{r, echo=F, warning=F,}
pander(dcast.data.table(conso_unitaire_branche_ensemble[annee %in% c(as.character(2010:2017),"2020","2030","2050") & Type_parc=="E"], scenario + nom_branche ~ annee, value.var = "conso_u"), digits = 0, caption = "Consommations unitaires en kWh par m² d'énergie primaire pour le parc existant par branche et pour l'ensemble des usages")


```

```{r, echo=F, warning=F,}
pander(dcast.data.table(conso_unitaire_branche_ensemble[annee %in% c(as.character(2010:2017),"2020","2030","2050") & Type_parc=="N"], scenario + nom_branche ~ annee, value.var = "conso_u"), digits = 0, caption = "Consommations unitaires en kWh par m² d'énergie primaire pour le parc neuf par branche et pour l'ensemble des usages")

```


```{r, echo=F, warning=F,}
pander(RDT_MOY[annee==2009], caption = "Rendements moyens par usage en 2009" )

pander(conso_unitaire_ensemble_usage_EF[annee == 2009 ],caption = "consommations unitaires par usage en 2009")

conso_unitaire_ensemble_usage_EF[annee == 2009 , sum(conso_u)]
pander(RDT_ECS[annee == "2009" ],caption = "rendements initiaux pour l'ECS") 

conso_unitaire_branche_type[annee == "2009" ]

```

```{r Conso_u_branche_ini, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Parts de marché des énergies dans les consommations de chauffage du parc existant (pour DGEC)', dev=c('png', 'pdf')}

ggplot(conso_unitaire_branche_type[annee == "2009" ],aes(x="",conso_u, fill = usage) ) + 
           geom_bar(stat="identity", position = "stack") + 
           facet_wrap(~nom_branche, nrow = 1, label = labeller(nom_branche = label_wrap_gen(10))) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("Kwh par m²")+
#  geom_text(aes(label=conso_u),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7)+
  mytheme_facet_plot + xlab("")+scale_fill_brewer("Usage", palette = "Set3") 

#ggsave("../publication_thema/figures/Conso_u_Branche.pdf",width = 18, height=12)

```

### performance du parc par étiquette
```{r,  echo=F, warning=F,include = F}
###### calcul part des étiquettes énergie ####

besoins_parc_init[, CONSO_USAGES_RT_EP := sum(CONSO_CHAUFF_EP, CONSOU_ECS_EP*SURFACES, CONSOU_CLIM_EP*SURFACES, 
                                           BESOIN_AUXILIAIRES_CALC*2.58, BESOIN_VENTILATION*2.58, 
                                           BESOINU_ECLAIRAGE_EP*SURFACES, na.rm=T), by="ID"]

besoins_parc_init[, CONSOU_USAGES_RT_EP := CONSO_USAGES_RT_EP/SURFACES,  by="ID"]
besoins_parc_init[, CONSOU_TOT_EP :=  sum(CONSO_CHAUFF_EP,CONSOU_ECS_EP*SURFACES, CONSOU_CLIM_EP*SURFACES, 
                                       BESOIN_AUXILIAIRES_CALC*2.58, BESOIN_VENTILATION*2.58, 
                                       BESOINU_ECLAIRAGE_EP*SURFACES,BESOINU_BUREAUTIQUE_EP*SURFACES,
                                       BESOINU_FROID_EP*SURFACES, BESOINU_PROCESS_EP*SURFACES,BESOINU_AUTRES_EP*SURFACES,
                                       BESOINU_CUISSON_EP*SURFACES, na.rm=T)/SURFACES, by="ID"]
besoins_parc_init[, CONSOU_TOT :=  sum(CONSO_CHAUFF,CONSOU_ECS*SURFACES, CONSOU_CLIM*SURFACES, 
                                          BESOIN_AUXILIAIRES_CALC, BESOIN_VENTILATION, 
                                          BESOINU_ECLAIRAGE*SURFACES,BESOINU_BUREAUTIQUE*SURFACES,
                                          BESOINU_FROID*SURFACES, BESOINU_PROCESS*SURFACES,BESOINU_AUTRES*SURFACES,
                                          BESOINU_CUISSON*SURFACES, na.rm=T)/SURFACES, by="ID"]

Bornes_etiq = fread("table_param_origine/Etiquettes_Bornes.csv",  
                    colClasses = list("character" = c("CATEGORIE_ETIQUETTE","ETIQUETTE")))
Typebatiment_etiq = fread("table_param_origine/Etiquettes_Categories.csv",  
                          colClasses = list("character" = c("CATEGORIE_ETIQUETTE","BRANCHE", "BAT_TYPE")))



quantile(besoins_parc_init$CONSOU_USAGES_RT_EP)

etiq_ini = merge(besoins_parc_init, 
                 Typebatiment_etiq[,list(COD_BRANCHE = BRANCHE,
                                         COD_BAT_TYPE = BAT_TYPE, CATEGORIE_ETIQUETTE)], 
                 by=c("COD_BRANCHE","COD_BAT_TYPE"),all.x=T )


etiq_ini$conso
check_etiq = function(conso_U,categorie_bat){
  etiq = Bornes_etiq[CATEGORIE_ETIQUETTE == categorie_bat & 
                       conso_U >= CONSO_MIN & conso_U < CONSO_MAX,  ETIQUETTE]
  return(etiq)
}

etiq_ini[,ETIQUETTE := check_etiq(CONSOU_USAGES_RT_EP, CATEGORIE_ETIQUETTE),by="ID"]

etiq_ini[,sum(SURFACES, na.rm=T)/10^6/surf_tot_tertiaire, by="ETIQUETTE"][order(ETIQUETTE)]

etiq_BRANCHE = etiq_ini[,sum(SURFACES, na.rm=T)/10^6, by=c("BRANCHE","ETIQUETTE")]
etiq_BRANCHE = etiq_BRANCHE[,part := V1/sum(V1, na.rm=T)*100, by=c("BRANCHE")]
etiq_BRANCHE[part>2, partgraph := paste0(round(part, digits = 0), " %")]
etiq_BRANCHE[part<=2, partgraph := ""]

```


```{r Etiquette_ini, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Parts surfaces par étiquette', dev=c('png', 'pdf')}

ggplot(etiq_BRANCHE ,aes(x="",part, fill = ETIQUETTE) ) + 
           geom_bar(stat="identity", position = "stack") + 
           facet_wrap(~BRANCHE, nrow = 1, label = labeller(BRANCHE = label_wrap_gen(10))) +
  theme(axis.text.x = element_text(size = 12, hjust = 1,angle =45))+ ylab("% de la Branche")+
  geom_text(aes(label=partgraph),position = position_stack(vjust = 0.5), colour = "white", fontface = "bold", size = 7)+
  mytheme_facet_plot + xlab("") + scale_y_continuous(breaks = seq(0,100,20),limits =c(0,101))+scale_fill_discrete("étiquette")

#ggsave("../publication_thema/figures/Parcetiqbranche.pdf",width = 18, height=12)

```


\clearpage
\newpage 


## 6) Nombre de Rénovations et Investissements 

### Part du parc rénové

```{r,  echo=F, warning=F,include = F}

cout_geste = fread("table_param_origine/Bibli_geste_bati.csv", 
                   colClasses = list("character" = c("ID_AGREG","EXIGENCE","GESTE")))

cout_geste[, COD_BRANCHE:=substring(ID_AGREG, 1,2)]
cout_geste[, COD_SS_BRANCHE:=substring(ID_AGREG, 3,4)]
cout_geste[, COD_BAT_TYPE:=substring(ID_AGREG, 5,6)]
cout_geste[, COD_PERIODE_DETAIL :=substring(ID_AGREG, 7,8)]
cout_geste[, COD_PERIODE_SIMPLE:=substring(ID_AGREG, 9,10)]

cout_geste = merge(cout_geste, COD_BRANCHE, by="COD_BRANCHE") 
cout_geste = merge(cout_geste, COD_SS_BRANCHE, by="COD_SS_BRANCHE") 
cout_geste = merge(cout_geste, COD_BAT_TYPE, by="COD_BAT_TYPE") 
cout_geste = merge(cout_geste, COD_PERIODE_DETAIL, by="COD_PERIODE_DETAIL", all.x = T) 
cout_geste = merge(cout_geste, COD_PERIODE_SIMPLE, by="COD_PERIODE_SIMPLE") 

setkeyv(cout_geste,c("BRANCHE","SS_BRANCHE", "BAT_TYPE"))
ordre = unique(cout_geste$SS_BRANCHE)
cout_geste[, SS_BRANCHE:=factor(SS_BRANCHE, levels = ordre )]
cout_geste[, PERIODE_SIMPLE:=factor(PERIODE_SIMPLE)]
cout_geste[, PERIODE_SIMPLE:=relevel(PERIODE_SIMPLE, ref = "Av 1980")]

cout_geste[GAIN!=0,list(GAIN_moy = mean(GAIN,na.rm=T), COUT_moy = mean(COUT,na.rm=T)) , by="GESTE"]

cout_geste[,quantile(GAIN), by="GESTE"]

### 

Corresp_geste = data.table(GESTE = unique(cout_geste$GESTE))
Corresp_geste[GESTE %in% c("FENMOD","FENBBC","GTB"), GESTE_DGEC:="Rénovation faible"]
Corresp_geste[GESTE %in% c("FEN_MURBBC","FEN_MURMOD","ENSMOD"), GESTE_DGEC:="Rénovation moyenne"]
Corresp_geste[GESTE %in% c("ENSBBC"), GESTE_DGEC:="Rénovation importante"]


cout_geste = merge(cout_geste,Corresp_geste, by="GESTE")
cout_geste[,list(GAIN_moy = mean(GAIN,na.rm=T), COUT_moy = mean(COUT,na.rm=T)) , by="GESTE_DGEC"]


### calcul surfaces parc rénovés 

PM_geste_natio = COUTS[ typeRenovationBatiment !="Etat initial",]
PM_geste_natio = merge(PM_geste_natio,Corresp_geste, by.x="typeRenovationBatiment",by.y="GESTE")
PM_geste_natio[, annee := as.factor(annee)]
PM_geste_natio[,  GESTE_DGEC := factor(GESTE_DGEC, levels = c("Parc non touché","Rénovation faible","Dont GTB","Rénovation moyenne","Rénovation importante"))]

Surface_parc_Renov = PM_geste_natio[ typeRenovationBatiment !="Etat initial",list(Surface_Renov = sum(surface)),by=c("scenario","annee")]

Surface_parc_exi = parc_melted[, list(Surface_parc_exi = sum(Surface)),by=c("scenario","annee")]
Surface_parc_exi[, annee := as.factor(annee)]

Surface_parc_Renov = merge(Surface_parc_Renov ,Surface_parc_exi,by=c("scenario","annee"))
Surface_parc_Renov[, PM_Geste := 1-Surface_Renov/Surface_parc_exi,by=c("scenario","annee")]
Surface_parc_Renov[, "GESTE_DGEC" := "Parc non touché",]

Surface_parc_GTB = PM_geste_natio[ typeRenovationBatiment =="GTB",list(Surface_Renov = sum(surface)),by=c("scenario","annee")]
Surface_parc_GTB = merge(Surface_parc_GTB ,Surface_parc_exi,by=c("scenario","annee"))
Surface_parc_GTB[, PM_Geste := Surface_Renov/Surface_parc_exi,by=c("scenario","annee")]
Surface_parc_GTB[, "GESTE_DGEC" := "Dont GTB",]

PM_geste_natio = PM_geste_natio[ typeRenovationBatiment !="Etat initial", list(Surface_Renov = sum(surface)),by=c("scenario","annee","GESTE_DGEC")]

PM_geste_natio[,Surface_tot_Renov := sum(Surface_Renov ),by=c("scenario","annee")]
PM_geste_natio = merge(PM_geste_natio,Surface_parc_exi,by=c("scenario","annee")  )

PM_geste_natio[,PM_Geste := Surface_Renov/Surface_parc_exi]

tab_PM_geste = dcast.data.table(PM_geste_natio[annee %in% seq(2010,2050,5)], 
                                scenario+GESTE_DGEC~annee,value.var = "PM_Geste")
tab_PM_Non_Renov = dcast.data.table(Surface_parc_Renov[annee %in% seq(2010,2050,5)], scenario+GESTE_DGEC~annee,value.var = "PM_Geste")
tab_PM_Non_GTB = dcast.data.table(Surface_parc_GTB[annee %in% seq(2010,2050,5)], scenario+GESTE_DGEC~annee,value.var = "PM_Geste")
tab_PM_geste = rbindlist(list(tab_PM_Non_Renov,tab_PM_geste,tab_PM_Non_GTB) )
tab_PM_geste = replace(tab_PM_geste,is.na(tab_PM_geste),0)

tab_PM_geste[,  GESTE_DGEC := factor(GESTE_DGEC, levels = c("Parc non touché","Rénovation faible","Dont GTB","Rénovation moyenne","Rénovation importante"))]
tab_PM_geste = tab_PM_geste[order(GESTE_DGEC)]

## Cumul du parc rénové 
PM_geste_natio = PM_geste_natio[order(annee)]
PM_geste_natio_cum  = PM_geste_natio[, list(annee,Surface_tot_Renov,Surface_parc_exi,Surface_Renov_cum = cumsum(Surface_Renov)), by=c("scenario","GESTE_DGEC")]
PM_geste_natio_cum[, PM_Geste := Surface_Renov_cum/Surface_parc_exi]

tab_PM_geste_cum = dcast.data.table(PM_geste_natio_cum[annee %in% seq(2010,2050,5)], scenario+GESTE_DGEC~annee,value.var = "PM_Geste")

## PArc de l'Etat rénové
Surface_parc_Renov_Etat = COUTS[occupant == "03" & typeRenovationBatiment !="Etat initial",list(Surface_Renov = sum(surface)),by=c("scenario","annee")]

Surface_parc_Renov_Etat_Regl = COUTS[occupant == "03" & typeRenovationBatiment !="Etat initial"& reglementation=="ObligationTravaux", list(Surface_Renov_Regl = sum(surface)),by=c("scenario","annee")]

Surface_parc_Renov_Etat_perf =COUTS[occupant == "03" & typeRenovationBatiment !="Etat initial",list(Surface_Renov = sum(surface)),by=c("scenario","annee", "typeRenovationBatiment")]

Surface_parc_Renov_Etat_perf_Regl  =COUTS[occupant == "03" & typeRenovationBatiment !="Etat initial" & reglementation=="ObligationTravaux",list(Surface_Renov = sum(surface)),by=c("scenario","annee", "typeRenovationBatiment")]


if(nrow(Surface_parc_Renov_Etat_Regl)==0){
  Surface_parc_Renov_Etat_Regl = Surface_parc_Renov_Etat
  Surface_parc_Renov_Etat_Regl[,Surface_Renov_Regl:= 0]
}

Surface_parc_Etat_tot = 
dcast.data.table(parc_melted[occupation=="03" & Type_parc=="E", sum(Surface),by=c("scenario","annee")],  scenario ~annee,value.var = "V1")
Surface_parc_Etat_arenov = 
dcast.data.table(parc_melted[occupation=="03" & Type_parc=="E", sum(Surface)*0.03,by=c("scenario","annee")],  scenario ~annee,value.var = "V1")

#### verif part rénovée 
part_Etat_Renov = merge(parc_melted[occupation=="03" & Type_parc=="E", sum(Surface),by=c("scenario","annee")], 
                        Surface_parc_Renov_Etat , by=c("scenario","annee"))

part_Etat_Renov[, Part:=Surface_Renov/V1]
#part_Etat_Renov = merge(part_Etat_Renov, 
#                        Surface_parc_Renov_Etat_Regl , by=c("scenario","annee"))

#part_Etat_Renov[, Part_Regl:=Surface_Renov_Regl/V1]

part_Etat_Renov = merge(part_Etat_Renov, 
                        Surface_parc_Renov_Etat_perf[typeRenovationBatiment=="ENSBBC", list(scenario,annee,Surface_Renov_ENSBBC = Surface_Renov)], by=c("scenario","annee"))

part_Etat_Renov[, Part_ENSBBC:=Surface_Renov_ENSBBC/V1]


#### tableau export
Surface_parc_Renov_Etat = dcast.data.table(Surface_parc_Renov_Etat[annee %in% seq(2010,2050,5)], scenario~annee,value.var = "Surface_Renov")


Surface_parc_Renov_Etat_Regl = dcast.data.table(Surface_parc_Renov_Etat_Regl[annee %in% seq(2010,2050,5)], scenario~annee,value.var = "Surface_Renov_Regl")

Surface_parc_Renov_Etat_perf = dcast.data.table(Surface_parc_Renov_Etat_perf[annee %in% seq(2010,2050,5)], scenario + typeRenovationBatiment~annee,value.var = "Surface_Renov")


if(!empty(Surface_parc_Renov_Etat_perf_Regl)){
Surface_parc_Renov_Etat_perf_Regl = dcast.data.table(Surface_parc_Renov_Etat_perf_Regl[annee %in% seq(2010,2050,5)], scenario + typeRenovationBatiment~annee,value.var = "Surface_Renov")
}


# tab_PM_geste[,scenario := substring(scenario,1,2)]
# tab_PM_geste_cum[,scenario := substring(scenario,1,2)]
# Surface_parc_Renov_Etat[,scenario := substring(scenario,1,2)]

### calcul surfaces parc rénovés  par branche

PM_bati_branche = COUTS[typeRenovationBatiment != "Etat initial", list(Surface_Renov = sum(surface)),by=c("scenario","annee","branche","typeRenovationBatiment")]

Surface_parc_exi_branche = parc_melted[, list(Surface_parc_exi = sum(Surface)),by=c("scenario","annee","branche")]
Surface_parc_exi_branche[, annee := as.factor(annee)]

PM_bati_branche  = merge(PM_bati_branche  ,Surface_parc_exi_branche,by=c("scenario","annee","branche"))
PM_bati_branche[, PM_Geste := Surface_Renov/Surface_parc_exi,by=c("scenario","annee","branche")]
PM_bati_branche[ , sum(PM_Geste), by=c("scenario","annee","branche")]

NRF_branche = COUTS[typeRenovationBatiment != "Etat initial", list(Surface_Renov = sum(surface)),by=c("scenario","annee","branche")]
NRF_branche   = merge(NRF_branche   ,Surface_parc_exi_branche,by=c("scenario","annee","branche"))
NRF_branche[, PM_Geste := 1- Surface_Renov/Surface_parc_exi,by=c("scenario","annee","branche")]
NRF_branche[, typeRenovationBatiment := "NRF"]
PM_bati_branche = rbind(PM_bati_branche,NRF_branche)

PM_bati_branche[,sum(PM_Geste),by=c("scenario","annee","branche")][V1!=1]

NRF_branche = dcast(NRF_branche,scenario + branche ~ annee, value.var = "PM_Geste")


###### passage en pourcentage

tab_PM_geste_good <-  tab_PM_geste
tab_PM_geste_good <- tab_PM_geste_good[,lapply(.SD, function(x){round(x, digits=2)}), .SDcols=as.character(seq(2010,2050,5)), by=c("scenario","GESTE_DGEC")]


tab_PM_geste_cum_good <- tab_PM_geste_cum
tab_PM_geste_cum_good <- tab_PM_geste_cum_good[,lapply(.SD, function(x){round(x, digits=2)}), .SDcols=as.character(seq(2010,2050,5)), by=c("scenario","GESTE_DGEC")]


Surface_parc_Renov_Etat_good <- Surface_parc_Renov_Etat
Surface_parc_Renov_Etat_good  <- Surface_parc_Renov_Etat[,lapply(.SD, function(x){round(x/10^3, digits=2)}), .SDcols=as.character(seq(2010,2050,5)), by=c("scenario")]

```


```{r, echo=F, warning=F,}
pander(tab_PM_geste_good, digits = 2, caption = "Part du parc rénové annuellement par niveau de rénovation")
```



```{r, echo=F, warning=F,}
pander(tab_PM_geste_cum_good, digits = 2, caption = "Part du parc rénové (cumul)")
```

```{r, echo=F, warning=F,}
pander(Surface_parc_Renov_Etat, digits = 4, caption = "Parc de l'Etat rénové annuellement")
```

```{r, echo=F, warning=F,}
pander(Surface_parc_Renov_Etat_Regl, digits = 4, caption = "Parc de l'Etat rénové annuellement du fait de la directive patrimoine immobilier de l'Etat")
```

```{r, echo=F, warning=F,}
pander(NRF_branche[,c("scenario","branche",as.character( 2010:2020))] , digits = 3, caption = "Part du geste ne rien faire par branche")
```


\clearpage
\newpage

### Surfaces rénovées 

```{r,  echo=F, warning=F,include = F}

Surfaces_renov_gestes = COUTS[typeRenovationBatiment !="Etat initial",list(surface = sum(surface)/10^6,investissement = sum(investissement)/10^6), by=c("scenario","annee","typeRenovationBatiment")]
Surfaces_renov_gestes[,Geste := factor(typeRenovationBatiment, levels = c("GTB","FENMOD","FEN_MURMOD","ENSMOD","FENBBC","FEN_MURBBC","ENSBBC"))]
Surfaces_renov_gestes = Surfaces_renov_gestes[order(Geste)]

Surfaces_renov_gestes_cum = Surfaces_renov_gestes[,list(INV_cum_geste = cumsum(investissement),INV =investissement, 
                                                        surface_cum_geste = cumsum(surface),surface=surface,
                                                         Geste), by=c("scenario","annee")]


Surfaces_renov_gestes_cum[,Geste := factor(Geste, levels = rev(c("GTB","FENMOD","FEN_MURMOD","ENSMOD","FENBBC","FEN_MURBBC","ENSBBC")))]

Surfaces_renov_gestes_cum_sansGTB = Surfaces_renov_gestes[Geste!="GTB",list(INV_cum_geste = cumsum(investissement),INV =investissement, 
                                                        surface_cum_geste = cumsum(surface),surface=surface,
                                                         Geste), by=c("scenario","annee")]

Surfaces_renov_gestes_cum_sansGTB[,Geste := factor(Geste, levels = rev(c("FENMOD","FEN_MURMOD","ENSMOD","FENBBC","FEN_MURBBC","ENSBBC")))]


Surfaces_renov_syst = COUTS[typeRenovationSysteme != "Etat initial_NP",list(surface = sum(surface)/10^6,investissement = sum(investissement)/10^6), by=c("scenario","annee","typeRenovationSysteme","SYSTEME_CHAUD")]

COUTS[typeRenovationSysteme != "Etat initial_NP", unique(typeRenovationBatiment)]

Surfaces_renov_syst[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "DRV", "DRV performant",
                                                           "Autre système centralisé",  "Autre système centralisé performant",
                                                           "nr"))]
Surfaces_renov_syst  = merge(Surfaces_renov_syst ,colors_syst, by="SYSTEME_CHAUD")
Surfaces_renov_syst = Surfaces_renov_syst[order(SYSTEME_CHAUD)]


Surfaces_renov_syst_cum =Surfaces_renov_syst[,list(INV_cum_syst = cumsum(investissement),INV =investissement, 
                                                        surface_cum_syst = cumsum(surface),surface=surface,
                                                         SYSTEME_CHAUD, color), by=c("scenario","annee")]


Surfaces_renov_syst_cum[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = rev(levels(Surfaces_renov_syst$SYSTEME_CHAUD)))]


Surfaces_renov_syst_cum = Surfaces_renov_syst_cum[order(SYSTEME_CHAUD)]


write.table(dcast.data.table(Surfaces_renov_gestes_cum[scenario == scenario_toexport], scenario+Geste ~ annee, value.var = "surface"),paste0(wbdir_scenario_toexport,"surfaces_renov_geste_AMS.csv"),quote = T,dec = ".",sep=";", row.names= F)
write.table(dcast.data.table(Surfaces_renov_gestes_cum[scenario == scenario_toexport], scenario+Geste ~ annee, value.var = "INV"),paste0(wbdir_scenario_toexport,"INV_renov_geste_AMS.csv"),quote = T,dec = ".",sep=";", row.names= F)

write.table(dcast.data.table(Surfaces_renov_syst_cum[scenario == scenario_toexport], scenario+SYSTEME_CHAUD ~ annee, value.var = "surface"),paste0(wbdir_scenario_toexport,"surfaces_renov_syst_AMS.csv"),quote = T,dec = ".",sep=";", row.names= F)
write.table(dcast.data.table(Surfaces_renov_syst_cum[scenario == scenario_toexport], scenario+SYSTEME_CHAUD ~ annee, value.var = "INV"),paste0(wbdir_scenario_toexport,"INV_syst_geste_AMS.csv"),quote = T,dec = ".",sep=";", row.names= F)

```

```{r Surfaces_Renov_geste, fig.width=20, fig.height=13, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf'), caption ='Surfaces rénovées par geste'}
  
ggplot(Surfaces_renov_gestes_cum) + 
  geom_ribbon(aes(ymin = 0, annee, ymax =  surface_cum_geste, group =Geste, fill = Geste)) +  ylab("Millions de m²") + xlab("") +
  mytheme_facet_plot + scale_color_brewer(palette = fillpalette) +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
  scale_y_continuous() + facet_wrap(~scenario) + 
  scale_fill_brewer(palette = fillpalette) 

```

<!-- ```{r Surfaces_Renov_gestesansGTB, fig.width=20, fig.height=13, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf'), caption ='Surfaces rénovées par geste hors GTB'} -->

<!-- ggplot(Surfaces_renov_gestes_cum_sansGTB ) +  -->
<!--   geom_ribbon(aes(ymin = 0, annee, ymax =  surface_cum_geste, group =Geste, fill = Geste)) +  ylab("Millions de m²") + xlab("") + -->
<!--   mytheme_facet_plot + scale_color_brewer(palette = fillpalette) + -->
<!--   scale_x_discrete(breaks = seq(2010,2050,5), labels = -->
<!--                     seq(2010,2050,5)) + -->
<!--   scale_y_continuous() + facet_wrap(~scenario) +  -->
<!--   scale_fill_brewer(palette = fillpalette)  -->

<!-- ``` -->

```{r Surfaces_Renov_syst, fig.width=20, fig.height=13, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf'), caption ='Surfaces rénovées par geste'}
  
ggplot(Surfaces_renov_syst_cum) + 
  geom_ribbon(aes(ymin = 0, annee, ymax =  surface_cum_syst , group =SYSTEME_CHAUD, fill = SYSTEME_CHAUD)) +  ylab("Millions de m²")  + xlab("") +
  mytheme_facet_plot +
  scale_y_continuous(limits  = c(0,100)) + facet_wrap(~scenario) +
             theme(legend.position = "top") +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
  scale_fill_manual(values=unique(Surfaces_renov_syst_cum$color),
                    guide = guide_legend(nrow = 4)) 

```

\clearpage
\newpage

### Investissements

```{r,  echo=F, warning=F,include = F}
#### verif inv

COUTS[scenario == "S3 : AME 2017 run2 CEE final"  & typeRenovationBatiment == "ENSBBC" , sum(investissement)]/10^9
COUTS[scenario == "S3 : AME 2017 run2 CEE final"  & typeRenovationBatiment == "ENSBBC", sum(surface)]/10^6

COUTS[typeRenovationBatiment == "ENSBBC" & annee == "2018" ,list(sum(surface)/10^6, sum(investissement)/10^9, sum(investissement)/sum(surface)), by=c("scenario","branche")][order(branche)]

COUTS[scenario == "S3 : AME 2017 run2 CEE final"  & typeRenovationBatiment == "FEN_MURBBC" & typeRenovationSysteme == "Etat initial_NP" ,list(sum(surface)/10^6, sum(investissement)/10^9, sum(investissement)/sum(surface)), by="branche"]
COUTS[scenario == scenario_ref  & typeRenovationBatiment == "FEN_MURBBC" & typeRenovationSysteme == "Etat initial_NP" ,list(sum(surface)/10^6, sum(investissement)/10^9, sum(investissement)/sum(surface)), by="branche"]


INV_GESTE[scenario == "S5 : AME 2017 run2 CEE final"]


### calcul investissement annuel et cumulés


INV_AUTRES_TOT = INV_AUTRES_renov[,list(INV = sum(value)), by=c("scenario","annee")]
INV_GESTE_TOT = INV_GESTE[,list(INV = sum(value)), by=c("scenario","annee")]
INV_SYST_CHAUD_TOT = INV_SYST_CHAUD[,list(INV = sum(value)), by=c("scenario","annee")]


unique(COUTS$typeRenovationSysteme)
unique(COUTS$SYSTEME_CHAUD)

COUTS[,list(surface = sum(surface)), by=c("scenario","annee")]


INV_GESTE_TOT[,list(INV = sum(INV)/10^3), by=c("scenario")]
INV_SYST_CHAUD_TOT[,list(INV = sum(INV)/10^3), by=c("scenario")]

INV_SYST_CHAUD[,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = c("Chaudière gaz","Chaudière condensation gaz",
                                                           "Chaudière fioul","Chaudière condensation fioul",
                                                           "Electrique direct","Electrique direct performant",
                                                           "PAC","PAC performant",
                                                           "Rooftop", "Rooftop performant",
                                                           "Tube radiant", "Tube radiant performant" ,
                                                           "Cassette rayonnante","Cassette rayonnante performant",
                                                           "DRV", "DRV performant",
                                                           "Autre système centralisé",  "Autre système centralisé performant",
                                                           "nr"))]

INV_SYST_CHAUD = merge(INV_SYST_CHAUD ,colors_syst, by="SYSTEME_CHAUD")
INV_SYST_CHAUD = INV_SYST_CHAUD[order(SYSTEME_CHAUD)]

INV_SYST_tab = INV_SYST_CHAUD[,list(INV = sum(value, na.rm=T)/10^3), by=c("scenario", "SYSTEME_CHAUD","color")]
INV_SYST_tab =INV_SYST_tab[INV >0.01]
INV_SYST_tab = INV_SYST_tab[order(SYSTEME_CHAUD)]


INV_SYST_cum = INV_SYST_CHAUD [,list(INV_cum_syst = cumsum(value),INV =value, SYSTEME_CHAUD, color), by=c("scenario","annee")]

INV_SYST_cum [,SYSTEME_CHAUD := factor(SYSTEME_CHAUD, levels = rev(levels(INV_SYST_CHAUD$SYSTEME_CHAUD)))]
INV_SYST_cum  = INV_SYST_cum [order(SYSTEME_CHAUD)]



INV_GESTE[,Geste := factor(variable, levels = c("GTB","FENMOD","FEN_MURMOD","ENSMOD","FENBBC","FEN_MURBBC","ENSBBC"))]

INV_GESTE_tab = INV_GESTE[,list(INV = sum(value, na.rm=T)/10^3), by=c("scenario","Geste")]

INV_GESTE_tab [,Geste := factor(Geste, levels = c("GTB","FENMOD","FEN_MURMOD","ENSMOD","FENBBC","FEN_MURBBC","ENSBBC"))]

INV_GESTE_tab = INV_GESTE_tab[order(Geste)]

INV_GESTE = INV_GESTE[order(Geste)]
INV_GESTE_cum = INV_GESTE[,list(INV_cum_geste = cumsum(value),INV =value, Geste), by=c("scenario","annee")]

INV_GESTE_cum[,Geste := factor(Geste, levels = rev(c("GTB","FENMOD","FEN_MURMOD","ENSMOD","FENBBC","FEN_MURBBC","ENSBBC")))]


INV_AUTRES_renov[,Usages := factor(variable, levels = c("Climatisation","ECS","Eclairage"))]

INV_AUTRES_renov = INV_AUTRES_renov[order(Usages)]
INV_AUTRES_renov_cum = INV_AUTRES_renov[,list(INV_cum_autres = cumsum(value),INV =value, Usages), by=c("scenario","annee")]

INV_AUTRES_renov_cum[,Usages := factor(Usages, levels = rev(c("Climatisation","ECS","Eclairage")))]


INV_GESTE_branche[,Geste := factor(variable, levels = c("GTB","FENMOD","FEN_MURMOD","ENSMOD","FENBBC","FEN_MURBBC","ENSBBC"))]
INV_GESTE_branche = INV_GESTE_branche[order(Geste)]

INV_GESTE_cum_branche = INV_GESTE_branche[,list(INV_cum_geste = cumsum(value),INV =value, Geste), by=c("scenario","annee", "branche")]

INV_GESTE_cum_branche[,Geste := factor(Geste, levels = rev(c("GTB","FENMOD","FEN_MURMOD","ENSMOD","FENBBC","FEN_MURBBC","ENSBBC")))]

```


```{r INV_syst, fig.width=20, fig.height=13, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}
ggplot(INV_SYST_tab ) +
  geom_bar(aes(scenario,INV, color =SYSTEME_CHAUD,fill =SYSTEME_CHAUD), stat = "identity") +
  ylab("Mds euros") + ggtitle("Investissements cumulées dans les systèmes de chauffage") + xlab("scenario") +
  mytheme_facet_plot + 
  scale_y_continuous(limits  = c(0,100)) +  theme(legend.position = "top") +
  scale_fill_manual(values=unique(INV_SYST_tab$color),
                    guide = guide_legend(nrow = 4)) 


ggplot(INV_SYST_cum) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = INV_cum_syst, group =SYSTEME_CHAUD, fill = SYSTEME_CHAUD)) + 
    ylab("Millions d'euros") + facet_wrap(~scenario) +  ggtitle("Investissements dans les systèmes de chauffage")+       xlab("annee") +   scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
  mytheme_facet_plot +  theme(legend.position = "top") +
  scale_fill_manual(values=unique(INV_SYST_cum$color),
                    guide = guide_legend(nrow = 4)) 
  
```

```{r INV_Gestes, fig.width=20, fig.height=13, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}
  
ggplot(INV_GESTE_tab ) +
  geom_bar(aes(scenario,INV, color =Geste,fill =Geste), stat = "identity") +
  ylab("Mds euros") + ggtitle("Investissements cumulées dans les rénovations") + xlab("scenario") +
  mytheme_facet_plot  +
  scale_y_continuous(limits  = c(0,300)) + scale_fill_brewer(palette = fillpalette, direction = -1) 

ggplot(INV_GESTE_cum) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = INV_cum_geste, group =Geste, fill = Geste)) + 
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
    ylab("Millions d'euros") + ggtitle("Investissements dans les rénovations") + facet_wrap(~scenario) +
  mytheme_facet_plot + scale_fill_brewer(palette = fillpalette) 
  
```

```{r INV_geste_branche, fig.width=20, fig.height=13, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}
ggplot(INV_GESTE_cum_branche) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = INV_cum_geste, group =Geste, fill = Geste)) + 
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
    ylab("Millions d'euros") + ggtitle("Investissements dans les rénovations par branche du parc tertiaire") + facet_wrap(~scenario + branche, ncol=8) +
  mytheme_facet_plot + scale_fill_brewer(palette = fillpalette) 
  
  
```

```{r INV_Autres, fig.width=20, fig.height=9, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}
  

ggplot(INV_AUTRES_renov_cum) + 
  geom_ribbon(aes(ymin = 0, annee, ymax =  INV_cum_autres, group =Usages, fill = Usages)) + 
    ylab("Millions d'euros") + ggtitle("Investissements dans les autres usages RT") + facet_wrap(~scenario) +
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
  mytheme_facet_plot + scale_fill_brewer(palette = fillpalette) 


```

```{r,  echo=F, warning=F,include = F}

##### investissments totaux 

COUTS_all = rbind(COUTS[,list(INV_tot = sum(investissement),surface= sum(surface),aides = sum(aides),
                              prets = sum(prets),pretsBonifies = sum(pretsBonifies)),
                        by=c("scenario","annee","branche","occupant","reglementation")],
                  COUTS_AUTRES[,list(INV_tot = sum(investissement),surface= sum(surface),aides = sum(aides),
                                     prets = sum(prets),pretsBonifies = sum(pretsBonifies)),
                               by=c("scenario","annee","branche","occupant","reglementation")])
COUTS_all = rbind(COUTS[,list(INV_tot = sum(investissement),surface= sum(surface),aides = sum(aides),
                              prets = sum(prets),pretsBonifies = sum(pretsBonifies)),
                        by=c("scenario","annee","branche","occupant","reglementation")],
                  COUTS_AUTRES[,list(INV_tot = sum(investissement),surface= sum(surface),aides = sum(aides),
                                     prets = sum(prets),pretsBonifies = sum(pretsBonifies)),
                               by=c("scenario","annee","branche","occupant","reglementation")])

####### Investissements par politique/canal/aidés ou non

INV_Reglementation = COUTS_all[,list(INV_tot = sum(INV_tot),surface= sum(surface),aides = sum(aides)), by=c("scenario","annee", "reglementation")]


INV_Reglementation[,reglementation := factor(reglementation, levels = c("non","Décret", "ObligationTravaux"))]

INV_Reglementation_cum = INV_Reglementation[order(reglementation)]

INV_Reglementation_cum = INV_Reglementation[,list(INV_cum = cumsum(INV_tot),INV_tot, reglementation), by=c("scenario","annee")]
INV_Reglementation_cum[,reglementation := factor(reglementation, levels = rev(c("non","Décret", "ObligationTravaux")))]

INV_Reglementation[,sum(INV_tot),by=c("scenario","reglementation")]
INV_Reglementation[,sum(surface),by=c("scenario","reglementation")]

INV_Reglementation_Chauffage = COUTS[,list(INV_tot = sum(investissement),surface= sum(surface),aides = sum(aides)), by=c("scenario","annee", "reglementation")]


INV_Reglementation_Chauffage[,reglementation := factor(reglementation, levels = c("non","Décret", "ObligationTravaux"))]

INV_Reglementation_Chauffage_cum = INV_Reglementation_Chauffage[order(reglementation)]

INV_Reglementation_Chauffage_cum = INV_Reglementation_Chauffage[,list(INV_cum = cumsum(INV_tot),INV_tot, reglementation), by=c("scenario","annee")]
INV_Reglementation_Chauffage_cum[,reglementation := factor(reglementation, levels = rev(c("non","Décret", "ObligationTravaux")))]

INV_Reglementation_Chauffage[,sum(INV_tot),by=c("scenario","reglementation")]
INV_Reglementation_Chauffage[,sum(surface),by=c("scenario","reglementation")]


#### investissements au m²

INV_Reglementation[,INV_m2 := INV_tot/surface]

#### investissements aidés pour le chauffage

INV_aides = COUTS[,list(INV_tot = sum(investissement),surface= sum(surface),aides = sum(aides), prets = sum(prets),pretsBonifies = sum(pretsBonifies)), by=c("scenario","annee","branche","occupant","reglementation")]

INV_aides = INV_aides[aides>0]

INV_aides[,unique(annee)]

INV_aides[,sum(aides)/10^6]

COUTS[aides+prets+pretsBonifies -investissement > 4000 ]
COUTS[aides+prets+pretsBonifies -investissement < -4000 ]

INV_aides_cum = COUTS[,list(aides = sum(aides), prets = sum(prets),
                                pretsBonifies = sum(pretsBonifies)), by=c("scenario","annee")]

INV_aides_cum = melt(INV_aides_cum, id.vars = c("scenario","annee"))

INV_aides_cum[,Type_Fin := factor(variable, levels = c("prets","aides","pretsBonifies"))]

INV_aides_cum = INV_aides_cum[order(Type_Fin)]

INV_aides_cum = INV_aides_cum[,list(INV_cum = cumsum(value),INV_tot = value, Type_Fin), by=c("scenario","annee")]
INV_aides_cum[, Type_Fin := factor(Type_Fin, levels = rev(c("prets","aides","pretsBonifies")))]


INV_aides_regl_cum = COUTS[,list(aides = sum(aides), prets = sum(prets),pretsBonifies = sum(pretsBonifies)), by=c("scenario","annee","reglementation")]

INV_aides_regl_cum = melt(INV_aides_regl_cum, id.vars = c("scenario","annee","reglementation"))

INV_aides_regl_cum[,Type_Fin := factor(variable, levels = c("prets","aides","pretsBonifies"))]

INV_aides_regl_cum  = INV_aides_regl_cum [order(Type_Fin)]

INV_aides_regl_cum = INV_aides_regl_cum[,list(INV_cum = cumsum(value),INV_tot = value, Type_Fin), by=c("scenario","annee","reglementation")]
INV_aides_regl_cum[, Type_Fin := factor(Type_Fin, levels = rev(c("prets","aides","pretsBonifies")))]

##### part des aides dans l'investissements

COUTS_AUTRES[pretsBonifies> 0]
COUTS_AUTRES[aides> 0]
COUTS_AUTRES[reglementation != "non"]

INV_aides_bilan = COUTS[,list(investissement=sum(investissement),pretsBonifies = sum(pretsBonifies), aides = sum(aides)), by=c("scenario","annee")]
INV_aides_bilan[aides <0]

INV_aides_bilan[,taux_aides := aides/investissement]
INV_aides_bilan[,taux_pretsBon := pretsBonifies/investissement]

### aides quinquennat

INV_aides_bilan[annee %in% 2017:2022,list(investissement=sum(investissement)/10^6,pretsBonifies = sum(pretsBonifies)/10^6, aides = sum(aides)/10^6), by=c("scenario")]

INV_aides_quinquennat = INV_aides_bilan[annee %in% 2015:2022,list(investissement=sum(investissement)/10^6,pretsBonifies = sum(pretsBonifies)/10^6, aides = sum(aides)/10^6), by=c("scenario")]

INV_aides_2050 = INV_aides_bilan[annee %in% 2015:2050,list(investissement=sum(investissement)/10^6,pretsBonifies = sum(pretsBonifies)/10^6, aides = sum(aides)/10^6, taux_aides_moy = sum(aides)/sum(investissement), taux_pret_moy=sum(pretsBonifies)/sum(investissement)), by=c("scenario")]

### total reglementation 
INV_regl_bilan = COUTS[,list(investissement=sum(investissement),pretsBonifies = sum(pretsBonifies), aides = sum(aides)), by=c("scenario","reglementation","annee")]
INV_regl_bilan_cum =  COUTS[,list(investissement=sum(investissement)/10^6,pretsBonifies = sum(pretsBonifies)/10^6, aides = sum(aides)/10^6), by=c("scenario","reglementation")]


### tableaux investissements DGEC


Tab_inv_DGEC = COUTS[,list(INV = sum(investissement), surface= sum(surface)) , by=c("scenario","annee","typeRenovationBatiment","typeRenovationSysteme")]

Tab_inv_DGEC[typeRenovationBatiment =="Etat initial" & typeRenovationSysteme != "Etat initial_NP",Type_Inv :="Changement de système seul"]
Tab_inv_DGEC[typeRenovationBatiment !="Etat initial" & typeRenovationSysteme == "Etat initial_NP",Type_Inv :="Geste sur le bâti"]
Tab_inv_DGEC[typeRenovationBatiment !="Etat initial" & typeRenovationSysteme != "Etat initial_NP",Type_Inv :="Geste sur le bâti et Changement de système"]


Tab_inv_DGEC = Tab_inv_DGEC[,list(INV_Md = sum(INV)/10^9, surface= sum(surface)) , by=c("scenario","annee","Type_Inv")]
Tab_inv_DGEC_ini =  dcast.data.table(Tab_inv_DGEC[annee %in% seq(2010,2015)],scenario + Type_Inv~annee,value.var ="INV_Md")
Tab_inv_DGEC[annee %in% seq(2010,2015)][,sum(INV_Md), by=c("annee", "scenario")] 
Tab_inv_DGEC[annee =="2050"]


Tab_inv_DGEC_all = dcast.data.table(Tab_inv_DGEC[],scenario + Type_Inv~annee,value.var ="INV_Md")
if(write_excel ==T){
write.table(Tab_inv_DGEC_all[scenario == scenario_toexport] , paste0(wbdir_scenario_toexport,"Inv_type_DGEC_AMS.csv"),quote = T,row.names = F, sep=";", dec=".")
}

Tab_inv_DGEC = dcast.data.table(Tab_inv_DGEC[annee %in% seq(2010,2050,5)],scenario + Type_Inv~annee,value.var ="INV_Md")

Tab_inv_DGEC_ini[,get("2010")+get("2011")+get("2012")+get("2013")+get("2014")+get("2015")]/6

Tab_inv_DGEC_cum = COUTS[,list(INV = sum(investissement), surface= sum(surface)) , by=c("scenario","annee","typeRenovationBatiment","typeRenovationSysteme")]

Tab_inv_DGEC_cum[typeRenovationBatiment =="Etat initial" & typeRenovationSysteme != "Etat initial_NP",Type_Inv :="Changement de système seul"]
Tab_inv_DGEC_cum[typeRenovationBatiment !="Etat initial" & typeRenovationSysteme == "Etat initial_NP",Type_Inv :="Geste sur le bâti"]
Tab_inv_DGEC_cum[typeRenovationBatiment !="Etat initial" & typeRenovationSysteme != "Etat initial_NP",Type_Inv :="Geste sur le bâti et Changement de système"]

Tab_inv_DGEC_cum = Tab_inv_DGEC_cum[,list(annee,INV_Md = sum(INV)/10^9, surface= sum(surface)) , by=c("scenario","annee","Type_Inv")]

Tab_inv_DGEC_cum <- Tab_inv_DGEC_cum[order(annee)]
Tab_inv_DGEC_cum = Tab_inv_DGEC_cum[,list(annee,INV_Md,INV_Md_cum = cumsum(INV_Md),
                                          surface_cum= cumsum(surface)) , by=c("scenario","Type_Inv")]

Tab_inv_DGEC_cum[annee =="2050" & scenario=="S4"]
Tab_inv_DGEC_cum = dcast.data.table(Tab_inv_DGEC_cum[annee %in% seq(2010,2050,5)],scenario + Type_Inv~annee,value.var ="INV_Md_cum")

##### investisstements par type sur le chauffage
graph_INVpres = Tab_inv_DGEC_all

graph_INVpres = melt(graph_INVpres, id.vars = c("scenario","Type_Inv"),value.name = "INV_Md",variable.name = "annee")
graph_INVpres[,INV_Md_cum := cumsum(INV_Md),by=c("scenario","annee")]
graph_INVpres[,Type_Inv := factor(Type_Inv,levels = c( "Geste sur le bâti et Changement de système","Geste sur le bâti","Changement de système seul"))]
graph_INVpres= graph_INVpres[order(Type_Inv)]
```

```{r INV_Type, fig.width=20, fig.height=9, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}

ggplot(graph_INVpres) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = INV_Md_cum, group =Type_Inv, fill = Type_Inv)) +
  
    ylab("Millions d'euros") + facet_wrap(~scenario) + 
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
  xlab("annee") + scale_fill_manual(values = c(color_energie$color[c(5,2,1)])) +
  mytheme_facet_plot

```


```{r INV_Renov_reglementation, fig.width=20, fig.height=9, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}

ggplot(INV_Reglementation_Chauffage_cum) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = INV_cum/10^6, group =reglementation, fill = reglementation)) +
  
    ylab("Millions d'euros") + facet_wrap(~scenario) +  ggtitle("Investissements (Chauffage) par réglementation")+    
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
  xlab("annee") +
  mytheme_facet_plot

```


```{r INV_aides, fig.width=20, fig.height=9, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}

ggplot(INV_aides_cum) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = INV_cum/10^6, group =Type_Fin, fill = Type_Fin)) + 
  ylab("Millions d'euros") + facet_wrap(~scenario) + 
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
  ggtitle("Investissements et type de financement")+       xlab("annee") +
  mytheme_facet_plot

```

```{r INV_aides_regl, fig.width=20, fig.height=9, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}

ggplot(INV_aides_regl_cum) + 
  geom_ribbon(aes(ymin = 0, annee, ymax = INV_cum/10^6, group =Type_Fin, fill = Type_Fin)) + 
  ylab("Millions d'euros") + facet_wrap(~scenario + reglementation, ncol=3) + 
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
  ggtitle("Investissements et type de financement par réglementation")+       xlab("annee") +
  mytheme_facet_plot

```

```{r INV_regl_bilan, fig.width=20, fig.height=9, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}

ggplot(INV_regl_bilan_cum) + geom_bar(aes(scenario,investissement/10^3,fill=reglementation),stat = "identity",position = "dodge")+mytheme_facet_plot + scale_y_continuous(breaks = seq(0,150,5))+
    ylab("Milliards d'euros") + ggtitle("Investissements cumulés avec ou sans obligation")


```

```{r INV_pretsBon, fig.width=20, fig.height=9, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}

ggplot(INV_aides_bilan) + geom_line(aes(annee,pretsBonifies/10^6, group=scenario,color=scenario), size=2)+mytheme_facet_plot +
    ylab("Millions d'euros") +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
   ggtitle("Prets Bonifiés")
  

```



```{r Taux_aides, fig.width=20, fig.height=9, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}

ggplot(INV_aides_bilan) + geom_line(aes(annee,taux_aides, group=scenario,color=scenario), size=2)+mytheme_facet_plot +
    ylab("Millions d'euros") +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
   ggtitle("taux de subvention (CEE)")
  

```

```{r Taux_prets, fig.width=20, fig.height=9, echo=F, warning=F, fig.show='hold', dev=c('png', 'pdf')}

ggplot(INV_aides_bilan) + geom_line(aes(annee,taux_pretsBon, group=scenario,color=scenario), size=2)+mytheme_facet_plot +
    ylab("Millions d'euros") +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) +
   ggtitle("Part des prets bonifiés dans l'investissement")

```




```{r, echo=F, warning=F,}
pander(INV_aides_quinquennat, digits = 2, caption = "Investissements totaux (millions d'euros) et part des aides entre 2015 et 2022 (approximation du quinquennat)")
```

```{r, echo=F, warning=F,}
pander(INV_aides_2050, digits = 2, caption = "Investissements totaux (millions d'euros) et part des aides entre 2015 et 2050")
```


```{r, echo=F, warning=F,}
pander(Tab_inv_DGEC_cum[,c("scenario","Type_Inv","2015","2020","2030","2050"), with=F] , digits = 2, caption = "Investissements cumulés par type d'investissement (milliards d'euros")
```




\clearpage
\newpage

## 7) Emissions

```{r,  echo=F, warning=F,include = F}
### Facteurs d'émissions
FE = fread("../tertiaire/parametrage modèle/Facteuremissions.csv", sep = ";", header = T)
FE_AME = data.table(read_excel("../tertiaire/parametrage modèle/Facteuremissions_thema.xls", sheet = "FEexportAME"))
FE_AMS = data.table(read_excel("../tertiaire/parametrage modèle/Facteuremissions_thema.xls", sheet = "FEexportAMS"))
  
  
FE = melt(FE,id.vars = c("energie","usage"),value.name = "FE",variable.name = "annee")
FE[,annee:=as.character(annee)]

FE_AME = melt(FE_AME,id.vars = c("energie","usage"),value.name = "FE_AME",variable.name = "annee")
FE_AME[,annee:=as.character(annee)]

FE_AMS = melt(FE_AMS,id.vars = c("energie","usage"),value.name = "FE_AMS",variable.name = "annee")
FE_AMS[,annee:=as.character(annee)]


Em_nationale_energie_type_usage = merge(Conso_nationale_energie_type_usage, FE,by=c("energie","usage","annee"))
Em_nationale_energie_usage = merge(Conso_nationale_energie_usage, FE,by=c("energie","usage","annee"))
Em_nationale_energie_type_usage = merge(Em_nationale_energie_type_usage , FE_AME,by=c("energie","usage","annee"))
Em_nationale_energie_usage = merge(Em_nationale_energie_usage, FE_AME,by=c("energie","usage","annee"))
Em_nationale_energie_type_usage = merge(Em_nationale_energie_type_usage , FE_AMS,by=c("energie","usage","annee"))
Em_nationale_energie_usage = merge(Em_nationale_energie_usage, FE_AMS,by=c("energie","usage","annee"))

Em_nationale_energie_type_usage[,EmMtCO2 := conso_tWhEF*FE*10^9*10^-12]
Em_nationale_energie_usage[,EmMtCO2 := conso_tWhEF*FE*10^9*10^-12]
Em_nationale_energie_type_usage[scenario =="S3 AMS",EmMtCO2_socio := conso_tWhEF*FE_AMS*10^9*10^-12]
Em_nationale_energie_type_usage[scenario !="S3 AMS",EmMtCO2_socio := conso_tWhEF*FE_AME*10^9*10^-12]
Em_nationale_energie_usage[scenario =="S3 AMS",EmMtCO2_socio := conso_tWhEF*FE_AMS*10^9*10^-12]
Em_nationale_energie_usage[scenario !="S3 AMS",EmMtCO2_socio := conso_tWhEF*FE_AME*10^9*10^-12]



Em_nationale_energie_type = Em_nationale_energie_type_usage[, list(EmMtCO2 = sum(EmMtCO2)), by=c("scenario","annee", "energie","Type_parc")]

Em_nationale_energie = Em_nationale_energie_usage[, list(EmMtCO2 = sum(EmMtCO2),EmMtCO2_socio = sum(EmMtCO2_socio ) ), by=c("scenario","annee", "energie")]

Em_nationale_usage = Em_nationale_energie_usage[, list(EmMtCO2 = sum(EmMtCO2),EmMtCO2_socio = sum(EmMtCO2_socio ) ), by=c("scenario","annee", "usage")]
Em_nationale_energie_type[,energie:=factor(energie, levels = color_energie$ENERGIE)]
Em_nationale_energie[,energie:=factor(energie, levels = color_energie$ENERGIE)] 
Em_nationale_energie_usage[,energie:=factor(energie, levels = color_energie$ENERGIE)] 

Em_nationale = Em_nationale_usage[, list(EmMtCO2 = sum(EmMtCO2),EmMtCO2_socio = sum(EmMtCO2_socio )), by=c("scenario","annee")]

Evol_Em = dcast.data.table(Em_nationale[annee%in%c("2015","2020","2025","2030","2035","2050")], scenario~annee, value.var = "EmMtCO2_socio")

annee_ref2 = "2015"

Evol_Em = Evol_Em[,list(scenario,
                Evol_2015 = paste0(round((get("2015")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2020 = paste0(round((get("2020")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2020 = paste0(round((get("2025")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2030 = paste0(round((get("2030")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2035 = paste0(round((get("2035")/get(annee_ref2)-1)*100, digits=1), " %"),
                Evol_2050 = paste0(round((get("2050")/get(annee_ref2)-1)*100, digits=1), " %"))]


```


```{r Evol_Em_energie, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Evolution des émissions pour tous les usages par énergie', dev=c('png', 'pdf')}
ggplot(Em_nationale_energie) +
           geom_bar(aes(annee,  EmMtCO2, fill = energie), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot+ theme(legend.position = "top") +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5))  + scale_fill_manual("",values=color_energie$color) 

ggplot(Em_nationale_energie) +
           geom_bar(aes(annee,  EmMtCO2_socio, fill = energie), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot+ theme(legend.position = "top") +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5))  + scale_fill_manual("",values=color_energie$color) 

```

```{r Evol_Em_energie_chauffage, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Evolution des émissions pour le chauffage par énergie', dev=c('png', 'pdf')}

ggplot(Em_nationale_energie_usage[usage == "Chauffage"]) +
           geom_bar(aes(annee, EmMtCO2, fill = energie), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot+ theme(legend.position = "top") +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5))  + scale_fill_manual("",values=color_energie$color) 

ggplot(Em_nationale_energie_usage[usage == "Chauffage"]) +
           geom_bar(aes(annee, EmMtCO2_socio, fill = energie), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot+ theme(legend.position = "top") +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) + scale_fill_manual("",values=color_energie$color) 
 


```

```{r Evol_Em_usage, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Evolution des émissions par usage', dev=c('png', 'pdf')}

ggplot(Em_nationale_usage) +
           geom_bar(aes(annee, EmMtCO2, fill = usage, color = usage), stat="identity") +
           facet_wrap(~scenario, nrow = 1) +
           mytheme_facet_plot+ theme(legend.position = "top") +
  scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5)) 

```

```{r Evol_Em_tot, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Evolution des émissions totales', dev=c('png', 'pdf')}

ggplot(Em_nationale) + geom_line(aes(annee,  EmMtCO2_socio, group=scenario,color= scenario), size = 3) + 
     mytheme_facet_plot  + ylab("Emissions en MtCO2") + 
    scale_x_discrete(breaks = seq(2010,2050,5), labels =
                    seq(2010,2050,5))  + 
  scale_y_continuous(limits = c(0,50),breaks = seq(0,50,10))
ggsave("../publication_thema/présentation/Em_tot.png",width = 18, height=12)

```

```{r, echo=F, warning=F,}
pander(Evol_Em, caption = "Evolution des émissions totales")
```
# 8) indicateurs socio eco

```{r,  echo=F, warning=F,include = F}
### bilan socio eco du point de vue de la collectivité


##### prix des énergies
require(readxl)
require(data.table)
prix_ener_socio_AME = data.table(read_excel("../publication_thema/hypothèses_prix/Prix_scenario_thema.xls", sheet = "prix_socio_eco_AME"))
prix_ener_socio_AMS = data.table(read_excel("../publication_thema/hypothèses_prix/Prix_scenario_thema.xls", sheet = "prix_socio_eco_AMS"))
prix_usager_AME = data.table(read_excel("../publication_thema/hypothèses_prix/Prix_scenario_thema.xls", sheet = "prix_usager_AME"))
prix_usager_AMS = data.table(read_excel("../publication_thema/hypothèses_prix/Prix_scenario_thema.xls", sheet = "prix_usager_AMS"))


prix_ener_socio_AME = melt(prix_ener_socio_AME, id.vars = "annee",variable.name = "energie",value.name = "prix_socio_eco_AME")
prix_usager_AME  = melt(prix_usager_AME, id.vars = "annee",variable.name = "energie",value.name = "prix_usager_AME")
prix_usager_AMS  = melt(prix_usager_AMS , id.vars = "annee",variable.name = "energie",value.name = "prix_usager_AMS")
prix_ener_socio_AMS = melt(prix_ener_socio_AMS, id.vars = "annee",variable.name = "energie",value.name = "prix_socio_eco_AMS")

prix_all = merge(prix_ener_socio_AME,prix_usager_AME, by=c("annee","energie"))
prix_all = merge(prix_all,prix_usager_AMS, by=c("annee","energie"))
prix_all = merge(prix_all,prix_ener_socio_AMS, by=c("annee","energie"))
prix_all[,annee:=as.character(annee)]

# 
prix_ener_socio_AME[annee %in% c(2015, 2030,2050)]
prix_ener_socio_AMS[annee %in% c(2015, 2030,2050)]
FE_AMS[annee %in% c(2015, 2030,2050) & usage == "Chauffage"]
FE_AME[annee %in% c(2015, 2030,2050)& usage == "Chauffage"]
#### Consommations chauffage par énergie

COnso_an_chauffage = Conso_nationale_energie_usage[usage=="Chauffage"]

#### Emissions chauffage 
bilan_socio = merge(COnso_an_chauffage, FE_AME, by=c("annee","energie", "usage"))
bilan_socio = merge(bilan_socio , FE_AMS, by=c("annee","energie", "usage"))

bilan_socio[, Emiss_Mt_AMS := conso_tWhEF*FE_AMS*10^-3]
bilan_socio[, Emiss_Mt_AME := conso_tWhEF*FE_AME*10^-3]

#### Depenses_ener 
bilan_socio = merge(bilan_socio,prix_all, by=c("annee","energie"))

bilan_socio[,Depense_socio_AMS := conso_tWhEF*prix_socio_eco_AMS*10^-3]
bilan_socio[,Depense_socio_AME := conso_tWhEF*prix_socio_eco_AME*10^-3]

#bilan_socio[scenario=="AME",Depense_usager := conso_tWhEF*prix_usager_AME*10^-3]
#bilan_socio[scenario=="AMS",Depense_usager := conso_tWhEF*prix_usager_AMS*10^-3]
bilan_socio[,Depense_usager_AME := conso_tWhEF*prix_usager_AME*10^-3]
bilan_socio[,Depense_usager_AMS := conso_tWhEF*prix_usager_AMS*10^-3]

#### Recettes TC
TC_an = data.table(read_excel("../publication_thema/hypothèses_prix/Prix_scenario_thema.xls", sheet = "TC"))
TC_an[,annee:=as.character(annee)]

bilan_socio = merge(bilan_socio,TC_an,by="annee")
bilan_socio[energie %in% c("Electricité", "Urbain","Autres"), TC_AME := 0]
bilan_socio[energie %in% c("Electricité", "Urbain","Autres"), TC_AMS := 0]

bilan_socio[,Recettes_TC_AME := Emiss_Mt_AMS*TC_AMS*10^-3]
bilan_socio[,Recettes_TC_AMS := Emiss_Mt_AME*TC_AMS*10^-3]

#### Recettes taxes ener 

Taxes_ener_AME = data.table(read_excel("../publication_thema/hypothèses_prix/Prix_scenario_thema.xls", sheet = "taxes_ener_AME"))
Taxes_ener_AMS = data.table(read_excel("../publication_thema/hypothèses_prix/Prix_scenario_thema.xls", sheet = "taxes_ener_AMS"))
Taxes_ener_AME = melt(Taxes_ener_AME, id.vars = "annee",variable.name = "energie",value.name = "taxes_ener_AME")
Taxes_ener_AMS = melt(Taxes_ener_AMS, id.vars = "annee",variable.name = "energie",value.name = "taxes_ener_AMS")

taxes_ener = merge(Taxes_ener_AME, Taxes_ener_AMS, by=c("annee","energie"))
taxes_ener[,annee:=as.character(annee)]

bilan_socio = merge(bilan_socio,taxes_ener,by=c("annee","energie"))
bilan_socio[,Recettes_taxes_ener_AME :=conso_tWhEF*taxes_ener_AME*10^-3]
bilan_socio[,Recettes_taxes_ener_AMS :=conso_tWhEF*taxes_ener_AMS*10^-3]

#### subvention élec 
bilan_socio[,sub_elec := 0]

bilan_socio[scenario=="S3 AMS" & energie == "Electricité",sub_elec := conso_tWhEF*Taxe_elec*10^-3]



### aggreg sur toute les ener
bilan_socio = bilan_socio[,list(conso_tWhEF=sum(conso_tWhEF),
                                Depense_socio_AMS = sum(Depense_socio_AMS),
                                Depense_socio_AME = sum(Depense_socio_AME),
                                Depense_usager_AME = sum(Depense_usager_AME),
                                Depense_usager_AMS = sum(Depense_usager_AMS),
                                Emiss_Mt_AME = sum(Emiss_Mt_AME),
                                Emiss_Mt_AMS = sum(Emiss_Mt_AMS), 
                                Recettes_TC_AME = sum(Recettes_TC_AME),
                                Recettes_TC_AMS = sum(Recettes_TC_AMS),
                                Recettes_taxes_ener_AME = sum(Recettes_taxes_ener_AME),
                                Recettes_taxes_ener_AMS = sum(Recettes_taxes_ener_AMS), sub_elec = sum(sub_elec)), by=c("scenario","annee")]

### investissements chauffage 
INV_an_chauffage = COUTS[,list(INV_Md=sum(investissement)/10^9), by=c("scenario","annee")]
bilan_socio = merge(bilan_socio, INV_an_chauffage, by=c("scenario","annee"))

### aides
Aides = COUTS[,list(pretsBonifies_Md=sum(pretsBonifies)/10^9, CEE_Md = sum(aides)/10^9), by=c("scenario","annee")]
bilan_socio = merge(bilan_socio, Aides, by=c("scenario","annee"))

bilan_usager = bilan_socio

#### bilan socio 
#### actualisation
taux_actu_socio=0.045


bilan_socio[, coefactu := 1/(1+taux_actu_socio)^(as.numeric(as.character(annee))-2015)]
bilan_socio[, INV_Md_actu:= INV_Md*coefactu]
bilan_socio[, conso_tWhEF_actu:= conso_tWhEF*coefactu]
bilan_socio[, Emiss_Mt_AME_actu:= Emiss_Mt_AME*coefactu]
bilan_socio[, Emiss_Mt_AMS_actu:= Emiss_Mt_AMS*coefactu]

bilan_socio[,Depense_socio_AME_actu:= Depense_socio_AME*coefactu]
bilan_socio[,Depense_socio_AMS_actu:= Depense_socio_AMS*coefactu]

bilan_socio[,Recettes_taxes_ener_AME_actu := Recettes_taxes_ener_AME*coefactu]
bilan_socio[,Recettes_taxes_ener_AMS_actu := Recettes_taxes_ener_AMS*coefactu]
bilan_socio[,Recettes_TC_AME_actu := Recettes_TC_AME*coefactu]
bilan_socio[,Recettes_TC_AMS_actu := Recettes_TC_AMS*coefactu]

bilan_socio[,Subvention_elec_actu := sub_elec*coefactu]

#### ajout 10 ans à la fin
bilan_socio[annee=="2050", conso_tWhEF_actu:= conso_tWhEF*coefactu*10]
bilan_socio[annee=="2050", Emiss_Mt_AME_actu:= Emiss_Mt_AME*coefactu*10]
bilan_socio[annee=="2050",Depense_socio_AME_actu:= Depense_socio_AME*coefactu*10]
bilan_socio[annee=="2050", Emiss_Mt_AMS_actu:= Emiss_Mt_AMS*coefactu*10]
bilan_socio[annee=="2050",Depense_socio_AMS_actu:= Depense_socio_AMS*coefactu*10]



bilan_socio_cum = bilan_socio[,list(INV_Md_actu = sum(INV_Md_actu ), 
                                    INV_Md = sum(INV_Md),
                  conso_tWhEF_actu=sum(conso_tWhEF_actu), 
                  conso_tWhEF=sum(conso_tWhEF), 
                  Emiss_Mt_AME_actu=sum(Emiss_Mt_AME_actu), 
                  Emiss_Mt_AMS_actu=sum(Emiss_Mt_AMS_actu), 
                  
                  Emiss_Mt_AME=sum(Emiss_Mt_AME),
                  Emiss_Mt_AMS = sum(Emiss_Mt_AMS),
                  Depense_socio_AME_actu = sum(Depense_socio_AME_actu),
                  Depense_socio_AMS_actu = sum(Depense_socio_AMS_actu),
                  Depense_socio_AME=sum(Depense_socio_AME),
                   Depense_socio_AMS = sum( Depense_socio_AMS),
                  Recettes_TC_AME = sum(Recettes_TC_AME),
                  Recettes_TC_AMS = sum(Recettes_TC_AMS),
                  Recettes_taxes_ener_AME = sum(Recettes_taxes_ener_AME),
                  Recettes_taxes_ener_AMS = sum(Recettes_taxes_ener_AMS),
                  Recettes_TC_AME_actu  = sum(Recettes_TC_AME_actu ),
                  Recettes_TC_AMS_actu  = sum(Recettes_TC_AMS_actu ),
                  Recettes_taxes_ener_AME_actu  = sum(Recettes_taxes_ener_AME_actu ),
                  Recettes_taxes_ener_AMS_actu  = sum(Recettes_taxes_ener_AMS_actu ), 
                  sub_elec = sum(sub_elec), 
                  Subvention_elec_actu = sum(Subvention_elec_actu)
                  ) ,
                  by="scenario"]

bilan_socio_cum = melt(bilan_socio_cum, id.vars = "scenario")

bilan_socio_cum2 = dcast.data.table(bilan_socio_cum, scenario~variable)

#### tableau de resultats prés

table_results_socio = data.table(scenario = c("AME","AMS","AME prix AMS","AMS prix AME")) 

## facture
table_results_socio[scenario == "AME",Fact :=bilan_socio_cum2[scenario == "S2 AME",Depense_socio_AME_actu] ]
table_results_socio[scenario == "AMS",Fact :=bilan_socio_cum2[scenario == "S3 AMS",Depense_socio_AMS_actu] ]
table_results_socio[scenario == "AME prix AMS",Fact :=bilan_socio_cum2[scenario == "S2 AME",Depense_socio_AMS_actu] ]
table_results_socio[scenario == "AMS prix AME",Fact :=bilan_socio_cum2[scenario == "S3 AMS",Depense_socio_AME_actu] ]

## INV
table_results_socio[scenario == "AME",INV :=bilan_socio_cum2[scenario == "S2 AME", INV_Md_actu] ]
table_results_socio[scenario == "AMS",INV :=bilan_socio_cum2[scenario == "S3 AMS",INV_Md_actu] ]
table_results_socio[scenario == "AME prix AMS",INV :=bilan_socio_cum2[scenario == "S2 AME",INV_Md_actu] ]
table_results_socio[scenario == "AMS prix AME",INV :=bilan_socio_cum2[scenario == "S3 AMS",INV_Md_actu] ]

## EMissions
table_results_socio[scenario == "AME",Em :=bilan_socio_cum2[scenario == "S2 AME",Emiss_Mt_AME_actu] ]
table_results_socio[scenario == "AMS",Em :=bilan_socio_cum2[scenario == "S3 AMS",Emiss_Mt_AMS_actu] ]
table_results_socio[scenario == "AME prix AMS",Em :=bilan_socio_cum2[scenario == "S2 AME",Emiss_Mt_AMS_actu] ]
table_results_socio[scenario == "AMS prix AME",Em :=bilan_socio_cum2[scenario == "S3 AMS",Emiss_Mt_AME_actu] ]

table_results_socio[,CoutTot := Fact + INV]

## coût tonnee
table_results_socio[,CoutTonne :=(CoutTot - table_results_socio[scenario == "AME",CoutTot])/-(Em - table_results_socio[scenario == "AME",Em])*10^3, by="scenario"]

table_results_socio[scenario == "AMS",Em :=bilan_socio_cum2[scenario == "S3 AMS",Emiss_Mt_AMS_actu] ]
table_results_socio[scenario == "AME prix AMS",Em :=bilan_socio_cum2[scenario == "S2 AME",Emiss_Mt_AMS_actu] ]
table_results_socio[scenario == "AMS prix AME",Em :=bilan_socio_cum2[scenario == "S3 AMS",Emiss_Mt_AME_actu] ]

#### recettes taxes
table_results_socio[scenario == "AME",TC :=bilan_socio_cum2[scenario == "S2 AME",Recettes_TC_AME_actu] ]
table_results_socio[scenario == "AMS",TC :=bilan_socio_cum2[scenario == "S3 AMS",Recettes_TC_AMS_actu] ]
table_results_socio[scenario == "AME prix AMS",TC :=bilan_socio_cum2[scenario == "S2 AME",Recettes_TC_AME_actu] ]
table_results_socio[scenario == "AMS prix AME",TC :=bilan_socio_cum2[scenario == "S3 AMS",Recettes_TC_AMS_actu] ]

table_results_socio[scenario == "AME",Taxes_ener :=bilan_socio_cum2[scenario == "S2 AME",Recettes_taxes_ener_AME_actu] ]
table_results_socio[scenario == "AMS",Taxes_ener :=bilan_socio_cum2[scenario == "S3 AMS",Recettes_taxes_ener_AMS_actu] ]
table_results_socio[scenario == "AME prix AMS",Taxes_ener :=bilan_socio_cum2[scenario == "S2 AME",Recettes_taxes_ener_AME_actu] ]
table_results_socio[scenario == "AMS prix AME",Taxes_ener :=bilan_socio_cum2[scenario == "S3 AMS",Recettes_taxes_ener_AMS_actu] ]

table_results_socio[scenario == "AMS",sub_elec :=bilan_socio_cum2[scenario == "S3 AMS",Subvention_elec_actu] ]
table_results_socio[scenario == "AME",sub_elec :=bilan_socio_cum2[scenario == "S2 AME",Subvention_elec_actu] ]


table_results_socio[,COFP := 0.25*(sub_elec-TC-Taxes_ener)]

### bilan en différence

bilan_socio_cum = dcast.data.table(bilan_socio_cum, variable~scenario)


bilan_socio_cum[, Diff_AMS_AME := get("S3 AMS")-get("S2 AME")]
bilan_socio_cum[, Diff_AME_nopol := get("S2 AME")-get("S1 Prix")]

bilan_socio_AMS_AME = melt(bilan_socio_cum, id.vars = "variable", measure.vars ="Diff_AMS_AME", variable.name = "Diff")

bilan_socio_AMS_AME = dcast.data.table(bilan_socio_AMS_AME, Diff~variable)
bilan_socio_AMS_AME[,cout_socio_tonne := (INV_Md_actu+Depense_socio_AMS_actu)/-Emiss_Mt_AMS_actu*10^3]
bilan_socio_AMS_AME[,cout_socio_Kwh := (INV_Md_actu+Depense_socio_AMS_actu)/-conso_tWhEF_actu*10^3]

bilan_socio_AME_Nopol = melt(bilan_socio_cum, id.vars = "variable", measure.vars ="Diff_AME_nopol", variable.name = "Diff")

bilan_socio_AME_Nopol = dcast.data.table(bilan_socio_AME_Nopol, Diff~variable)
bilan_socio_AME_Nopol[,cout_socio_tonne := (INV_Md_actu+Depense_socio_AME_actu)/-Emiss_Mt_AME_actu*10^3]
bilan_socio_AME_Nopol[,cout_socio_Kwh := (INV_Md_actu+Depense_socio_AME_actu)/-conso_tWhEF_actu*10^3]

bilan_socio_results = rbind(bilan_socio_AME_Nopol, bilan_socio_AMS_AME)
bilan_socio_results

##### bilan usagers 

#### actualisation
taux_actu_usager=0.07

bilan_usager[, coefactu := 1/(1+taux_actu_usager)^(as.numeric(as.character(annee))-2015)]
bilan_usager[, INV_Md_actu:= INV_Md*coefactu]
bilan_usager[, conso_tWhEF_actu:= conso_tWhEF*coefactu]
bilan_usager[, Emiss_Mt_AME_actu:= Emiss_Mt_AME*coefactu]
bilan_usager[,Depense_usager_AME_actu:= Depense_usager_AME*coefactu]
bilan_usager[, Emiss_Mt_AMS_actu:= Emiss_Mt_AMS*coefactu]
bilan_usager[,Depense_usager_AMS_actu:= Depense_usager_AMS*coefactu]
bilan_usager[,pretsBonifies_Md_actu:= pretsBonifies_Md*coefactu]
bilan_usager[,CEE_Md_actu:= CEE_Md*coefactu]

#### ajout 10 ans à la fin
bilan_usager[annee=="2050", conso_tWhEF_actu:= conso_tWhEF*coefactu*10]
bilan_usager[annee=="2050", Emiss_Mt_AME_actu:= Emiss_Mt_AME*coefactu*10]
bilan_usager[annee=="2050",Depense_usager_AME_actu:= Depense_usager_AME*coefactu*10]
bilan_usager[annee=="2050", Emiss_Mt_AMS_actu:= Emiss_Mt_AMS*coefactu*10]
bilan_usager[annee=="2050",Depense_usager_AMS_actu:= Depense_usager_AMS*coefactu*10]



bilan_usager_cum = bilan_usager[,list(INV_Md_actu = sum(INV_Md_actu ), INV_Md = sum(INV_Md),
                  conso_tWhEF_actu=sum(conso_tWhEF_actu), conso_tWhEF=sum(conso_tWhEF), 
                  Emiss_Mt_AME_actu=sum(Emiss_Mt_AME_actu), Emiss_Mt_AME=sum(Emiss_Mt_AME),
                  Depense_usager_AME_actu = sum(Depense_usager_AME_actu),Depense_usager_AME=sum(Depense_usager_AME),
                  Emiss_Mt_AMS_actu=sum(Emiss_Mt_AMS_actu), Emiss_Mt_AMS=sum(Emiss_Mt_AMS),
                  Depense_usager_AMS_actu = sum(Depense_usager_AMS_actu),Depense_usager_AMS=sum(Depense_usager_AMS),
                  pretsBonifies_Md_actu = sum(pretsBonifies_Md_actu), pretsBonifies_Md=sum(pretsBonifies_Md),
                  CEE_Md_actu = sum(CEE_Md_actu), CEE_Md = sum(CEE_Md)
                  ) ,
                  by="scenario"]

bilan_usager_cum = melt(bilan_usager_cum, id.vars = "scenario")

bilan_usager_cum2 = dcast.data.table(bilan_usager_cum, scenario~variable)

#### tableau de resultats prés

table_results_usager = data.table(scenario = c("AME","AMS","AME prix AMS","AMS prix AME")) 

## facture
table_results_usager[scenario == "AME",Fact :=bilan_usager_cum2[scenario == "S2 AME",Depense_usager_AME_actu] ]
table_results_usager[scenario == "AMS",Fact :=bilan_usager_cum2[scenario == "S3 AMS",Depense_usager_AMS_actu] ]
table_results_usager[scenario == "AME prix AMS",Fact :=bilan_usager_cum2[scenario == "S2 AME",Depense_usager_AMS_actu] ]
table_results_usager[scenario == "AMS prix AME",Fact :=bilan_usager_cum2[scenario == "S3 AMS",Depense_usager_AME_actu] ]

## INV
table_results_usager[scenario == "AME",INV :=bilan_usager_cum2[scenario == "S2 AME", INV_Md_actu] ]
table_results_usager[scenario == "AMS",INV :=bilan_usager_cum2[scenario == "S3 AMS",INV_Md_actu] ]
table_results_usager[scenario == "AME prix AMS",INV :=bilan_usager_cum2[scenario == "S2 AME",INV_Md_actu] ]
table_results_usager[scenario == "AMS prix AME",INV :=bilan_usager_cum2[scenario == "S3 AMS",INV_Md_actu] ]

## EMissions
table_results_usager[scenario == "AME",Em :=bilan_usager_cum2[scenario == "S2 AME",Emiss_Mt_AME_actu] ]
table_results_usager[scenario == "AMS",Em :=bilan_usager_cum2[scenario == "S3 AMS",Emiss_Mt_AMS_actu] ]
table_results_usager[scenario == "AME prix AMS",Em :=bilan_usager_cum2[scenario == "S2 AME",Emiss_Mt_AMS_actu] ]
table_results_usager[scenario == "AMS prix AME",Em :=bilan_usager_cum2[scenario == "S3 AMS",Emiss_Mt_AME_actu] ]

table_results_usager[,CoutTot := Fact + INV]

#### bilan usager en différence
# bilan_usager_cum = dcast.data.table(bilan_usager_cum, variable~scenario)
# bilan_usager_cum[, Diff_AMS_AME := get("S3 AMS")-get("S2 AME")]
# 
# bilan_usager_AMS_AME = melt(bilan_usager_cum, id.vars = "variable", measure.vars ="Diff_AMS_AME", variable.name = "Diff")
# 
# bilan_usager_AMS_AME = dcast.data.table(bilan_usager_AMS_AME, Diff~variable)
# bilan_usager_AMS_AME[,cout_usager := INV_Md_actu+Depense_usager_AMS_actu]
# bilan_usager_AMS_AME[,cout_usager2 := INV_Md_actu+Depense_usager_AMS_actu-CEE_Md_actu-pretsBonifies_Md_actu ]

table_results_socio
table_results_usager

graph_taxes = bilan_socio[scenario %in% c("S2 AME","S3 AMS")]
graph_taxes[scenario %in% c("S2 AME") ,TC := Recettes_TC_AME]
graph_taxes[scenario %in% c("S3 AMS") ,TC := Recettes_TC_AMS]

graph_taxes[scenario %in% c("S2 AME") ,Taxe_ener_graph := Recettes_taxes_ener_AME]
graph_taxes[scenario %in% c("S3 AMS") ,Taxe_ener_graph :=  Recettes_taxes_ener_AMS]


```

```{r, echo=F, warning=F,}
pander(table_results_socio,digits = 2, caption = "Bilan socio eco")
```
```{r, echo=F, warning=F,}
pander(table_results_usager,digits = 2, caption = "Bilan pour l'usager")
```

```{r Evol_Recettes_taxes, fig.width=25, fig.height=10, echo=F, warning=F,fig.cap='Evolution des émissions pour tous les usages par énergie', dev=c('png', 'pdf')}
ggplot() + geom_line(data = graph_taxes, aes(annee,TC, group = scenario, color= scenario)) + mytheme_facet_plot
ggplot() + geom_line(data = graph_taxes, aes(annee,Taxe_ener_graph, group = scenario, color= scenario)) + mytheme_facet_plot
```



